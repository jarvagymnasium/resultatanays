<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>J√§rva Gymnasium - Resultatanalys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* üé® J√§rva Gymnasium F√§rgprofil */
            --primary-color: #624c9a;
            --primary-darker: #4a3a7a;
            --primary-lighter: #7d68b4;
            --accent-orange: #f5a831;
            --accent-orange-dark: #ef772c;
            --accent-pink: #e72c81;
            --accent-blue: #43bde3;
            --light-bg: #FFFFFF;
            --dark-bg: #1a1a2e;
            --light-text: #333333;
            --dark-text: #E0E0E0;
            --warning-color: #ef772c;
            --success-color: #43bde3;
            --header-height: 180px;
            --header-height-mobile: 220px;
        }

        .dark {
            --bg-color: var(--dark-bg);
            --text-color: var(--dark-text);
        }

        :root:not(.dark) {
            --bg-color: var(--light-bg);
            --text-color: var(--light-text);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-darker) 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(98, 76, 154, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(98, 76, 154, 0.4);
            background: linear-gradient(135deg, var(--primary-lighter) 0%, var(--primary-color) 100%);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }

        .dark .card {
            background-color: #242424;
            border-color: #333;
        }

        .card {
            background-color: white;
            border-color: #eaeaea;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }
        
        .card:hover {
            box-shadow: 0 8px 24px rgba(98, 76, 154, 0.15);
            transform: translateY(-2px);
        }

        .tab-active {
            border-bottom: 3px solid var(--accent-orange);
            color: white;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
        }
        
        .archive-tab-active {
            border-bottom-color: var(--accent-orange) !important;
            color: var(--accent-orange);
            font-weight: 600;
        }

        .dark .input, .dark .select {
            background-color: #333;
            border-color: #444;
            color: #eee;
        }

        .input, .select {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }

        .grade-pill {
            transition: all 0.2s;
        }

        .grade-pill:hover {
            transform: translateY(-2px);
        }

        .grade-pill-selected {
            transform: translateY(-2px);
            font-weight: bold;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .dark .spinner {
            border-color: rgba(255, 255, 255, 0.2);
            border-left-color: var(--primary-color);
        }

        .warning-badge {
            background: linear-gradient(135deg, var(--accent-orange-dark) 0%, var(--accent-pink) 100%);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(239, 119, 44, 0.3);
        }
        
        /* Accent Button Colors */
        .btn-accent-orange {
            background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-orange-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 168, 49, 0.3);
        }
        
        .btn-accent-orange:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(245, 168, 49, 0.4);
        }
        
        .btn-accent-blue {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #2da5c7 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(67, 189, 227, 0.3);
        }
        
        .btn-accent-blue:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(67, 189, 227, 0.4);
        }
        
        .btn-accent-pink {
            background: linear-gradient(135deg, var(--accent-pink) 0%, #c71f67 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(231, 44, 129, 0.3);
        }
        
        .btn-accent-pink:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(231, 44, 129, 0.4);
        }

        .grade-f {
            color: var(--warning-color);
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Modern Header Styles - J√§rva Gymnasium Gradient */
        .modern-header {
            background: linear-gradient(135deg, #624c9a 0%, #4a3a7a 50%, #e72c81 100%);
            min-height: var(--header-height);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(98, 76, 154, 0.3);
        }
        
        .modern-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 0%, rgba(67, 189, 227, 0.1) 50%, transparent 100%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .header-bg-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            background-color: white;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-icon i {
            color: var(--primary-color);
            font-size: 1.75rem;
        }
        
        .app-title {
            display: flex;
            flex-direction: column;
        }
        
        .school-name {
            font-weight: 800;
            font-size: 1.75rem;
            line-height: 1.2;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .app-name {
            font-size: 1rem;
            opacity: 0.95;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .text-shadow {
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .nav-container {
            position: relative;
            z-index: 10;
        }
        
        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
            color: rgba(255, 255, 255, 0.75);
            border-radius: 8px 8px 0 0;
        }
        
        .tab-button:hover {
            color: white;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .tab-button i {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        
        .tab-button:hover i {
            transform: scale(1.1);
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }
        
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .content-wrap {
            margin-top: -20px;
            position: relative;
            z-index: 20;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            background-color: var(--bg-color);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            min-height: calc(100vh - var(--header-height) + 20px);
            transition: background-color 0.3s;
        }
        
        /* New styles for F-warnings */
        .f-count-3plus {
            background-color: rgba(239, 68, 68, 0.15);
        }
        
        .dark .f-count-3plus {
            background-color: rgba(239, 68, 68, 0.25);
        }
        
        .f-count-2 {
            background-color: rgba(245, 158, 11, 0.15);
        }
        
        .dark .f-count-2 {
            background-color: rgba(245, 158, 11, 0.25);
        }
        
        .f-count-1 {
            background-color: rgba(16, 185, 129, 0.15);
        }
        
        .dark .f-count-1 {
            background-color: rgba(16, 185, 129, 0.25);
        }
        
        .student-name {
            cursor: pointer;
            color: var(--primary-color);
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        
        .student-name:hover {
            color: var(--primary-darker);
            text-decoration-style: solid;
        }
        
        /* Popup/Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-content {
            background-color: var(--bg-color);
            border-radius: 8px;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        /* Class filter checkboxes styling */
        .class-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .class-checkbox {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dark .class-checkbox {
            background-color: #374151;
        }

        .class-checkbox:hover {
            background-color: #e5e7eb;
        }

        .dark .class-checkbox:hover {
            background-color: #4b5563;
        }

        .class-checkbox input {
            margin-right: 0.25rem;
        }
        
        /* Role Badge */
        .role-badge {
            display: inline-flex;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .role-badge-admin {
            background-color: #818cf8;
            color: white;
        }
        
        .role-badge-teacher {
            background-color: #34d399;
            color: white;
        }
        
        .role-badge-analyst {
            background-color: #60a5fa;
            color: white;
        }
        
        /* Disabled button */
        .btn-disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }
        
        /* Progress styling */
        .progress-pill {
            display: inline-flex;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .progress-positive {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .dark .progress-positive {
            background-color: rgba(16, 185, 129, 0.3);
            color: #34d399;
        }

        .progress-flat {
            background-color: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        .dark .progress-flat {
            background-color: rgba(107, 114, 128, 0.3);
            color: #9ca3af;
        }

        .progress-negative {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .dark .progress-negative {
            background-color: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        /* Quarter selector styling */
        .quarter-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .quarter-chip:hover {
            background-color: #e5e7eb;
        }
        
        .quarter-chip.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .dark .quarter-chip {
            background-color: #374151;
            border-color: #4b5563;
        }
        
        .dark .quarter-chip:hover {
            background-color: #4b5563;
        }
        
        /* Notification system styles */
        .notification {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin-bottom: 0.5rem;
            transform: translateX(100%);
            animation: slideInNotification 0.3s ease-out forwards;
            position: relative;
            max-width: 400px;
        }
        
        .notification.notification-success {
            background-color: #10b981;
            color: white;
        }
        
        .notification.notification-error {
            background-color: #ef4444;
            color: white;
        }
        
        .notification.notification-warning {
            background-color: #f59e0b;
            color: white;
        }
        
        .notification.notification-info {
            background-color: #3b82f6;
            color: white;
        }
        
        .notification-icon {
            margin-right: 0.75rem;
            flex-shrink: 0;
            font-size: 1.25rem;
        }
        
        .notification-content {
            flex-grow: 1;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.75rem;
            flex-shrink: 0;
            opacity: 0.8;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        .notification.fade-out {
            animation: slideOutNotification 0.3s ease-in forwards;
        }
        
        @keyframes slideInNotification {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutNotification {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .progress-arrow {
            display: inline-flex;
            margin: 0 0.5rem;
            color: #10b981;
            font-size: 1rem;
        }
        
        .progress-arrow.negative {
            color: #ef4444;
        }
        
        @media (max-width: 768px) {
            .modern-header {
                min-height: var(--header-height-mobile);
            }
            
            .content-wrap {
                min-height: calc(100vh - var(--header-height-mobile) + 20px);
            }
            
            .nav-container {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            .tab-button {
                padding: 0.5rem 0.75rem;
                flex-direction: column;
                gap: 0.25rem;
                font-size: 0.75rem;
                min-height: 44px; /* Touch-friendly minimum */
            }
            
            .tab-button i {
                font-size: 1.1rem;
            }
            
            /* Mobile header adjustments */
            .app-title .flex {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            #active-quarter-indicator {
                margin-top: 0.25rem;
            }
            
            /* Improved mobile buttons */
            .btn-primary, .btn {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 0.875rem;
            }
            
            /* Better mobile tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile-friendly notifications */
            .notification {
                max-width: calc(100vw - 2rem);
                margin-left: 1rem;
                margin-right: 1rem;
            }
            
            /* Improved mobile forms */
            .form-input, .select {
                min-height: 44px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            /* Mobile chart containers */
            .chart-container {
                height: 250px; /* Shorter on mobile */
            }
            
            /* Swipe indicator for tabs */
            .nav-container::after {
                content: "‚Üê Svep f√∂r fler flikar ‚Üí";
                position: absolute;
                bottom: -20px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.75rem;
                color: #6b7280;
                text-align: center;
            }
        }
        
        /* Touch gestures */
        .swipe-area {
            touch-action: pan-x;
        }
        
        /* Form validation styles */
        .form-field {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .form-field.has-error .input,
        .form-field.has-error .select {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .form-field.has-success .input,
        .form-field.has-success .select {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .field-error {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #ef4444;
        }
        
        .field-error i {
            margin-right: 0.5rem;
            font-size: 0.75rem;
        }
        
        .field-success {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #10b981;
        }
        
        .field-success i {
            margin-right: 0.5rem;
            font-size: 0.75rem;
        }
        
        .input-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }
        
        .form-field.has-error .input-icon {
            color: #ef4444;
        }
        
        .form-field.has-success .input-icon {
            color: #10b981;
        }

        /* Progress indicators */
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #10b981);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }
        
        .loading-step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.75rem;
        }
        
        .loading-step.completed .loading-step-icon {
            background-color: #10b981;
            color: white;
        }
        
        .loading-step.active .loading-step-icon {
            background-color: var(--primary-color);
            color: white;
        }
        
        .loading-step.pending .loading-step-icon {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        
        .dark .loading-step.pending .loading-step-icon {
            background-color: #374151;
            color: #9ca3af;
        }
        
        .loading-step-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* F-Warning specific styles */
        .grade-warning-pill {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
            font-weight: 600;
            border: 2px solid #ea580c;
            position: relative;
        }
        
        .grade-warning-pill::before {
            content: '‚ö†Ô∏è';
            margin-right: 0.25rem;
        }
        
        .grade-warning-pill:hover {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .grade-warning-pill-selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        /* Toggle buttons for grade type filter */
        .grade-type-toggle {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #f3f4f6;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }
        
        .grade-type-toggle:hover {
            background-color: #e5e7eb;
        }
        
        .grade-type-toggle.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .dark .grade-type-toggle {
            background-color: #374151;
            border-color: #4b5563;
        }
        
        .dark .grade-type-toggle:hover {
            background-color: #4b5563;
        }
        
        .dark .grade-type-toggle.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .warning-badge-orange {
            background-color: #f59e0b;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="flex-grow flex flex-col">
        <!-- Login screen -->
        <div id="login-screen" class="flex min-h-screen">
            <div class="m-auto w-full max-w-md p-6 card rounded-lg shadow-lg slide-in">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold mb-1">J√§rva Gymnasium</h1>
                    <h2 class="text-xl">Resultatanalys</h2>
                </div>
                
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block mb-1 font-medium">E-post</label>
                        <input type="email" id="email" class="input w-full px-4 py-2 rounded-md text-base" placeholder="exempel@skola.se" required>
                    </div>
                    
                    <div>
                        <label for="password" class="block mb-1 font-medium">L√∂senord</label>
                        <input type="password" id="password" class="input w-full px-4 py-2 rounded-md text-base" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    
                    <div id="login-error" class="text-red-500 text-sm hidden"></div>
                    
                    <div class="flex items-center justify-between pt-2">
                        <button type="submit" class="btn-primary px-6 py-2 rounded-md w-full font-medium">
                            <span id="login-button-text">Logga in</span>
                            <span id="login-spinner" class="spinner hidden"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Dashboard (hidden initially) -->
        <div id="dashboard" class="hidden flex-grow flex flex-col">
       <!-- Modern Header -->
            <header class="modern-header">
                <div class="header-bg-pattern"></div>
                <div class="container mx-auto px-4 py-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="logo-container">
                            <div class="logo-icon">
                                <img src="https://jarvagymnasium.se/jarva-gymnasium.png" alt="J√§rva Gymnasium Logo" />
                            </div>
                            <div class="app-title">
                                <span class="school-name text-white text-shadow">J√§rva Gymnasium</span>
                                <div class="flex items-center space-x-3">
                                    <span class="app-name text-white text-opacity-90">Resultatanalys</span>
                                    <div id="active-quarter-indicator" class="flex items-center">
                                        <span class="text-xs text-white text-opacity-60 mr-1">Aktivt:</span>
                                        <span id="active-quarter-name" class="text-xs bg-white bg-opacity-15 text-white px-2 py-1 rounded-md">
                                            Laddar...
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="user-section mt-4 sm:mt-0">
                            <div class="hidden sm:flex items-center gap-2">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div class="text-white text-sm font-medium" id="user-email">user@example.com</div>
                                    <div class="flex items-center gap-1">
                                        <span class="text-white text-xs opacity-70" id="user-position">L√§rare</span>
                                        <span id="role-badge" class="role-badge role-badge-teacher">L√§rare</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Wrapped logout button in a separate div with its own styling -->
                            <div class="mt-2 sm:mt-0 sm:ml-4" style="position: relative; z-index: 100;">
                                <a href="#" id="logout-btn" class="logout-btn text-white bg-white bg-opacity-15 rounded-md px-3 py-2 flex items-center gap-2 hover:bg-opacity-30 transition-all" style="cursor: pointer; display: inline-flex;">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logga ut</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-container mt-6">
                        <nav class="flex space-x-1 sm:space-x-4 overflow-x-auto">
                            <button data-tab="warnings-tab" class="tab-button tab-active">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>F-varning</span>
                            </button>
                            <button data-tab="progress-tab" class="tab-button">
                                <i class="fas fa-chart-line"></i>
                                <span>Utveckling</span>
                            </button>
                            <button data-tab="classes-tab" class="tab-button">
                                <i class="fas fa-users"></i>
                                <span>Klasser</span>
                            </button>
                            <button data-tab="courses-tab" class="tab-button">
                                <i class="fas fa-book"></i>
                                <span>Kurser</span>
                            </button>
                            <button data-tab="students-tab" class="tab-button">
                                <i class="fas fa-user-graduate"></i>
                                <span>Elever</span>
                            </button>
                            <button data-tab="grades-tab" class="tab-button">
                                <i class="fas fa-chart-bar"></i>
                                <span>Betygs√§ttning</span>
                            </button>
                            <button data-tab="quarters-tab" class="tab-button">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Kvartal</span>
                            </button>
                            <button data-tab="archive-tab" class="tab-button">
                                <i class="fas fa-archive"></i>
                                <span>Arkiv</span>
                            </button>
                        </nav>
                    </div>
                </div>
            </header>

            <!-- Main Content with Curved Top -->
            <div class="content-wrap">
                <main class="container mx-auto px-4 py-6">



                    
                    <!-- Loading spinner -->
                    <div id="loading" class="hidden flex-col items-center justify-center py-12">
                        <div class="spinner"></div>
                        <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">Laddar...</p>
                    </div>

                    <!-- Detailed Loading Progress -->
                    <div id="detailed-loading" class="hidden card rounded-lg shadow p-6 mb-6 max-w-md mx-auto">
                        <h3 class="text-lg font-semibold mb-4 text-center">Laddar data...</h3>
                        
                        <!-- Progress Bar -->
                        <div class="progress-bar mb-4">
                            <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        
                        <!-- Loading Steps -->
                        <div id="loading-steps">
                            <div class="loading-step pending" data-step="roles">
                                <div class="loading-step-icon">1</div>
                                <span>Laddar anv√§ndarroller...</span>
                            </div>
                            <div class="loading-step pending" data-step="quarters">
                                <div class="loading-step-icon">2</div>
                                <span>Laddar kvartal...</span>
                            </div>
                            <div class="loading-step pending" data-step="classes">
                                <div class="loading-step-icon">3</div>
                                <span>Laddar klasser...</span>
                            </div>
                            <div class="loading-step pending" data-step="courses">
                                <div class="loading-step-icon">4</div>
                                <span>Laddar kurser...</span>
                            </div>
                            <div class="loading-step pending" data-step="students">
                                <div class="loading-step-icon">5</div>
                                <span>Laddar elever...</span>
                            </div>
                            <div class="loading-step pending" data-step="grades">
                                <div class="loading-step-icon">6</div>
                                <span>Laddar betyg...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Error message -->
                    <div id="error-container" class="hidden">
                        <div class="bg-red-100 dark:bg-red-900 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-4 mb-6 rounded">
                            <p id="error-message">Ett fel har intr√§ffat.</p>
                        </div>
                    </div>

                    <!-- Notification Container -->
                    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-md">
                        <!-- Notifications will be inserted here -->
                    </div>
                    
                    <!-- F-warnings & Analys Tab -->
                    <div id="warnings-tab" class="tab-content fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                            <h2 class="text-xl font-bold mb-2 sm:mb-0">F-varningar & Resultatanalys</h2>
                            <div class="flex space-x-2">
                                <div class="relative">
                                    <button id="export-warnings-btn" class="btn-primary px-3 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-download mr-2"></i> Exportera rapport
                                        <i class="fas fa-chevron-down ml-1"></i>
                                    </button>
                                    <div id="export-warnings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 border border-gray-200 dark:border-gray-700">
                                        <button onclick="exportWarningsToExcel()" class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                            <i class="fas fa-file-excel text-green-600 mr-2"></i> Excel (.xlsx)
                                        </button>
                                        <button onclick="exportWarningsToPDF()" class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                            <i class="fas fa-file-pdf text-red-600 mr-2"></i> PDF
                                        </button>
                                        <button onclick="exportChartsToImage()" class="w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                            <i class="fas fa-image text-blue-600 mr-2"></i> Grafer (PNG)
                                        </button>
                                    </div>
                                </div>
                                <button id="refresh-warnings-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1.5 rounded-md text-sm flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i> Uppdatera
                                </button>
                            </div>
                        </div>
                        
                        <!-- Grade Type Toggle -->
                        <div class="mb-6 card p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-semibold flex items-center">
                                    <i class="fas fa-filter mr-2 text-gray-400"></i> Visa typ
                                </h3>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button id="toggle-grade-type-grades" class="grade-type-toggle active" data-type="grades">
                                    <i class="fas fa-clipboard-check mr-2"></i> F-betyg
                                </button>
                                <button id="toggle-grade-type-warnings" class="grade-type-toggle" data-type="warnings">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> F-varningar
                                </button>
                                <button id="toggle-grade-type-both" class="grade-type-toggle" data-type="both">
                                    <i class="fas fa-layer-group mr-2"></i> B√•da
                                </button>
                            </div>
                            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                                <p><strong>F-betyg:</strong> Existerande F-betyg som redan √§r registrerade</p>
                                <p><strong>F-varningar:</strong> Elever som riskerar att f√• F i framtiden (tidig identifiering)</p>
                            </div>
                        </div>
                        
                        <!-- Summary Cards -->
                        <!-- Enhanced Dashboard Widgets -->
                        <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mb-6">
                            <div class="card rounded-lg shadow p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                            <i class="fas fa-exclamation-circle mr-2 text-red-500"></i> Totalt antal F
                                        </h3>
                                        <p id="total-f-count" class="text-2xl font-bold mt-1">0</p>
                                        <p id="f-warnings-trend" class="text-xs text-gray-500 mt-1">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg shadow p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                            <i class="fas fa-user-times mr-2 text-red-500"></i> Elever med F
                                        </h3>
                                        <p id="students-with-f" class="text-2xl font-bold mt-1">0</p>
                                        <p id="students-trend" class="text-xs text-gray-500 mt-1">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user-times text-orange-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg shadow p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                            <i class="fas fa-book mr-2 text-red-500"></i> S√§msta kurs
                                        </h3>
                                        <p id="worst-course" class="text-lg font-medium mt-1">-</p>
                                        <p id="worst-course-count" class="text-xs text-gray-500 mt-1">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-book text-purple-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg shadow p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                            <i class="fas fa-users mr-2 text-red-500"></i> S√§msta klass
                                        </h3>
                                        <p id="worst-class" class="text-lg font-medium mt-1">-</p>
                                        <p id="worst-class-count" class="text-xs text-gray-500 mt-1">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-users text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats Row -->
                        <div class="grid gap-4 grid-cols-2 lg:grid-cols-4 mb-6">
                            <div class="card rounded-lg shadow p-3 hover:shadow-md transition-shadow">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-check text-green-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Godk√§nt %</p>
                                        <p id="pass-rate" class="text-lg font-semibold">-</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg shadow p-3 hover:shadow-md transition-shadow">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-chalkboard-teacher text-indigo-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Klasser</p>
                                        <p id="total-classes" class="text-lg font-semibold">-</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg shadow p-3 hover:shadow-md transition-shadow">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-teal-100 dark:bg-teal-900 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-graduation-cap text-teal-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Kurser</p>
                                        <p id="total-courses" class="text-lg font-semibold">-</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg shadow p-3 hover:shadow-md transition-shadow">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-chart-line text-yellow-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Snitt betyg</p>
                                        <p id="average-grade" class="text-lg font-semibold">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div class="mb-6 card p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold flex items-center">
                                    <i class="fas fa-filter mr-2 text-gray-400"></i> Avancerade filter
                                </h3>
                                <button id="toggle-advanced-filters" class="text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-cog mr-1"></i> Fler alternativ
                                </button>
                            </div>
                            
                            <!-- Basic Filters -->
                            <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mb-4">
                                <div>
                                    <label for="warning-class-filter" class="block mb-1 text-sm font-medium">Klass</label>
                                    <select id="warning-class-filter" class="select w-full px-3 py-2 rounded-md text-base">
                                        <option value="">Alla klasser</option>
                                        <!-- Classes will be populated here -->
                                    </select>
                                </div>
                                <div>
                                    <label for="warning-course-filter" class="block mb-1 text-sm font-medium">Kurs</label>
                                    <select id="warning-course-filter" class="select w-full px-3 py-2 rounded-md text-base">
                                        <option value="">Alla kurser</option>
                                        <!-- Courses will be populated here -->
                                    </select>
                                </div>
                                <div>
                                    <label for="student-search" class="block mb-1 text-sm font-medium">S√∂k elev</label>
                                    <input type="text" id="student-search" placeholder="Elevnamn..." class="input w-full px-3 py-2 rounded-md text-base">
                                </div>
                                <div class="flex items-end">
                                    <button id="apply-filters-btn" class="btn-primary px-4 py-2 rounded-md text-sm w-full flex items-center justify-center">
                                        <i class="fas fa-search mr-2"></i> S√∂k
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters (Hidden by default) -->
                            <div id="advanced-filters" class="hidden border-t pt-4">
                                <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                                    <div>
                                        <label for="grade-filter" class="block mb-1 text-sm font-medium">Betyg</label>
                                        <select id="grade-filter" class="select w-full px-3 py-2 rounded-md text-base">
                                            <option value="">Alla betyg</option>
                                            <option value="F">F</option>
                                            <option value="E">E</option>
                                            <option value="D">D</option>
                                            <option value="C">C</option>
                                            <option value="B">B</option>
                                            <option value="A">A</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="quarter-filter" class="block mb-1 text-sm font-medium">Kvartal</label>
                                        <select id="quarter-filter" class="select w-full px-3 py-2 rounded-md text-base">
                                            <option value="">Alla kvartal</option>
                                            <!-- Quarters will be populated here -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="sort-by" class="block mb-1 text-sm font-medium">Sortera efter</label>
                                        <select id="sort-by" class="select w-full px-3 py-2 rounded-md text-base">
                                            <option value="student">Elevnamn</option>
                                            <option value="class">Klass</option>
                                            <option value="course">Kurs</option>
                                            <option value="grade">Betyg</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex space-x-2 mt-4">
                                    <button id="reset-filters-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md text-sm flex items-center">
                                        <i class="fas fa-undo mr-2"></i> √Öterst√§ll
                                    </button>
                                    <button id="save-filter-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm flex items-center">
                                        <i class="fas fa-bookmark mr-2"></i> Spara filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="grid gap-6 grid-cols-1 lg:grid-cols-2 mb-6">
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fas fa-chart-bar mr-2 text-gray-400"></i> F per klass
                                </h3>
                                <div class="chart-container">
                                    <canvas id="class-chart"></canvas>
                                </div>
                            </div>
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fas fa-chart-pie mr-2 text-gray-400"></i> F per kurs
                                </h3>
                                <div class="chart-container">
                                    <canvas id="course-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- F Warning Table -->
                        <div class="card rounded-lg shadow p-4">
                            <h3 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i> Elever med F-varningar
                            </h3>
                            
                            <!-- Advanced Student Filtering -->
                            <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                                    <!-- Status Filter -->
                                    <div>
                                        <label class="block text-sm font-medium mb-2">
                                            <i class="fas fa-traffic-light mr-1"></i> Riskniv√•
                                        </label>
                                        <div class="space-y-2">
                                            <label class="flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                                                <input type="checkbox" id="filter-critical" class="student-status-filter mr-2" value="critical" checked>
                                                <span class="flex items-center gap-2">
                                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                                    <span class="text-sm">Kritisk (3+ F)</span>
                                                </span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                                                <input type="checkbox" id="filter-warning" class="student-status-filter mr-2" value="warning" checked>
                                                <span class="flex items-center gap-2">
                                                    <span class="w-3 h-3 bg-amber-500 rounded-full"></span>
                                                    <span class="text-sm">Varning (2 F)</span>
                                                </span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                                                <input type="checkbox" id="filter-action" class="student-status-filter mr-2" value="action" checked>
                                                <span class="flex items-center gap-2">
                                                    <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
                                                    <span class="text-sm">√Ötg√§rd (1 F)</span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Type Filter -->
                                    <div>
                                        <label class="block text-sm font-medium mb-2">
                                            <i class="fas fa-filter mr-1"></i> Visa elever med
                                        </label>
                                        <div class="space-y-2">
                                            <label class="flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                                                <input type="checkbox" id="filter-has-fgrade" class="student-type-filter mr-2" value="fgrade" checked>
                                                <span class="text-sm">F-betyg</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                                                <input type="checkbox" id="filter-has-warning" class="student-type-filter mr-2" value="warning" checked>
                                                <span class="text-sm">F-varningar</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                                                <input type="checkbox" id="filter-has-both" class="student-type-filter mr-2" value="both" checked>
                                                <span class="text-sm">B√•de F-betyg och F-varningar</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Sorting Options -->
                                    <div>
                                        <label class="block text-sm font-medium mb-2">
                                            <i class="fas fa-sort mr-1"></i> Sortera efter
                                        </label>
                                        <select id="student-sort-by" class="select w-full px-3 py-2 rounded-md text-sm">
                                            <option value="total_desc">Flest F totalt (h√∂gst f√∂rst)</option>
                                            <option value="total_asc">Minst F totalt (l√§gst f√∂rst)</option>
                                            <option value="name_asc">Elevnamn (A-√ñ)</option>
                                            <option value="name_desc">Elevnamn (√ñ-A)</option>
                                            <option value="class_asc">Klass (A-√ñ)</option>
                                            <option value="class_desc">Klass (√ñ-A)</option>
                                            <option value="fgrade_desc">Flest F-betyg f√∂rst</option>
                                            <option value="warning_desc">Flest F-varningar f√∂rst</option>
                                            <option value="ratio_desc">H√∂gst andel F-varningar/F-betyg</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-4 flex items-center justify-between">
                                    <div class="text-sm text-gray-600 dark:text-gray-400">
                                        <span id="filtered-student-count" class="font-semibold">0</span> elever visas av totalt <span id="total-student-count" class="font-semibold">0</span>
                                    </div>
                                    <button id="reset-student-filters-btn" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                                        <i class="fas fa-undo mr-1"></i> √Öterst√§ll filter
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Class Filter Checkboxes -->
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <label class="text-sm font-medium">Filtrera efter klass:</label>
                                    <button id="select-all-classes-btn" class="ml-2 text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                        Markera alla
                                    </button>
                                    <button id="clear-all-classes-btn" class="ml-2 text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                        Avmarkera alla
                                    </button>
                                </div>
                                <div id="warning-class-checkboxes" class="class-checkbox-container">
                                    <!-- Class checkboxes will be populated here -->
                                </div>
                            </div>
                            
                            <div id="no-warnings-message" class="hidden py-4 text-center text-gray-500 dark:text-gray-400">
                                Inga F-varningar hittades med de valda filtren.
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium">Elev</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium">Klass</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium">Antal F</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="warnings-container">
                                        <!-- F warnings will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Tab (NEW) -->
                    <div id="progress-tab" class="tab-content hidden fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold mb-2 sm:mb-0">Elevutveckling</h2>
                                <p id="progress-quarter-info" class="text-sm text-gray-600 dark:text-gray-400">
                                    Visar f√∂rb√§ttringar f√∂r aktivt kvartal: <span id="progress-active-quarter" class="font-medium">-</span>
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="export-progress-btn" class="btn-primary px-3 py-1.5 rounded-md text-sm flex items-center">
                                    <i class="fas fa-download mr-2"></i> Exportera rapport
                                </button>
                                <button id="clean-duplicates-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-md text-sm flex items-center">
                                    <i class="fas fa-broom mr-2"></i> Rensa dubbletter
                                </button>
                                <button id="refresh-progress-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1.5 rounded-md text-sm flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i> Uppdatera
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Summary Cards -->
                        <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 mb-6">
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                    <i class="fas fa-arrow-up text-green-500 mr-2"></i> Totalt antal f√∂rb√§ttringar
                                </h3>
                                <p id="total-improvements" class="text-2xl font-bold mt-1 text-green-600 dark:text-green-400">0</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Elever som f√∂rb√§ttrat betyg fr√•n F</p>
                            </div>
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                    <i class="fas fa-users mr-2 text-blue-500"></i> Elever med f√∂rb√§ttringar
                                </h3>
                                <p id="students-with-improvements" class="text-2xl font-bold mt-1 text-blue-600 dark:text-blue-400">0</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Unika elever med betygsh√∂jningar</p>
                            </div>
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">
                                    <i class="fas fa-book mr-2 text-indigo-500"></i> Kurs med st√∂rst f√∂rb√§ttring
                                </h3>
                                <p id="most-improved-course" class="text-lg font-medium mt-1 text-indigo-600 dark:text-indigo-400">-</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Baserat p√• antal f√∂rb√§ttringar</p>
                            </div>
                        </div>
                        

                        
                        <!-- Progress Charts -->
                        <div class="grid gap-6 grid-cols-1 lg:grid-cols-2 mb-6">
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-gray-400"></i> Utveckling per klass
                                </h3>
                                <div class="chart-container">
                                    <canvas id="class-progress-chart"></canvas>
                                </div>
                            </div>
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-lg font-semibold mb-3 flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-gray-400"></i> Utveckling per kurs
                                </h3>
                                <div class="chart-container">
                                    <canvas id="course-progress-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Student Progress Table -->
                        <div class="card rounded-lg shadow p-4">
                            <h3 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-user-graduate mr-2 text-green-500"></i> Elever med f√∂rb√§ttringar
                            </h3>
                            
                            <div id="no-progress-message" class="hidden py-4 text-center text-gray-500 dark:text-gray-400">
                                Inga resultatf√∂rb√§ttringar hittades f√∂r det aktiva kvartalet.
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium">Elev</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium">Klass</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium">Kurs</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium">Fr√•n</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium">Till</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium">Datum</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progress-container">
                                        <!-- Progress entries will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Course Students Modal -->
                    <div id="course-students-modal" class="modal-overlay hidden">
                        <div class="modal-content p-6" style="max-width: 700px;">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold" id="modal-course-name">Kursnamn</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="modal-course-code">Kurskod</p>
                                </div>
                                <button id="close-course-modal-btn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-lg font-medium flex items-center" id="modal-grade-type-title">
                                        <i class="fas fa-users mr-2"></i> Elever
                                    </h4>
                                    <button id="export-course-students-pdf" class="btn-primary px-3 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-file-pdf mr-2"></i> Exportera PDF
                                    </button>
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    <span id="modal-student-count">0 elever</span>
                                </div>
                            </div>
                            
                            <div id="course-students-list" class="max-h-96 overflow-y-auto">
                                <!-- Student list will be populated here -->
                            </div>
                            
                            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                                <button id="modal-course-close-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    St√§ng
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student F-warnings Detail Modal -->
                    <div id="student-detail-modal" class="modal-overlay hidden">
                        <div class="modal-content p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold" id="modal-student-name">Elevnamn</h3>
                                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="mb-2">
                                <span class="font-medium">Klass:</span> <span id="modal-student-class">TE20</span>
                            </div>
                            <div class="mb-4">
                                <span class="font-medium">Antal F-varningar:</span> <span id="modal-f-count">3</span>
                            </div>
                            <div class="mb-3">
                                <h4 class="text-lg font-medium mb-2 flex items-center">
                                    <i class="fas fa-exclamation-circle mr-2 text-red-500"></i> F-varningar i kurser
                                </h4>
                                <ul id="modal-f-courses" class="space-y-2">
                                    <!-- Course warnings will be populated here -->
                                </ul>
                            </div>
                            <div id="student-progress-section" class="mb-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-lg font-medium mb-2 flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-green-500"></i> Betygsutveckling
                                </h4>
                                <div id="no-student-progress" class="text-sm text-gray-500 dark:text-gray-400 py-2">
                                    Inga betygsutvecklingar registrerade f√∂r denna elev.
                                </div>
                                <ul id="modal-student-progress" class="space-y-2 hidden">
                                    <!-- Student progress will be populated here -->
                                </ul>
                            </div>
                            <div id="student-grade-edit-section" class="mb-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-lg font-medium mb-2 flex items-center">
                                    <i class="fas fa-pen mr-2 text-blue-500"></i> Betygs√§ttning (nuvarande kvartal)
                                </h4>
                                <div id="modal-grade-edit-note" class="text-sm text-gray-500 dark:text-gray-400 mb-3"></div>
                                <div id="modal-grade-courses" class="space-y-2 max-h-64 overflow-y-auto">
                                    <!-- Course grades will be populated here -->
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                                <button id="modal-close-btn" class="btn-primary px-4 py-2 rounded-md">St√§ng</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classes Tab -->
                    <div id="classes-tab" class="tab-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Klasser</h2>
                            <button id="add-class-btn" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                <i class="fas fa-plus mr-2"></i> L√§gg till klass
                            </button>
                        </div>
                        
                        <div id="class-form-container" class="hidden mb-6 card p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Ny klass</h3>
                            <form id="class-form" class="space-y-3">
                                <div>
                                    <label for="class-name" class="block mb-1 text-sm font-medium">Klassnamn</label>
                                    <input type="text" id="class-name" class="input w-full px-3 py-2 rounded-md text-base" placeholder="t.ex. TE19" required>
                                </div>
                                <div class="flex space-x-2 pt-1">
                                    <button type="submit" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-check mr-2"></i> Spara
                                    </button>
                                    <button type="button" id="cancel-class-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-times mr-2"></i> Avbryt
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Add Edit Class Form Container -->
                        <div id="edit-class-form-container" class="hidden mb-6 card p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 flex items-center">
                                <i class="fas fa-edit mr-2"></i> Redigera klass
                            </h3>
                            <form id="edit-class-form" class="space-y-3">
                                <input type="hidden" id="edit-class-id">
                                <div>
                                    <label for="edit-class-name" class="block mb-1 text-sm font-medium">Klassnamn</label>
                                    <input type="text" id="edit-class-name" class="input w-full px-3 py-2 rounded-md text-base" required>
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium">Kurser</label>
                                    <div id="edit-class-courses-container" class="bg-gray-50 dark:bg-gray-800 p-2 rounded-md max-h-40 overflow-y-auto">
                                        <!-- Courses will be populated here -->
                                    </div>
                                </div>
                                <div class="flex space-x-2 pt-1">
                                    <button type="submit" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-check mr-2"></i> Spara
                                    </button>
                                    <button type="button" id="cancel-edit-class-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-times mr-2"></i> Avbryt
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3" id="classes-container">
                            <!-- Classes will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Courses Tab -->
                    <div id="courses-tab" class="tab-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Kurser</h2>
                            <button id="add-course-btn" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                <i class="fas fa-plus mr-2"></i> L√§gg till kurs
                            </button>
                        </div>
                        <div class="card p-4 rounded-lg mb-6">
                            <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 items-end">
                                <div>
                                    <label for="course-search-input" class="block mb-1 text-sm font-medium">S√∂k</label>
                                    <input id="course-search-input" type="text" class="input w-full px-3 py-2 rounded-md text-base" placeholder="S√∂k kursnamn eller kod...">
                                </div>
                                <div>
                                    <label for="course-class-filter" class="block mb-1 text-sm font-medium">Klass</label>
                                    <select id="course-class-filter" class="select w-full px-3 py-2 rounded-md text-base">
                                        <option value="">Alla klasser</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="course-sort-by" class="block mb-1 text-sm font-medium">Sortera</label>
                                    <select id="course-sort-by" class="select w-full px-3 py-2 rounded-md text-base">
                                        <option value="name_asc">Namn A‚Äì√ñ</option>
                                        <option value="name_desc">Namn √ñ‚ÄìA</option>
                                        <option value="code_asc">Kod A‚Äì√ñ</option>
                                        <option value="code_desc">Kod √ñ‚ÄìA</option>
                                        <option value="f_desc">Flest F f√∂rst</option>
                                        <option value="f_asc">Minst F f√∂rst</option>
                                        <option value="classes_desc">Flest klasser f√∂rst</option>
                                        <option value="classes_asc">F√§rst klasser f√∂rst</option>
                                    </select>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                                    <label class="inline-flex items-center">
                                        <input id="course-f-filter" type="checkbox" class="mr-2">
                                        <span class="text-sm">Endast kurser med F</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input id="course-only-favorites" type="checkbox" class="mr-2">
                                        <span class="text-sm">Visa favoriter</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="course-form-container" class="hidden mb-6 card p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Ny kurs</h3>
                            <form id="course-form" class="space-y-3">
                                <div>
                                    <label for="course-code" class="block mb-1 text-sm font-medium">Kurskod</label>
                                    <input type="text" id="course-code" class="input w-full px-3 py-2 rounded-md text-base" placeholder="t.ex. MATMAT01" required>
                                </div>
                                <div>
                                    <label for="course-name" class="block mb-1 text-sm font-medium">Kursnamn</label>
                                    <input type="text" id="course-name" class="input w-full px-3 py-2 rounded-md text-base" placeholder="t.ex. Matematik 1" required>
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium">Klasser</label>
                                    <div id="course-classes-container" class="bg-gray-50 dark:bg-gray-800 p-2 rounded-md max-h-40 overflow-y-auto">
                                        <!-- Classes will be populated here -->
                                    </div>
                                </div>
                                <div class="flex space-x-2 pt-1">
                                    <button type="submit" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-check mr-2"></i> Spara
                                    </button>
                                    <button type="button" id="cancel-course-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-times mr-2"></i> Avbryt
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3" id="courses-container">
                            <!-- Courses will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Students Tab -->
                    <div id="students-tab" class="tab-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Elever</h2>
                            <button id="add-student-btn" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                <i class="fas fa-plus mr-2"></i> L√§gg till elev
                            </button>
                        </div>
                        
                        <div id="student-form-container" class="hidden mb-6 card p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Ny elev</h3>
                            <form id="student-form" class="space-y-3">
                                <div>
                                    <label for="student-firstname" class="block mb-1 text-sm font-medium">F√∂rnamn</label>
                                    <input type="text" id="student-firstname" class="input w-full px-3 py-2 rounded-md text-base" required>
                                </div>
                                <div>
                                    <label for="student-lastname" class="block mb-1 text-sm font-medium">Efternamn</label>
                                    <input type="text" id="student-lastname" class="input w-full px-3 py-2 rounded-md text-base" required>
                                </div>
                                <div>
                                    <label for="student-class" class="block mb-1 text-sm font-medium">Klass</label>
                                    <select id="student-class" class="select w-full px-3 py-2 rounded-md text-base" required>
                                        <option value="">V√§lj klass</option>
                                        <!-- Classes will be populated here -->
                                    </select>
                                </div>
                                <div class="flex space-x-2 pt-1">
                                    <button type="submit" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-check mr-2"></i> Spara
                                    </button>
                                    <button type="button" id="cancel-student-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-times mr-2"></i> Avbryt
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="mb-4">
                            <label for="filter-class" class="block mb-1 text-sm font-medium">Filtrera efter klass</label>
                            <select id="filter-class" class="select w-full sm:w-64 px-3 py-2 rounded-md text-base">
                                <option value="">Alla klasser</option>
                                <!-- Classes will be populated here -->
                            </select>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow">
                                <thead class="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium">F√∂rnamn</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium">Efternamn</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium">Klass</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium">√Ötg√§rder</th>
                                    </tr>
                                </thead>
                                <tbody id="students-container">
                                    <!-- Students will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Grades Tab -->
                    <div id="grades-tab" class="tab-content hidden fade-in">
                        <h2 class="text-xl font-bold mb-6">Betygs√§ttning</h2>
                        
                        <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mb-6">
                            <div>
                                <label for="grade-class" class="block mb-1 text-sm font-medium">V√§lj klass</label>
                                <select id="grade-class" class="select w-full px-3 py-2 rounded-md text-base">
                                    <option value="">V√§lj klass</option>
                                    <!-- Classes will be populated here -->
                                </select>
                            </div>
                            
                            <div>
                                <label for="grade-course" class="block mb-1 text-sm font-medium">V√§lj kurs</label>
                                <select id="grade-course" class="select w-full px-3 py-2 rounded-md text-base" disabled>
                                    <option value="">V√§lj kurs</option>
                                    <!-- Courses will be populated here -->
                                </select>
                            </div>
                        </div>
                        
                        <div id="grade-student-container" class="hidden">
                            <h3 class="text-lg font-semibold mb-3">Elever</h3>
                            
                            <div id="no-students-message" class="hidden py-4 text-center text-gray-500 dark:text-gray-400">
                                Inga elever hittades f√∂r den valda klassen och kursen.
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium">F√∂rnamn</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium">Efternamn</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium">Betyg</th>
                                        </tr>
                                    </thead>
                                    <tbody id="grade-students-container">
                                        <!-- Students will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quarters Tab (NEW) -->
                    <div id="quarters-tab" class="tab-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Kvartal</h2>
                            <div class="flex gap-2">
                                <button id="create-snapshot-btn" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-1.5 rounded-md text-sm flex items-center">
                                    <i class="fas fa-camera mr-2"></i> Skapa Snapshot
                                </button>
                                <button id="add-quarter-btn" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                    <i class="fas fa-plus mr-2"></i> L√§gg till kvartal
                                </button>
                            </div>
                        </div>
                        
                        <div id="quarter-form-container" class="hidden mb-6 card p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">Nytt kvartal</h3>
                            <form id="quarter-form" class="space-y-3">
                                <div>
                                    <label for="quarter-name" class="block mb-1 text-sm font-medium">Namn</label>
                                    <input type="text" id="quarter-name" class="input w-full px-3 py-2 rounded-md text-base" placeholder="t.ex. VT2023-Q1" required>
                                </div>
                                <div>
                                    <label for="quarter-description" class="block mb-1 text-sm font-medium">Beskrivning</label>
                                    <input type="text" id="quarter-description" class="input w-full px-3 py-2 rounded-md text-base" placeholder="t.ex. V√•rterminen 2023, f√∂rsta kvartalet">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="quarter-is-active" class="w-4 h-4">
                                    <label for="quarter-is-active" class="text-sm font-medium">S√§tt som aktivt kvartal</label>
                                </div>
                                <div class="flex space-x-2 pt-1">
                                    <button type="submit" class="btn-primary px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-check mr-2"></i> Spara
                                    </button>
                                    <button type="button" id="cancel-quarter-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-md text-sm flex items-center">
                                        <i class="fas fa-times mr-2"></i> Avbryt
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Quarter Management Section -->
                        <div class="card rounded-lg shadow p-4 mb-6">
                            <h3 class="text-lg font-semibold mb-4">Kvartal√∂versikt</h3>
                            
                            <div id="quarters-list" class="mb-6">
                                <!-- Quarters will be populated here -->
                                <div class="text-gray-500 dark:text-gray-400 text-sm italic">Laddar kvartal...</div>
                            </div>
                            
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                                <h4 class="font-medium mb-2">Kvartalshantering</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    N√§r ett nytt kvartal skapas och aktiveras s√• visas inga betyg (eftersom det nya kvartalet √§r tomt). 
                                    Befintliga betyg fr√•n tidigare kvartal bevaras automatiskt som historik.
                                    Du kan b√∂rja s√§tta nya betyg direkt i betygs√§ttning-fliken.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Quarter Comparison Section -->
                        <div class="card rounded-lg shadow p-4">
                            <h3 class="text-lg font-semibold mb-4">J√§mf√∂r kvartal</h3>
                            
                            <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 mb-4">
                                <div>
                                    <label for="compare-from-quarter" class="block mb-1 text-sm font-medium">Fr√•n kvartal</label>
                                    <select id="compare-from-quarter" class="select w-full px-3 py-2 rounded-md text-base">
                                        <!-- Quarters will be populated here -->
                                    </select>
                                </div>
                                <div>
                                    <label for="compare-to-quarter" class="block mb-1 text-sm font-medium">Till kvartal</label>
                                    <select id="compare-to-quarter" class="select w-full px-3 py-2 rounded-md text-base">
                                        <!-- Quarters will be populated here -->
                                    </select>
                                </div>
                            </div>
                            
                            <button id="compare-quarters-btn" class="btn-primary px-4 py-2 rounded-md text-sm flex items-center">
                                <i class="fas fa-chart-line mr-2"></i> Visa j√§mf√∂relse
                            </button>
                            
                            <div id="quarter-comparison-results" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="font-medium mb-3">J√§mf√∂relseresultat</h4>
                                <div class="grid gap-4 grid-cols-1 sm:grid-cols-3">
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                                        <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">F√∂rb√§ttringar</h5>
                                        <p id="comparison-improvements" class="text-xl font-bold text-green-600 dark:text-green-400">-</p>
                                    </div>
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                                        <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">Of√∂r√§ndrade</h5>
                                        <p id="comparison-unchanged" class="text-xl font-bold text-gray-600 dark:text-gray-400">-</p>
                                    </div>
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                                        <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">F√∂rs√§mringar</h5>
                                        <p id="comparison-declines" class="text-xl font-bold text-red-600 dark:text-red-400">-</p>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h5 class="font-medium mb-2">Framsteg per klass</h5>
                                    <div class="chart-container" style="height: 200px;">
                                        <canvas id="quarter-comparison-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Archive Tab -->
                    <div id="archive-tab" class="tab-content hidden fade-in">
                        <div class="mb-6">
                            <h2 class="text-xl font-bold mb-2">Arkiv</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                H√§r kan du se och √•teraktivera arkiverade elever, kurser och klasser. 
                                All historik bevaras permanent.
                            </p>
                        </div>
                        
                        <!-- Archive Sub-tabs -->
                        <div class="mb-6">
                            <nav class="flex space-x-2 border-b border-gray-200 dark:border-gray-700">
                                <button data-archive-tab="archived-students" class="archive-sub-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors archive-tab-active">
                                    <i class="fas fa-user-graduate mr-2"></i>Elever
                                </button>
                                <button data-archive-tab="archived-courses" class="archive-sub-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
                                    <i class="fas fa-book mr-2"></i>Kurser
                                </button>
                                <button data-archive-tab="archived-classes" class="archive-sub-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
                                    <i class="fas fa-users mr-2"></i>Klasser
                                </button>
                                <button data-archive-tab="snapshots-view" class="archive-sub-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Snapshots
                                </button>
                                <button data-archive-tab="comparison-view" class="archive-sub-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors">
                                    <i class="fas fa-balance-scale mr-2"></i>J√§mf√∂relser
                                </button>
                            </nav>
                        </div>
                        
                        <!-- Archived Students -->
                        <div id="archived-students" class="archive-content">
                            <div class="card rounded-lg shadow p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">Arkiverade Elever</h3>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        <span id="archived-students-count">0</span> arkiverade
                                    </div>
                                </div>
                                
                                <!-- Search and Bulk Actions -->
                                <div class="mb-4 flex flex-col sm:flex-row gap-3">
                                    <div class="flex-1">
                                        <input 
                                            type="text" 
                                            id="archive-search-students" 
                                            class="input w-full px-3 py-2 rounded-md text-sm" 
                                            placeholder="S√∂k elev..."
                                        >
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="bulk-archive-class-btn" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded text-sm">
                                            <i class="fas fa-archive mr-1"></i> Arkivera klass
                                        </button>
                                        <button id="bulk-reactivate-students-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                                            <i class="fas fa-undo mr-1"></i> √Öteraktivera alla
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="archived-students-container" class="space-y-2">
                                    <div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">
                                        Laddar arkiverade elever...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Archived Courses -->
                        <div id="archived-courses" class="archive-content hidden">
                            <div class="card rounded-lg shadow p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">Arkiverade Kurser</h3>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        <span id="archived-courses-count">0</span> arkiverade
                                    </div>
                                </div>
                                
                                <div id="archived-courses-container" class="space-y-2">
                                    <div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">
                                        Laddar arkiverade kurser...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Archived Classes -->
                        <div id="archived-classes" class="archive-content hidden">
                            <div class="card rounded-lg shadow p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">Arkiverade Klasser</h3>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        <span id="archived-classes-count">0</span> arkiverade
                                    </div>
                                </div>
                                
                                <div id="archived-classes-container" class="space-y-2">
                                    <div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">
                                        Laddar arkiverade klasser...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Snapshots View -->
                        <div id="snapshots-view" class="archive-content hidden">
                            <div class="card rounded-lg shadow p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h3 class="text-lg font-semibold">Kvartal Snapshots</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                            Sparade snapshots av kvartal - frysta data f√∂r historisk analys
                                        </p>
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        <span id="snapshots-count">0</span> snapshots
                                    </div>
                                </div>
                                
                                <div id="snapshots-container" class="space-y-3">
                                    <div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">
                                        Laddar snapshots...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Snapshot Comparison Section -->
                            <div class="card rounded-lg shadow p-4 mt-4 hidden" id="snapshot-comparison-section">
                                <h3 class="text-lg font-semibold mb-4">J√§mf√∂r Snapshots</h3>
                                
                                <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 mb-4">
                                    <div>
                                        <label for="compare-snapshot-1" class="block mb-1 text-sm font-medium">Snapshot 1</label>
                                        <select id="compare-snapshot-1" class="select w-full px-3 py-2 rounded-md text-base">
                                            <option value="">V√§lj snapshot</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="compare-snapshot-2" class="block mb-1 text-sm font-medium">Snapshot 2</label>
                                        <select id="compare-snapshot-2" class="select w-full px-3 py-2 rounded-md text-base">
                                            <option value="">V√§lj snapshot</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button id="compare-snapshots-btn" class="btn-primary px-4 py-2 rounded-md text-sm">
                                    <i class="fas fa-balance-scale mr-2"></i> J√§mf√∂r
                                </button>
                                
                                <div id="snapshot-comparison-results" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <!-- Comparison results will be shown here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparison View -->
                        <div id="comparison-view" class="archive-content hidden">
                            <div class="card rounded-lg shadow p-4">
                                <h3 class="text-lg font-semibold mb-4">Avancerade J√§mf√∂relser</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
                                    J√§mf√∂r snapshots, klasser eller kurser side-by-side med visuella grafer.
                                </p>
                                
                                <!-- Comparison Type Selector -->
                                <div class="mb-6">
                                    <label class="block mb-2 text-sm font-medium">Vad vill du j√§mf√∂ra?</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="comparison-type-btn bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-4 py-2 rounded font-medium" data-type="snapshots">
                                            <i class="fas fa-camera mr-2"></i>Snapshots
                                        </button>
                                        <button class="comparison-type-btn bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded" data-type="classes">
                                            <i class="fas fa-users mr-2"></i>Klasser
                                        </button>
                                        <button class="comparison-type-btn bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded" data-type="courses">
                                            <i class="fas fa-book mr-2"></i>Kurser
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Snapshot Comparison -->
                                <div id="compare-snapshots-section">
                                    <div class="grid gap-4 grid-cols-1 lg:grid-cols-2 mb-4">
                                        <div>
                                            <label for="compare-snap-a" class="block mb-1 text-sm font-medium">Snapshot A</label>
                                            <select id="compare-snap-a" class="select w-full px-3 py-2 rounded-md text-base">
                                                <option value="">V√§lj snapshot...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="compare-snap-b" class="block mb-1 text-sm font-medium">Snapshot B</label>
                                            <select id="compare-snap-b" class="select w-full px-3 py-2 rounded-md text-base">
                                                <option value="">V√§lj snapshot...</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button id="run-snapshot-comparison-btn" class="btn-primary px-6 py-2 rounded-md text-sm">
                                        <i class="fas fa-balance-scale mr-2"></i> K√∂r J√§mf√∂relse
                                    </button>
                                </div>
                                
                                <!-- Class Comparison -->
                                <div id="compare-classes-section" class="hidden">
                                    <div class="grid gap-4 grid-cols-1 lg:grid-cols-2 mb-4">
                                        <div>
                                            <label for="compare-class-a" class="block mb-1 text-sm font-medium">Klass A</label>
                                            <select id="compare-class-a" class="select w-full px-3 py-2 rounded-md text-base">
                                                <option value="">V√§lj klass...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="compare-class-b" class="block mb-1 text-sm font-medium">Klass B</label>
                                            <select id="compare-class-b" class="select w-full px-3 py-2 rounded-md text-base">
                                                <option value="">V√§lj klass...</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button id="run-class-comparison-btn" class="btn-primary px-6 py-2 rounded-md text-sm">
                                        <i class="fas fa-balance-scale mr-2"></i> K√∂r J√§mf√∂relse
                                    </button>
                                </div>
                                
                                <!-- Course Comparison -->
                                <div id="compare-courses-section" class="hidden">
                                    <div class="grid gap-4 grid-cols-1 lg:grid-cols-2 mb-4">
                                        <div>
                                            <label for="compare-course-a" class="block mb-1 text-sm font-medium">Kurs A</label>
                                            <select id="compare-course-a" class="select w-full px-3 py-2 rounded-md text-base">
                                                <option value="">V√§lj kurs...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="compare-course-b" class="block mb-1 text-sm font-medium">Kurs B</label>
                                            <select id="compare-course-b" class="select w-full px-3 py-2 rounded-md text-base">
                                                <option value="">V√§lj kurs...</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button id="run-course-comparison-btn" class="btn-primary px-6 py-2 rounded-md text-sm">
                                        <i class="fas fa-balance-scale mr-2"></i> K√∂r J√§mf√∂relse
                                    </button>
                                </div>
                                
                                <!-- Comparison Results -->
                                <div id="comparison-results" class="hidden mt-6 pt-6 border-t-2 border-gray-300 dark:border-gray-600">
                                    <h4 class="text-xl font-bold mb-4">J√§mf√∂relseresultat</h4>
                                    <div id="comparison-content">
                                        <!-- Results will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grade Reset Confirmation Modal -->
                    <div id="reset-confirmation-modal" class="modal-overlay hidden">
                        <div class="modal-content p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-amber-600 dark:text-amber-400">Bekr√§fta nollst√§llning</h3>
                                <button id="close-reset-modal-btn" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="mb-4">
                                <p class="mb-3">Du √§r p√• v√§g att nollst√§lla alla betyg f√∂r det aktiva kvartalet. Detta inneb√§r att:</p>
                                <ul class="list-disc pl-5 space-y-1 text-sm">
                                    <li>Nuvarande betyg arkiveras i betyghistoriken</li>
                                    <li>Alla aktuella betyg nollst√§lls f√∂r det aktiva kvartalet</li>
                                    <li>Betygen fr√•n tidigare kvartal finns kvar och kan j√§mf√∂ras</li>
                                </ul>
                                <p class="mt-3 font-medium text-amber-600 dark:text-amber-400">Detta g√•r inte att √•ngra!</p>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button id="cancel-reset-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md">Avbryt</button>
                                <button id="confirm-reset-btn" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-md font-medium">
                                    Bekr√§fta nollst√§llning
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Create Snapshot Modal -->
                    <div id="create-snapshot-modal" class="modal-overlay hidden">
                        <div class="modal-content p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-amber-600 dark:text-amber-400">
                                    <i class="fas fa-camera mr-2"></i>Skapa Snapshot
                                </h3>
                                <button id="close-snapshot-modal-btn" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="mb-4">
                                <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
                                    Skapa en snapshot av nuvarande tillst√•nd. Perfekt f√∂r att dokumentera l√§get vid viktiga tidpunkter.
                                </p>
                                
                                <div class="mb-4">
                                    <label for="snapshot-name" class="block mb-2 text-sm font-medium">Namn p√• snapshot *</label>
                                    <input 
                                        type="text" 
                                        id="snapshot-name" 
                                        class="input w-full px-3 py-2 rounded-md text-base" 
                                        placeholder="t.ex. 'Efter h√∂stlov', 'Terminsstart', 'F√∂re slutbetyg'"
                                        required
                                    >
                                </div>
                                
                                <div class="mb-4">
                                    <label for="snapshot-notes" class="block mb-2 text-sm font-medium">Anteckningar (valfritt)</label>
                                    <textarea 
                                        id="snapshot-notes" 
                                        class="input w-full px-3 py-2 rounded-md text-base" 
                                        rows="3"
                                        placeholder="t.ex. 'Snapshot innan utvecklingssamtal' eller 'Efter insatsperiod f√∂r riskelevar'"
                                    ></textarea>
                                </div>
                                
                                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-4">
                                    <div class="text-sm">
                                        <strong>üì∏ Vad sparas:</strong>
                                        <ul class="list-disc pl-5 mt-2 space-y-1">
                                            <li>Alla betyg f√∂r aktivt kvartal</li>
                                            <li>Statistik (F-betyg, godk√§nd%, osv.)</li>
                                            <li>Snapshot av elever, kurser och klasser</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button id="cancel-snapshot-btn" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md">Avbryt</button>
                                <button id="confirm-snapshot-btn" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-md font-medium">
                                    <i class="fas fa-camera mr-2"></i> Skapa Snapshot
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Snapshot Details Modal -->
                    <div id="snapshot-details-modal" class="modal-overlay hidden">
                        <div class="modal-content p-6" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white dark:bg-gray-900 pb-3 border-b border-gray-200 dark:border-gray-700">
                                <div>
                                    <h3 class="text-2xl font-bold" id="snapshot-detail-title">Snapshot Detaljer</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="snapshot-detail-subtitle"></p>
                                </div>
                                <button id="close-snapshot-details-btn" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            
                            <!-- Overview Stats -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-lg font-semibold">√ñversikt</h4>
                                    <div class="flex gap-2">
                                        <button id="export-snapshot-excel-btn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded text-sm" title="Exportera till Excel">
                                            <i class="fas fa-file-excel"></i>
                                        </button>
                                        <button id="export-snapshot-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded text-sm" title="Exportera till PDF">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="snapshot-overview-stats"></div>
                            </div>
                            
                            <!-- Course Statistics -->
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-3">Statistik per Kurs</h4>
                                <div id="snapshot-course-stats" class="space-y-2"></div>
                            </div>
                            
                            <!-- Class Statistics -->
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-3">Statistik per Klass</h4>
                                <div id="snapshot-class-stats" class="space-y-2"></div>
                            </div>
                            
                            <!-- Detailed Lists (populated when clicking on stats) -->
                            <div id="snapshot-detail-list" class="hidden mt-6 pt-6 border-t-2 border-gray-300 dark:border-gray-600">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold" id="detail-list-title"></h4>
                                    <button onclick="document.getElementById('snapshot-detail-list').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="detail-list-content"></div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Supabase configuration
        const SUPABASE_URL = 'https://fykxvhrlkjltgqsksyoz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5a3h2aHJsa2psdGdxc2tzeW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5MDYxNzYsImV4cCI6MjA1ODQ4MjE3Nn0.p-tE7MS2vPH0RNlW5U5t_A_UkLHEtMwZVxyHwQX6Sns';
        
        // Supabase client initialization
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
        let currentUser = null;
        let userRole = null; // Store the user's role
        
        let classes = [];
        let courses = [];
        let students = [];
        let classCourseMappings = [];
        let grades = [];
        let teachers = {};
        let roles = {}; // Store role information
        let quarters = []; // Store quarters
        
        // Archive data
        let archivedStudents = [];
        let archivedCourses = [];
        let archivedClasses = [];
        let gradeHistory = []; // Store grade history/progression
        let activeQuarter = null; // Currently active quarter
        let favoriteCourseIds = new Set();
        let courseToolbarInitialized = false;
        const courseFilters = { search: '', classId: '', fOnly: false, onlyFavorites: false, sortBy: 'name_asc' };
        
        // Grade type filtering (grades = F-betyg, warnings = F-varningar, both = b√•da)
        let activeGradeTypeFilter = 'grades'; // Default to showing F-betyg
        
        // Data caching system
        const dataCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        
        function getCacheKey(tableName, filters = {}) {
            return `${tableName}_${JSON.stringify(filters)}`;
        }
        
        function isCacheValid(cacheEntry) {
            return cacheEntry && (Date.now() - cacheEntry.timestamp < CACHE_DURATION);
        }
        
        function setCache(key, data) {
            dataCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        }
        
        function getCache(key) {
            const cacheEntry = dataCache.get(key);
            return isCacheValid(cacheEntry) ? cacheEntry.data : null;
        }
        
        function clearCache(pattern = null) {
            if (pattern) {
                for (const [key] of dataCache) {
                    if (key.includes(pattern)) {
                        dataCache.delete(key);
                    }
                }
            } else {
                dataCache.clear();
            }
        }
        
        // PERMANENT ADMIN LIST - CANNOT BE CHANGED
        const PERMANENT_ADMINS = [
            'iman.ehsani@jarvagymnasium.se',
            'ala.nestani.rad@jarvagymnasium.se',
            'amir.sajadi@jarvagymnasium.se'
        ];
        
        // Function to enforce admin role for protected users
        function enforceAdminRole() {
            if (currentUser && PERMANENT_ADMINS.includes(currentUser.email)) {
                if (userRole !== 'admin') {
                    console.warn('‚ö†Ô∏è Role was changed from admin to', userRole, '- FORCING BACK TO ADMIN for:', currentUser.email);
                    userRole = 'admin';
                }
            }
        }
        
        // Run enforceAdminRole every second to catch any changes
        setInterval(enforceAdminRole, 1000);
        
        // Role-based permission constants
        const PERMISSIONS = {
            admin: ['view_data', 'manage_classes', 'manage_courses', 'manage_students', 'manage_grades', 'manage_quarters'],
            teacher: ['view_data', 'manage_grades'],
            analyst: ['view_data']
        };
        
        // Chart instances
        let classChart = null;
        let courseChart = null;
        let classProgressChart = null;
        let courseProgressChart = null;
        let quarterComparisonChart = null;
        // Removed: gradeDistributionChart and trendChart (graferna borttagna)
        
        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginButtonText = document.getElementById('login-button-text');
        const loginSpinner = document.getElementById('login-spinner');
        const userEmail = document.getElementById('user-email');
        const userPosition = document.getElementById('user-position');
        const roleBadge = document.getElementById('role-badge');
        const logoutBtn = document.getElementById('logout-btn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const loading = document.getElementById('loading');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const activeQuarterIndicator = document.getElementById('active-quarter-indicator');
        const activeQuarterName = document.getElementById('active-quarter-name');
        
        // F-warnings elements
        const warningClassFilter = document.getElementById('warning-class-filter');
        const warningCourseFilter = document.getElementById('warning-course-filter');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const refreshWarningsBtn = document.getElementById('refresh-warnings-btn');
        const exportWarningsBtn = document.getElementById('export-warnings-btn');
        const totalFCount = document.getElementById('total-f-count');
        const studentsWithF = document.getElementById('students-with-f');
        const worstCourse = document.getElementById('worst-course');
        const worstClass = document.getElementById('worst-class');
        const warningsContainer = document.getElementById('warnings-container');
        const noWarningsMessage = document.getElementById('no-warnings-message');
        
        // Progress tab elements
        const totalImprovements = document.getElementById('total-improvements');
        const studentsWithImprovements = document.getElementById('students-with-improvements');
        const mostImprovedCourse = document.getElementById('most-improved-course');

        const progressContainer = document.getElementById('progress-container');
        const noProgressMessage = document.getElementById('no-progress-message');
        const exportProgressBtn = document.getElementById('export-progress-btn');
        const refreshProgressBtn = document.getElementById('refresh-progress-btn');
        
        // Warning class checkboxes elements
        const warningClassCheckboxes = document.getElementById('warning-class-checkboxes');
        const selectAllClassesBtn = document.getElementById('select-all-classes-btn');
        const clearAllClassesBtn = document.getElementById('clear-all-classes-btn');
        let selectedClassIds = []; // Track selected class IDs for filtering
        
        // Student detail modal elements
        const studentDetailModal = document.getElementById('student-detail-modal');
        const modalStudentName = document.getElementById('modal-student-name');
        const modalStudentClass = document.getElementById('modal-student-class');
        const modalFCount = document.getElementById('modal-f-count');
        const modalFCourses = document.getElementById('modal-f-courses');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const studentProgressSection = document.getElementById('student-progress-section');
        const noStudentProgress = document.getElementById('no-student-progress');
        const modalStudentProgress = document.getElementById('modal-student-progress');
        const modalGradeCourses = document.getElementById('modal-grade-courses');
        const modalGradeEditNote = document.getElementById('modal-grade-edit-note');
        
        // Class tab elements
        const addClassBtn = document.getElementById('add-class-btn');
        const classFormContainer = document.getElementById('class-form-container');
        const classForm = document.getElementById('class-form');
        const cancelClassBtn = document.getElementById('cancel-class-btn');
        const classesContainer = document.getElementById('classes-container');
        
        // Edit class elements
        const editClassFormContainer = document.getElementById('edit-class-form-container');
        const editClassForm = document.getElementById('edit-class-form');
        const editClassId = document.getElementById('edit-class-id');
        const editClassName = document.getElementById('edit-class-name');
        const editClassCoursesContainer = document.getElementById('edit-class-courses-container');
        const cancelEditClassBtn = document.getElementById('cancel-edit-class-btn');
        
        // Course tab elements
        const addCourseBtn = document.getElementById('add-course-btn');
        const courseFormContainer = document.getElementById('course-form-container');
        const courseForm = document.getElementById('course-form');
        const cancelCourseBtn = document.getElementById('cancel-course-btn');
        const courseClassesContainer = document.getElementById('course-classes-container');
        const coursesContainer = document.getElementById('courses-container');
        const courseSearchInput = document.getElementById('course-search-input');
        const courseClassFilter = document.getElementById('course-class-filter');
        const courseSortBy = document.getElementById('course-sort-by');
        const courseFFilter = document.getElementById('course-f-filter');
        const courseOnlyFavorites = document.getElementById('course-only-favorites');
        
        // Student tab elements
        const addStudentBtn = document.getElementById('add-student-btn');
        const studentFormContainer = document.getElementById('student-form-container');
        const studentForm = document.getElementById('student-form');
        const cancelStudentBtn = document.getElementById('cancel-student-btn');
        const studentClass = document.getElementById('student-class');
        const filterClass = document.getElementById('filter-class');
        const studentsContainer = document.getElementById('students-container');
        
        // Grade tab elements
        const gradeClass = document.getElementById('grade-class');
        const gradeCourse = document.getElementById('grade-course');
        const gradeStudentContainer = document.getElementById('grade-student-container');
        const noStudentsMessage = document.getElementById('no-students-message');
        const gradeStudentsContainer = document.getElementById('grade-students-container');
        
        // Quarter tab elements
        const addQuarterBtn = document.getElementById('add-quarter-btn');
        const quarterFormContainer = document.getElementById('quarter-form-container');
        const quarterForm = document.getElementById('quarter-form');
        const cancelQuarterBtn = document.getElementById('cancel-quarter-btn');
        const quartersList = document.getElementById('quarters-list');
        const compareFromQuarter = document.getElementById('compare-from-quarter');
        const compareToQuarter = document.getElementById('compare-to-quarter');
        const compareQuartersBtn = document.getElementById('compare-quarters-btn');
        const quarterComparisonResults = document.getElementById('quarter-comparison-results');
        const comparisonImprovements = document.getElementById('comparison-improvements');
        const comparisonUnchanged = document.getElementById('comparison-unchanged');
        const comparisonDeclines = document.getElementById('comparison-declines');
        
        // Reset confirmation modal elements

        
        // Role-based permission check function
        function userCan(action) {
            // ENFORCE ADMIN for protected users BEFORE any permission check
            if (currentUser && PERMANENT_ADMINS.includes(currentUser.email)) {
                if (userRole !== 'admin') {
                    console.warn('‚ö†Ô∏è userCan detected role mismatch - forcing admin for:', currentUser.email);
                    userRole = 'admin';
                }
                // Protected admins always have all permissions
                return true;
            }
            
            // TEMPORARY: Allow ALL actions until role system is properly configured
            // Remove this when you want to use the actual role system
            console.log(`Permission check: ${action} - ALLOWING ALL (actual role: ${userRole})`);
            
            return true;
            
            /* Original role-based logic (commented out temporarily):
            // If no userRole is set, default to admin for safety
            const effectiveRole = userRole || 'admin';
            
            if (!userRole) {
                console.warn('No user role found, defaulting to admin permissions');
            }
            
            const hasPermission = PERMISSIONS[effectiveRole]?.includes(action) || false;
            console.log(`Permission check: ${action} for role ${effectiveRole} = ${hasPermission}`);
            
            return hasPermission;
            */
        }
        
        // Helper functions
        function showLoading() {
            loading.classList.remove('hidden');
            loading.classList.add('flex');
        }
        
        function hideLoading() {
            loading.classList.add('hidden');
            loading.classList.remove('flex');
        }
        
        function showError(message, type = 'error') {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            
            // Add type-specific styling
            errorContainer.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 max-w-md ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                type === 'info' ? 'bg-blue-500 text-white' :
                'bg-red-500 text-white'
            }`;
            
            setTimeout(() => {
                errorContainer.classList.add('hidden');
                errorContainer.className = 'fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 max-w-md bg-red-500 text-white hidden';
            }, 5000);
        }
        
        function showSuccess(message) {
            showError(message, 'success');
        }
        
        function showWarning(message) {
            showError(message, 'warning');
        }
        
        function showInfo(message) {
            showError(message, 'info');
        }
        
        // Modern notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const iconMap = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${iconMap[type] || iconMap.info}"></i>
                </div>
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="removeNotification(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                removeNotification(notification);
            }, duration);
        }
        
        function removeNotification(notification) {
            if (notification && notification.parentElement) {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.parentElement.removeChild(notification);
                    }
                }, 300);
            }
        }
        
        function showSuccessNotification(message) {
            showNotification(message, 'success');
        }
        
        function showErrorNotification(message) {
            showNotification(message, 'error');
        }
        
        function showWarningNotification(message) {
            showNotification(message, 'warning');
        }
        
        function showInfoNotification(message) {
            showNotification(message, 'info');
        }
        
        // Enhanced error handling for different types of errors
        function handleError(error, context = '') {
            console.error(`Error in ${context}:`, error);
            
            let message = 'Ett ov√§ntat fel intr√§ffade.';
            
            if (error.message) {
                if (error.message.includes('JWT') || error.message.includes('token')) {
                    message = 'Din session har g√•tt ut. Logga in igen.';
                    setTimeout(() => handleLogout(), 2000);
                } else if (error.message.includes('permission') || error.message.includes('unauthorized')) {
                    message = 'Du har inte beh√∂righet f√∂r denna √•tg√§rd.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    message = 'N√§tverksfel. Kontrollera din internetanslutning.';
                } else if (error.message.includes('duplicate') || error.message.includes('already exists')) {
                    message = 'Detta element finns redan i systemet.';
                } else if (error.message.includes('not found')) {
                    message = 'Den beg√§rda informationen kunde inte hittas.';
                } else {
                    message = error.message;
                }
            }
            
            showError(context ? `${context}: ${message}` : message);
        }
        
        // NOTE: setActiveTab() is defined later with lazy-loading support (tabDataLoaders).
        // Keep only one implementation to avoid confusion/override bugs.
        
        // Update UI based on user role
        function updateUIBasedOnRole() {
            // ENFORCE ADMIN for protected users
            if (currentUser && PERMANENT_ADMINS.includes(currentUser.email)) {
                userRole = 'admin';
                console.log('üõ°Ô∏è updateUIBasedOnRole - Enforcing admin for:', currentUser.email);
            }
            
            // Update role badge
            if (userRole) {
                roleBadge.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                roleBadge.className = `role-badge role-badge-${userRole}`;
                
                // Update position title
                if (userRole === 'admin') {
                    userPosition.textContent = 'Administrat√∂r';
                } else if (userRole === 'teacher') {
                    userPosition.textContent = 'L√§rare';
                } else if (userRole === 'analyst') {
                    userPosition.textContent = 'Analytiker';
                }
            }
            
            // Update add buttons based on permissions
            if (!userCan('manage_classes')) {
                // Hide add class button
                addClassBtn.classList.add('hidden');
                
                // Hide edit and delete buttons for classes
                document.querySelectorAll('.edit-class-btn, .delete-class-btn').forEach(btn => {
                    btn.classList.add('hidden');
                });
            }
            
            if (!userCan('manage_courses')) {
                // Hide add course button
                addCourseBtn.classList.add('hidden');
                
                // Hide delete buttons for courses
                document.querySelectorAll('.delete-course-btn').forEach(btn => {
                    btn.classList.add('hidden');
                });
            }
            
            if (!userCan('manage_students')) {
                // Hide add student button
                addStudentBtn.classList.add('hidden');
                
                // Hide delete buttons for students
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.classList.add('hidden');
                });
            }
            
            // Make grade pills disabled for users who can't manage grades
            if (!userCan('manage_grades')) {
                document.querySelectorAll('.grade-pill').forEach(pill => {
                    pill.classList.add('opacity-50', 'cursor-not-allowed');
                    pill.disabled = true;
                });
            }
            
            // Handle quarter management permissions
            if (!userCan('manage_quarters')) {
                addQuarterBtn.classList.add('hidden');
            }
        }
        
        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                userEmail.textContent = currentUser.email;
                
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                
                // Set user avatar initials
                setUserAvatar(currentUser.email);
                
                // Load initial data
                await Promise.all([
                    fetchRoles(),
                    fetchUserRole(),
                    fetchQuarters(),
                    fetchClasses(),
                    fetchCourses(),
                    fetchStudents(),
                    fetchClassCourseMappings(),
                    fetchGrades(),
                    fetchGradeHistory(),
                    fetchTeachers()
                ]);
                
                updateUI();
                updateUIBasedOnRole();
                
                // Re-enable all controls after UI is built (for admin override)
                setTimeout(async () => {
                    reEnableAllControls();
                    await renderGradeDropdowns();
                }, 1000);
                
                await loadWarningsData();
            } catch (error) {
                loginError.textContent = error.message || 'Inloggningen misslyckades. Kontrollera dina uppgifter.';
                loginError.classList.remove('hidden');
            } finally {
                loginButtonText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        }
        
        function setUserAvatar(email) {
            const initial = email ? email.charAt(0).toUpperCase() : 'U';
            const avatarElements = document.querySelectorAll('.user-avatar');
            avatarElements.forEach(el => {
                el.innerHTML = initial;
            });
        }
        
        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                userRole = null;
                dashboard.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                showError('Utloggningen misslyckades: ' + error.message);
            }
        }
        
        // Data fetching functions
        async function fetchRoles() {
            try {
                const { data, error } = await supabaseClient
                    .from('roles')
                    .select('*');
                
                if (error) throw error;
                
                // Create a map of role IDs to names
                roles = {};
                data.forEach(role => {
                    roles[role.id] = role.name;
                });
            } catch (error) {
                showError('Kunde inte h√§mta roller: ' + error.message);
            }
        }
        
        async function fetchUserRole() {
            // HARDCODED ADMIN LIST - Always admin regardless of database
            const PERMANENT_ADMINS = [
                'iman.ehsani@jarvagymnasium.se',
                'ala.nestani.rad@jarvagymnasium.se',
                'amir.sajadi@jarvagymnasium.se'
            ];
            
            // Check if user is permanent admin FIRST
            if (PERMANENT_ADMINS.includes(currentUser.email)) {
                userRole = 'admin';
                console.log('üõ°Ô∏è PERMANENT ADMIN:', currentUser.email, '- Role locked to ADMIN');
                return; // Skip database check completely for these users
            }
            
            // For other users, check database
            try {
                // Try simpler query first - just get role_id
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('role_id')
                    .eq('id', currentUser.id)
                    .maybeSingle();
                
                if (profileError || !profileData || !profileData.role_id) {
                    console.warn('No profile or role_id found for user:', currentUser.email);
                    userRole = 'teacher'; // Default for non-protected users
                    return;
                }
                
                // Now get the role name from roles table
                const { data: roleData, error: roleError } = await supabaseClient
                    .from('roles')
                    .select('name')
                    .eq('id', profileData.role_id)
                    .single();
                
                if (roleError || !roleData) {
                    console.warn('Could not fetch role name for role_id:', profileData.role_id);
                    userRole = 'teacher';
                    return;
                }
                
                userRole = roleData.name;
                console.log('‚úÖ User role loaded:', userRole, 'for user:', currentUser.email);
                
            } catch (error) {
                console.error('Exception in fetchUserRole:', error);
                userRole = 'teacher'; // Safe default for non-protected users
            }
        }
        
        async function fetchQuarters() {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('quarters')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                quarters = data;
                
                // Set active quarter
                activeQuarter = quarters.find(q => q.is_active);
                
                // Update active quarter indicator
                if (activeQuarter) {
                    activeQuarterName.textContent = activeQuarter.name;
                } else if (quarters.length > 0) {
                    // If no active quarter but quarters exist, set the most recent as active
                    activeQuarter = quarters[0];
                    activeQuarterName.textContent = `${activeQuarter.name} (senaste)`;
                    
                    // Update the quarter to be active
                    if (userCan('manage_quarters')) {
                        const { error: updateError } = await supabaseClient
                            .from('quarters')
                            .update({ is_active: true })
                            .eq('id', activeQuarter.id);
                        
                        if (updateError) {
                            console.error('Kunde inte s√§tta aktivt kvartal:', updateError);
                        }
                    }
                } else {
                    // If no quarters at all, create a default one
                    await createDefaultQuarter();
                }
                
                // Populate quarter dropdowns
                populateQuarterDropdowns();
                
            } catch (error) {
                showError('Kunde inte h√§mta kvartal: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function createDefaultQuarter() {
            if (!userCan('manage_quarters')) {
                activeQuarterName.textContent = 'Inget kvartal skapat';
                return;
            }
            
            const today = new Date();
            const year = today.getFullYear();
            const quarter = Math.floor(today.getMonth() / 3) + 1;
            const term = today.getMonth() < 6 ? 'VT' : 'HT';
            
            const quarterName = `${term}${year}-Q${quarter}`;
            
            try {
                const { data, error } = await supabaseClient
                    .from('quarters')
                    .insert([{
                        name: quarterName,
                        description: `${term === 'VT' ? 'V√•rtermin' : 'H√∂sttermin'} ${year}, kvartal ${quarter}`,
                        is_active: true
                    }])
                    .select();
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    activeQuarter = data[0];
                    activeQuarterName.textContent = activeQuarter.name;
                    quarters = [activeQuarter];
                    
                    // Populate quarter dropdowns
                    populateQuarterDropdowns();
                }
            } catch (error) {
                console.error('Kunde inte skapa standardkvartal:', error);
                activeQuarterName.textContent = 'Skapande av kvartal misslyckades';
            }
        }
        
        function populateQuarterDropdowns() {
            const dropdowns = [compareFromQuarter, compareToQuarter];
            
            dropdowns.forEach(dropdown => {
                // Clear dropdown
                dropdown.innerHTML = '<option value="">V√§lj kvartal</option>';
                
                // Add quarters
                quarters.forEach(quarter => {
                    const option = document.createElement('option');
                    option.value = quarter.id;
                    option.textContent = quarter.name + (quarter.is_active ? ' (aktivt)' : '');
                    dropdown.appendChild(option);
                });
            });
        }
        
        async function fetchClasses(useCache = true) {
            const cacheKey = getCacheKey('classes');
            
            if (useCache) {
                const cached = getCache(cacheKey);
                if (cached) {
                    classes = cached;
                    console.log('Classes loaded from cache');
                    return;
                }
            }
            
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('classes')
                    .select('*')
                    .eq('is_active', true)  // üîí Soft delete: Visa endast aktiva klasser
                    .order('name');
                
                if (error) throw error;
                
                classes = data;
                
                // Cache the data
                setCache(cacheKey, classes);
                console.log('Classes loaded from database and cached');
            } catch (error) {
                showError('Kunde inte h√§mta klasser: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function fetchCourses() {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('courses')
                    .select('*')
                    .eq('is_active', true)  // üîí Soft delete: Visa endast aktiva kurser
                    .order('name');
                
                if (error) throw error;
                
                courses = data;
            } catch (error) {
                showError('Kunde inte h√§mta kurser: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function fetchStudents() {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('students')
                    .select('*, classes(name)')
                    .eq('is_active', true)  // üîí Soft delete: Visa endast aktiva elever
                    .order('last_name');
                
                if (error) throw error;
                
                students = data;
            } catch (error) {
                showError('Kunde inte h√§mta elever: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function fetchClassCourseMappings() {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('course_class')
                    .select('*');
                
                if (error) throw error;
                
                classCourseMappings = data;
            } catch (error) {
                showError('Kunde inte h√§mta kurs-klasskopplingar: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
async function fetchGrades() {
    showLoading();
    try {
        // üîí FILTRERA BORT ARKIVERADE ELEVERS BETYG fr√•n statistiken
        // Men betygen finns kvar i databasen f√∂r historisk analys
        let query = supabaseClient
            .from('grades')
            .select(`
                *,
                students!inner(is_active)
            `);
        
        // Filtrera: Endast betyg f√∂r AKTIVA elever
        query = query.eq('students.is_active', true);
        
        // Bara filtrera p√• quarter_id om vi faktiskt har ett aktivt kvartal
        if (activeQuarter && activeQuarter.id) {
            query = query.eq('quarter_id', activeQuarter.id);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        // Rensa bort den extra students property f√∂r att inte st√∂ra befintlig kod
        grades = data.map(grade => {
            const { students, ...gradeWithoutStudents } = grade;
            return gradeWithoutStudents;
        });
        
        console.log(`üìä H√§mtade ${grades.length} betyg (endast aktiva elever)`);
    } catch (error) {
        showError('Kunde inte h√§mta betyg: ' + error.message);
    } finally {
        hideLoading();
    }
}
        
        async function fetchGradeHistory() {
            showLoading();
            try {
                // üîí VIKTIGT: H√§mtar ALL grade_history OAVSETT om elev √§r arkiverad
                // Detta bevarar all utvecklingsstatistik permanent (F‚ÜíE f√∂rb√§ttringar etc)
                // Tack vare student_snapshot & course_snapshot kan vi se historik √§ven om original raderas
                const { data, error } = await supabaseClient
                    .from('grade_history')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                gradeHistory = data;
                console.log(`üìà H√§mtade ${gradeHistory.length} historikposter (inkl. arkiverade elever)`);
            } catch (error) {
                showError('Kunde inte h√§mta betygsutveckling: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function fetchTeachers() {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*, roles(name)');
                
                if (error) throw error;
                
                // Create a map of teacher IDs to names
                teachers = {};
                data.forEach(teacher => {
                    teachers[teacher.id] = {
                        name: teacher.name || teacher.email,
                        role: teacher.roles ? teacher.roles.name : 'admin'
                    };
                });
            } catch (error) {
                showError('Kunde inte h√§mta l√§raruppgifter: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // üìù ENHANCED GRADE HISTORY - Log ALL grade changes
        async function logGradeChange(studentId, courseId, fromGrade, toGrade, changeType, gradeType = 'grade') {
            try {
                const student = students.find(s => s.id === studentId);
                const course = courses.find(c => c.id === courseId);
                const studentClass = student ? classes.find(cl => cl.id === student.class_id) : null;
                
                const { error } = await supabaseClient
                    .from('grade_history')
                    .insert({
                        student_id: studentId,
                        course_id: courseId,
                        from_grade: fromGrade,
                        to_grade: toGrade,
                        quarter_id: activeQuarter ? activeQuarter.id : null,
                        teacher_id: currentUser ? currentUser.id : null,
                        change_type: changeType,
                        // üîí SNAPSHOT DATA (bevara √§ven om originalet raderas)
                        student_snapshot: student ? {
                            first_name: student.first_name,
                            last_name: student.last_name,
                            class_id: student.class_id,
                            class_name: studentClass ? studentClass.name : null
                        } : null,
                        course_snapshot: course ? {
                            code: course.code,
                            name: course.name
                        } : null,
                        notes: `Betyg ${fromGrade ? `√§ndrat fr√•n ${fromGrade}` : 'satt'} till ${toGrade}${gradeType === 'warning' ? ' (varning)' : ''}`
                    });
                
                if (error) {
                    console.error('Kunde inte logga betygs√§ndring:', error);
                } else {
                    console.log(`‚úÖ Betygs√§ndring loggad: ${fromGrade || 'nytt'} ‚Üí ${toGrade} (${changeType})`);
                }
            } catch (error) {
                console.error('Exception vid logging av betygs√§ndring:', error);
            }
        }
        
        // üîí ARCHIVE FUNCTIONS - Fetch archived data
        async function fetchArchivedStudents() {
            try {
                const { data, error } = await supabaseClient
                    .from('students')
                    .select('*, classes(name)')
                    .eq('is_active', false)
                    .order('archived_at', { ascending: false });
                
                if (error) throw error;
                
                archivedStudents = data || [];
                return archivedStudents;
            } catch (error) {
                console.error('Kunde inte h√§mta arkiverade elever:', error);
                showError('Kunde inte h√§mta arkiverade elever: ' + error.message);
                return [];
            }
        }
        
        async function fetchArchivedCourses() {
            try {
                const { data, error } = await supabaseClient
                    .from('courses')
                    .select('*')
                    .eq('is_active', false)
                    .order('archived_at', { ascending: false});
                
                if (error) throw error;
                
                archivedCourses = data || [];
                return archivedCourses;
            } catch (error) {
                console.error('Kunde inte h√§mta arkiverade kurser:', error);
                showError('Kunde inte h√§mta arkiverade kurser: ' + error.message);
                return [];
            }
        }
        
        async function fetchArchivedClasses() {
            try {
                const { data, error } = await supabaseClient
                    .from('classes')
                    .select('*')
                    .eq('is_active', false)
                    .order('archived_at', { ascending: false });
                
                if (error) throw error;
                
                archivedClasses = data || [];
                return archivedClasses;
            } catch (error) {
                console.error('Kunde inte h√§mta arkiverade klasser:', error);
                showError('Kunde inte h√§mta arkiverade klasser: ' + error.message);
                return [];
            }
        }
        
        // UI update functions
        function updateUI() {
            renderClassDropdowns();
            initCourseToolbar();
            renderClasses();
            renderCourses();
            renderStudents();
            renderWarningFilters();
            renderClassCheckboxes();
        }
        
        function renderClassDropdowns() {
            // Clear and update all class dropdowns
            const classOptions = classes.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');
            
            const classDropdowns = [studentClass, filterClass, gradeClass, warningClassFilter, courseClassFilter];
            
            classDropdowns.forEach(dropdown => {
                // Save current value
                const currentValue = dropdown.value;
                
                // Clear options except the first one
                while (dropdown.options.length > 1) {
                    dropdown.remove(1);
                }
                
                // Add new options
                dropdown.insertAdjacentHTML('beforeend', classOptions);
                
                // Restore value if it exists in new options
                if (currentValue && [...dropdown.options].some(o => o.value === currentValue)) {
                    dropdown.value = currentValue;
                }
            });
        }

        // Favorite helpers and toolbar initialization for Courses tab
        function loadFavoriteCourses() {
            try {
                const raw = localStorage.getItem('favoriteCourseIds');
                const arr = raw ? JSON.parse(raw) : [];
                favoriteCourseIds = new Set(Array.isArray(arr) ? arr : []);
            } catch (e) {
                favoriteCourseIds = new Set();
            }
        }

        function saveFavoriteCourses() {
            try {
                localStorage.setItem('favoriteCourseIds', JSON.stringify([...favoriteCourseIds]));
            } catch (e) {
                // Ignore storage errors
            }
        }

        function initCourseToolbar() {
            if (courseToolbarInitialized) return;
            loadFavoriteCourses();
            if (courseSearchInput) {
                courseSearchInput.addEventListener('input', (e) => {
                    courseFilters.search = (e.target.value || '').toLowerCase();
                    renderCourses();
                });
            }
            if (courseClassFilter) {
                courseClassFilter.addEventListener('change', (e) => {
                    courseFilters.classId = e.target.value || '';
                    renderCourses();
                });
            }
            if (courseSortBy) {
                courseSortBy.value = courseFilters.sortBy;
                courseSortBy.addEventListener('change', (e) => {
                    courseFilters.sortBy = e.target.value || 'name_asc';
                    renderCourses();
                });
            }
            if (courseFFilter) {
                courseFFilter.addEventListener('change', (e) => {
                    courseFilters.fOnly = !!e.target.checked;
                    renderCourses();
                });
            }
            if (courseOnlyFavorites) {
                courseOnlyFavorites.addEventListener('change', (e) => {
                    courseFilters.onlyFavorites = !!e.target.checked;
                    renderCourses();
                });
            }
            courseToolbarInitialized = true;
        }
        
        function renderWarningFilters() {
            // Populate course filter
            const courseOptions = courses.map(c => 
                `<option value="${c.id}">${c.code} - ${c.name}</option>`
            ).join('');
            
            // Clear options except the first one
            while (warningCourseFilter.options.length > 1) {
                warningCourseFilter.remove(1);
            }
            
            // Add new options
            warningCourseFilter.insertAdjacentHTML('beforeend', courseOptions);
        }
        
        // Render class checkboxes for student filtering
        function renderClassCheckboxes() {
            warningClassCheckboxes.innerHTML = '';
            
            if (classes.length === 0) {
                warningClassCheckboxes.innerHTML = `
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Inga klasser tillg√§ngliga.
                    </p>
                `;
                return;
            }
            
            // Initialize all classes as selected
            selectedClassIds = classes.map(c => c.id);
            
            // Create checkbox for each class
            classes.forEach(c => {
                const label = document.createElement('label');
                label.className = 'class-checkbox';
                label.innerHTML = `
                    <input type="checkbox" class="class-filter-checkbox" value="${c.id}" checked>
                    <span class="text-sm">${c.name}</span>
                `;
                warningClassCheckboxes.appendChild(label);
            });
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.class-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const classId = checkbox.value;
                    
                    if (checkbox.checked) {
                        // Add class ID to selected classes if not already there
                        if (!selectedClassIds.includes(classId)) {
                            selectedClassIds.push(classId);
                        }
                    } else {
                        // Remove class ID from selected classes
                        selectedClassIds = selectedClassIds.filter(id => id !== classId);
                    }
                    
                    // Re-render warnings table with filtered classes
                    filterWarningsBySelectedClasses();
                });
            });
        }
        
        // Filter warnings by selected classes
        function filterWarningsBySelectedClasses() {
            const fGrades = grades.filter(g => g.grade === 'F');
            renderWarningsTable(fGrades);
        }
        
        function renderClasses() {
            classesContainer.innerHTML = '';
            
            if (classes.length === 0) {
                classesContainer.innerHTML = `
                    <div class="col-span-full py-4 text-center text-gray-500 dark:text-gray-400">
                        Inga klasser skapade √§n. ${userCan('manage_classes') ? 'Anv√§nd knappen "L√§gg till klass" f√∂r att skapa en klass.' : ''}
                    </div>
                `;
                return;
            }
            
            classes.forEach(c => {
                // Count students in this class
                const classStudents = students.filter(s => s.class_id === c.id).length;
                
                // Count F grades in this class
                const classFGrades = grades.filter(g => {
                    const student = students.find(s => s.id === g.student_id);
                    return student && student.class_id === c.id && g.grade === 'F';
                }).length;
                
                // Get associated courses
                const classCourses = classCourseMappings
                    .filter(mapping => mapping.class_id === c.id)
                    .map(mapping => {
                        const course = courses.find(course => course.id === mapping.course_id);
                        return course ? course.name : '';
                    })
                    .filter(Boolean);
                
                const classCard = document.createElement('div');
                classCard.className = 'card rounded-lg shadow p-4';
                
                // Create card with appropriate action buttons based on role
                const editDeleteBtns = userCan('manage_classes') ? `
                    <div class="mt-3 flex justify-between">
                        <button class="edit-class-btn text-blue-500 hover:text-blue-700 text-sm flex items-center" data-id="${c.id}">
                            <i class="fas fa-edit mr-1"></i> Redigera
                        </button>
                        <button class="delete-class-btn text-red-500 hover:text-red-700 text-sm flex items-center" data-id="${c.id}">
                            <i class="fas fa-trash-alt mr-1"></i> Ta bort
                        </button>
                    </div>
                ` : '';
                
                classCard.innerHTML = `
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-users text-indigo-500 mr-2"></i>
                        ${c.name}
                    </h3>
                    <div class="mt-2 text-sm">
                        <span class="text-gray-600 dark:text-gray-400">${classStudents} elever</span>
                        ${classFGrades > 0 ? `<span class="warning-badge ml-2">${classFGrades} F</span>` : ''}
                    </div>
                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        <span class="font-medium">Kurser:</span> 
                        ${classCourses.length > 0 ? classCourses.join(', ') : 'Inga kurser tilldelade'}
                    </div>
                    <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
                        Skapad: ${new Date(c.created_at).toLocaleDateString()}
                    </div>
                    ${editDeleteBtns}
                `;
                classesContainer.appendChild(classCard);
            });
            
            // Add event listeners to delete buttons (now Archive)
            document.querySelectorAll('.delete-class-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!userCan('manage_classes')) {
                        showError('Du har inte beh√∂righet att arkivera klasser.');
                        return;
                    }
                    
                    const classId = btn.dataset.id;
                    const classObj = classes.find(c => c.id === classId);
                    const className = classObj ? classObj.name : 'klassen';
                    
                    if (confirm(`‚ö†Ô∏è Arkivera ${className}?\n\n‚úÖ Klassen kommer att d√∂ljas fr√•n aktiv vy\n‚úÖ ALL historik och data bevaras\n‚úÖ Du kan √•teraktivera klassen senare om det beh√∂vs\n\nVill du forts√§tta?`)) {
                        try {
                            // üîí SOFT DELETE: Markera som inaktiv ist√§llet f√∂r att radera
                            const { error } = await supabaseClient
                                .from('classes')
                                .update({
                                    is_active: false,
                                    archived_at: new Date().toISOString(),
                                    archived_reason: 'Arkiverad via anv√§ndargr√§nssnitt'
                                })
                                .eq('id', classId);
                            
                            if (error) throw error;
                            
                            await Promise.all([
                                fetchClasses(),
                                fetchStudents(),
                                fetchClassCourseMappings()
                            ]);
                            
                            updateUI();
                            updateUIBasedOnRole();
                            await loadWarningsData();
                            showSuccessNotification(`${className} har arkiverats`);
                        } catch (error) {
                            showError('Kunde inte arkivera klass: ' + error.message);
                        }
                    }
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-class-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!userCan('manage_classes')) {
                        showError('Du har inte beh√∂righet att redigera klasser.');
                        return;
                    }
                    
                    const classId = btn.dataset.id;
                    openEditClassForm(classId);
                });
            });
        }
        
        // Function to open the class edit form
        function openEditClassForm(classId) {
            if (!userCan('manage_classes')) return;
            
            // Get class data
            const classToEdit = classes.find(c => c.id === classId);
            if (!classToEdit) return;
            
            // Set form values
            editClassId.value = classId;
            editClassName.value = classToEdit.name;
            
            // Populate courses
            renderEditClassCourses(classId);
            
            // Show form
            editClassFormContainer.classList.remove('hidden');
            editClassName.focus();
        }

        // Function to render courses for class editing
        function renderEditClassCourses(classId) {
            editClassCoursesContainer.innerHTML = '';
            
            if (courses.length === 0) {
                editClassCoursesContainer.innerHTML = `
                    <p class="text-sm text-gray-500 dark:text-gray-400 p-2">
                        Inga kurser skapade √§n. Skapa f√∂rst kurser p√• "Kurser"-fliken.
                    </p>
                `;
                return;
            }
            
            // Get courses already linked to this class
            const linkedCourseIds = classCourseMappings
                .filter(mapping => mapping.class_id === classId)
                .map(mapping => mapping.course_id);
            
            // Render all courses with checkboxes
            courses.forEach(course => {
                const isLinked = linkedCourseIds.includes(course.id);
                
                const div = document.createElement('div');
                div.className = 'flex items-center mb-2';
                div.innerHTML = `
                    <input type="checkbox" id="edit-class-course-${course.id}" value="${course.id}" 
                           class="edit-class-course-checkbox mr-2" ${isLinked ? 'checked' : ''}>
                    <label for="edit-class-course-${course.id}" class="text-sm">
                        ${course.code} - ${course.name}
                    </label>
                `;
                editClassCoursesContainer.appendChild(div);
            });
        }

        // Function to update class
        async function updateClass(classId, className, courseIds) {
            if (!userCan('manage_classes')) {
                showError('Du har inte beh√∂righet att uppdatera klasser.');
                return;
            }
            
            try {
                // Update class name
                const { error: classError } = await supabaseClient
                    .from('classes')
                    .update({ name: className })
                    .eq('id', classId);
                
                if (classError) throw classError;
                
                // Get existing course mappings
                const { data: existingMappings, error: mappingsError } = await supabaseClient
                    .from('course_class')
                    .select('*')
                    .eq('class_id', classId);
                
                if (mappingsError) throw mappingsError;
                
                // Determine which mappings to add and remove
                const existingCourseIds = existingMappings.map(m => m.course_id);
                const coursesToAdd = courseIds.filter(id => !existingCourseIds.includes(id));
                const coursesToRemove = existingCourseIds.filter(id => !courseIds.includes(id));
                
                // Remove old mappings
                if (coursesToRemove.length > 0) {
                    for (const courseId of coursesToRemove) {
                        const { error: removeError } = await supabaseClient
                            .from('course_class')
                            .delete()
                            .eq('class_id', classId)
                            .eq('course_id', courseId);
                        
                        if (removeError) throw removeError;
                    }
                }
                
                // Add new mappings
                if (coursesToAdd.length > 0) {
                    const newMappings = coursesToAdd.map(courseId => ({
                        class_id: classId,
                        course_id: courseId
                    }));
                    
                    const { error: addError } = await supabaseClient
                        .from('course_class')
                        .insert(newMappings);
                    
                    if (addError) throw addError;
                }
                
                // Refresh data
                await Promise.all([
                    fetchClasses(),
                    fetchClassCourseMappings()
                ]);
                
                updateUI();
                updateUIBasedOnRole();
                editClassFormContainer.classList.add('hidden');
                
            } catch (error) {
                showError('Kunde inte uppdatera klass: ' + error.message);
            }
        }
        
        function renderCourseClassCheckboxes() {
            courseClassesContainer.innerHTML = '';
            
            if (classes.length === 0) {
                courseClassesContainer.innerHTML = `
                    <p class="text-sm text-gray-500 dark:text-gray-400 p-2">
                        Inga klasser skapade √§n. Skapa f√∂rst klasser p√• "Klasser"-fliken.
                    </p>
                `;
                return;
            }
            
            classes.forEach(c => {
                const div = document.createElement('div');
                div.className = 'flex items-center mb-2';
                div.innerHTML = `
                    <input type="checkbox" id="class-${c.id}" value="${c.id}" class="course-class-checkbox mr-2">
                    <label for="class-${c.id}" class="text-sm">${c.name}</label>
                `;
                courseClassesContainer.appendChild(div);
            });
        }
        
        function renderCourses() {
            coursesContainer.innerHTML = '';
            
            if (courses.length === 0) {
                coursesContainer.innerHTML = `
                    <div class="col-span-full py-4 text-center text-gray-500 dark:text-gray-400">
                        Inga kurser skapade √§n. ${userCan('manage_courses') ? 'Anv√§nd knappen "L√§gg till kurs" f√∂r att skapa en kurs.' : ''}
                    </div>
                `;
                return;
            }

            // Build lookups
            const courseIdToClassIds = new Map();
            const courseIdToClassNames = new Map();
            classCourseMappings.forEach(mapping => {
                const ids = courseIdToClassIds.get(mapping.course_id) || [];
                const names = courseIdToClassNames.get(mapping.course_id) || [];
                ids.push(mapping.class_id);
                const cls = classes.find(c => c.id === mapping.class_id);
                if (cls) names.push(cls.name);
                courseIdToClassIds.set(mapping.course_id, ids);
                courseIdToClassNames.set(mapping.course_id, names);
            });

            // Count F-betyg and F-varningar separately
            const fCountByCourseId = new Map();
            const fWarningCountByCourseId = new Map();
            
            grades.forEach(g => {
                if (g.grade === 'F') {
                    if (g.grade_type === 'warning') {
                        fWarningCountByCourseId.set(g.course_id, (fWarningCountByCourseId.get(g.course_id) || 0) + 1);
                    } else {
                        fCountByCourseId.set(g.course_id, (fCountByCourseId.get(g.course_id) || 0) + 1);
                    }
                }
            });

            // Apply filters
            let filtered = [...courses];
            if (courseFilters.search) {
                filtered = filtered.filter(c =>
                    (c.name && c.name.toLowerCase().includes(courseFilters.search)) ||
                    (c.code && c.code.toLowerCase().includes(courseFilters.search))
                );
            }
            if (courseFilters.classId) {
                filtered = filtered.filter(c => (courseIdToClassIds.get(c.id) || []).includes(courseFilters.classId));
            }
            if (courseFilters.fOnly) {
                filtered = filtered.filter(c => {
                    const fCount = fCountByCourseId.get(c.id) || 0;
                    const fWarningCount = fWarningCountByCourseId.get(c.id) || 0;
                    return (fCount + fWarningCount) > 0;
                });
            }
            if (courseFilters.onlyFavorites) {
                filtered = filtered.filter(c => favoriteCourseIds.has(c.id));
            }

            // Sort
            const collator = new Intl.Collator('sv');
            filtered.sort((a, b) => {
                const aF = fCountByCourseId.get(a.id) || 0;
                const bF = fCountByCourseId.get(b.id) || 0;
                const aFWarning = fWarningCountByCourseId.get(a.id) || 0;
                const bFWarning = fWarningCountByCourseId.get(b.id) || 0;
                const aTotalF = aF + aFWarning;
                const bTotalF = bF + bFWarning;
                const aClasses = (courseIdToClassIds.get(a.id) || []).length;
                const bClasses = (courseIdToClassIds.get(b.id) || []).length;
                switch (courseFilters.sortBy) {
                    case 'name_desc':
                        return collator.compare(b.name || '', a.name || '');
                    case 'code_asc':
                        return collator.compare(a.code || '', b.code || '');
                    case 'code_desc':
                        return collator.compare(b.code || '', a.code || '');
                    case 'f_desc':
                        return bTotalF - aTotalF;
                    case 'f_asc':
                        return aTotalF - bTotalF;
                    case 'classes_desc':
                        return bClasses - aClasses;
                    case 'classes_asc':
                        return aClasses - bClasses;
                    case 'name_asc':
                    default:
                        return collator.compare(a.name || '', b.name || '');
                }
            });

            // Render
            filtered.forEach(c => {
                const courseClasses = courseIdToClassNames.get(c.id) || [];
                const courseFGrades = fCountByCourseId.get(c.id) || 0;
                const courseFWarnings = fWarningCountByCourseId.get(c.id) || 0;
                const isFav = favoriteCourseIds.has(c.id);
                const starStyle = isFav ? 'fas fa-star text-yellow-400' : 'far fa-star text-gray-300 dark:text-gray-600';

                const courseCard = document.createElement('div');
                courseCard.className = 'card rounded-lg shadow p-4';

                const deleteBtns = userCan('manage_courses') ? `
                    <div class="mt-3 flex justify-end">
                        <button class="delete-course-btn text-red-500 hover:text-red-700 text-sm flex items-center" data-id="${c.id}">
                            <i class="fas fa-trash-alt mr-1"></i> Ta bort
                        </button>
                    </div>
                ` : '';

                // Create clickable badges for F-betyg and F-varningar
                let badgesHTML = '';
                if (courseFGrades > 0) {
                    badgesHTML += `<button class="warning-badge course-f-badge hover:opacity-80 transition-opacity cursor-pointer" 
                                           data-course-id="${c.id}" 
                                           data-grade-type="grade" 
                                           title="Klicka f√∂r att se elevlista">
                                       ${courseFGrades} F
                                   </button>`;
                }
                if (courseFWarnings > 0) {
                    badgesHTML += `<button class="warning-badge-orange ml-2 course-f-badge hover:opacity-80 transition-opacity cursor-pointer" 
                                           data-course-id="${c.id}" 
                                           data-grade-type="warning" 
                                           title="Klicka f√∂r att se elevlista">
                                       ${courseFWarnings} ‚ö†Ô∏è
                                   </button>`;
                }

                courseCard.innerHTML = `
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-book text-indigo-500 mr-2"></i>
                        ${c.name}
                        <button class="favorite-course-btn ml-auto" data-id="${c.id}" aria-pressed="${isFav}">
                            <i class="${starStyle} text-lg"></i>
                        </button>
                    </h3>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${c.code}</div>
                    <div class="mt-2">
                        <div class="text-sm font-medium mb-1 flex justify-between items-center">
                            <span>Klasser:</span>
                            <div class="flex items-center">${badgesHTML}</div>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            ${courseClasses.length > 0 ? courseClasses.join(', ') : 'Inga klasser tilldelade'}
                        </div>
                    </div>
                    ${deleteBtns}
                `;
                coursesContainer.appendChild(courseCard);
            });

            // Favorite toggle handlers
            document.querySelectorAll('.favorite-course-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    if (favoriteCourseIds.has(id)) {
                        favoriteCourseIds.delete(id);
                    } else {
                        favoriteCourseIds.add(id);
                    }
                    saveFavoriteCourses();
                    renderCourses();
                });
            });
            
            // Course F-badge click handlers (show student list modal)
            document.querySelectorAll('.course-f-badge').forEach(btn => {
                btn.addEventListener('click', () => {
                    const courseId = btn.dataset.courseId;
                    const gradeType = btn.dataset.gradeType;
                    showCourseStudentsModal(courseId, gradeType);
                });
            });

            // Delete handlers (now Archive)
            document.querySelectorAll('.delete-course-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!userCan('manage_courses')) {
                        showError('Du har inte beh√∂righet att arkivera kurser.');
                        return;
                    }
                    
                    const courseId = btn.dataset.id;
                    const course = courses.find(c => c.id === courseId);
                    const courseName = course ? course.name : 'kursen';
                    
                    if (confirm(`‚ö†Ô∏è Arkivera ${courseName}?\n\n‚úÖ Kursen kommer att d√∂ljas fr√•n aktiv vy\n‚úÖ ALL historik och betyg bevaras\n‚úÖ Du kan √•teraktivera kursen senare om det beh√∂vs\n\nVill du forts√§tta?`)) {
                        try {
                            // üîí SOFT DELETE: Markera som inaktiv ist√§llet f√∂r att radera
                            const { error } = await supabaseClient
                                .from('courses')
                                .update({
                                    is_active: false,
                                    archived_at: new Date().toISOString(),
                                    archived_reason: 'Arkiverad via anv√§ndargr√§nssnitt'
                                })
                                .eq('id', courseId);
                            if (error) throw error;
                            await Promise.all([
                                fetchCourses(),
                                fetchClassCourseMappings(),
                                fetchGrades(),
                                fetchGradeHistory()
                            ]);
                            updateUI();
                            updateUIBasedOnRole();
                            await loadWarningsData();
                            showSuccessNotification(`${courseName} har arkiverats`);
                        } catch (error) {
                            showError('Kunde inte arkivera kurs: ' + error.message);
                        }
                    }
                });
            });
        }
        
        // Global variables for course students modal
        let currentCourseStudents = [];
        let currentCourseName = '';
        let currentCourseCode = '';
        let currentGradeTypeName = '';
        
        // Show course students modal
        function showCourseStudentsModal(courseId, gradeType) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            // Get students with F or F-warning for this course
            const courseGrades = grades.filter(g => 
                g.course_id === courseId && 
                g.grade === 'F' && 
                (gradeType === 'grade' ? g.grade_type !== 'warning' : g.grade_type === 'warning')
            );
            
            // Get student details
            const studentsList = courseGrades.map(g => {
                const student = students.find(s => s.id === g.student_id);
                const classObj = student ? classes.find(c => c.id === student.class_id) : null;
                return {
                    name: student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd elev',
                    className: classObj ? classObj.name : '-',
                    updatedAt: new Date(g.updated_at)
                };
            }).sort((a, b) => a.name.localeCompare(b.name));
            
            // Store for PDF export
            currentCourseStudents = studentsList;
            currentCourseName = course.name;
            currentCourseCode = course.code;
            currentGradeTypeName = gradeType === 'grade' ? 'F-betyg' : 'F-varningar';
            
            // Update modal content
            document.getElementById('modal-course-name').textContent = course.name;
            document.getElementById('modal-course-code').textContent = course.code;
            
            const titleIcon = gradeType === 'grade' 
                ? '<i class="fas fa-clipboard-check mr-2 text-red-600"></i>' 
                : '<i class="fas fa-exclamation-triangle mr-2 text-orange-600"></i>';
            const titleText = gradeType === 'grade' ? 'Elever med F-betyg' : 'Elever med F-varningar';
            document.getElementById('modal-grade-type-title').innerHTML = `${titleIcon}${titleText}`;
            
            document.getElementById('modal-student-count').textContent = 
                `${studentsList.length} ${studentsList.length === 1 ? 'elev' : 'elever'}`;
            
            // Populate student list
            const listContainer = document.getElementById('course-students-list');
            listContainer.innerHTML = '';
            
            if (studentsList.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>Inga elever hittades</p>
                    </div>
                `;
            } else {
                studentsList.forEach((student, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-md mb-2 ' + (gradeType === 'grade' 
                        ? 'bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500' 
                        : 'bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-500');
                    
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-700 dark:text-gray-300 mr-2">${index + 1}.</span>
                                <div>
                                    <div class="font-medium">${student.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Klass: ${student.className}</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                ${student.updatedAt.toLocaleDateString('sv-SE')}
                            </div>
                        </div>
                    `;
                    
                    listContainer.appendChild(div);
                });
            }
            
            // Show modal
            document.getElementById('course-students-modal').classList.remove('hidden');
        }
        
        // Export course students to PDF
        function exportCourseStudentsToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.text(currentCourseName, 20, 20);
                
                // Add course code
                doc.setFontSize(12);
                doc.text(`Kurskod: ${currentCourseCode}`, 20, 30);
                
                // Add grade type
                doc.setFontSize(14);
                doc.text(currentGradeTypeName, 20, 40);
                
                // Add date
                doc.setFontSize(10);
                doc.text(`Genererad: ${new Date().toLocaleDateString('sv-SE')}`, 20, 50);
                
                // Add student count
                doc.text(`Antal elever: ${currentCourseStudents.length}`, 20, 60);
                
                // Add student list
                let yPos = 75;
                doc.setFontSize(11);
                
                currentCourseStudents.forEach((student, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const line = `${index + 1}. ${student.name} (${student.className})`;
                    doc.text(line, 25, yPos);
                    yPos += 8;
                });
                
                // Save PDF
                const fileName = `${currentCourseCode}_${currentGradeTypeName.replace('-', '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showSuccessNotification('PDF har exporterats!');
            } catch (error) {
                handleError(error, 'PDF-export');
            }
        }
        
        function renderStudents(filterClassId = '') {
            studentsContainer.innerHTML = '';
            
            let filteredStudents = students;
            
            if (filterClassId) {
                filteredStudents = students.filter(s => s.class_id === filterClassId);
            }
            
            if (filteredStudents.length === 0) {
                studentsContainer.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-5 text-center text-gray-500 dark:text-gray-400">
                            Inga elever hittades${filterClassId ? ' i den valda klassen' : ''}. 
                            ${userCan('manage_students') ? 'Anv√§nd knappen "L√§gg till elev" f√∂r att skapa en elev.' : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredStudents.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-gray-200 dark:border-gray-700';
                
                const className = s.classes ? s.classes.name : '-';
                
                // Count F-betyg and F-varningar separately for this student
                const studentFGrades = grades.filter(g => 
                    g.student_id === s.id && 
                    g.grade === 'F' && 
                    g.grade_type !== 'warning'
                ).length;
                
                const studentFWarnings = grades.filter(g => 
                    g.student_id === s.id && 
                    g.grade === 'F' && 
                    g.grade_type === 'warning'
                ).length;
                
                // Create badges HTML
                let badgesHTML = '';
                if (studentFGrades > 0) {
                    badgesHTML += `<span class="warning-badge ml-2">${studentFGrades} F</span>`;
                }
                if (studentFWarnings > 0) {
                    badgesHTML += `<span class="warning-badge-orange ml-2">${studentFWarnings} ‚ö†Ô∏è</span>`;
                }
                
                // Create actions column based on user role
                const actionsCol = userCan('manage_students') ? `
                    <td class="px-4 py-3 text-sm text-right">
                        <button class="delete-student-btn text-red-500 hover:text-red-700 flex items-center ml-auto" data-id="${s.id}">
                            <i class="fas fa-trash-alt mr-1"></i> Ta bort
                        </button>
                    </td>
                ` : `<td></td>`;
                
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm">
                        ${s.first_name}
                        ${badgesHTML}
                    </td>
                    <td class="px-4 py-3 text-sm">${s.last_name}</td>
                    <td class="px-4 py-3 text-sm">${className}</td>
                    ${actionsCol}
                `;
                studentsContainer.appendChild(tr);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-student-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!userCan('manage_students')) {
                        showError('Du har inte beh√∂righet att arkivera elever.');
                        return;
                    }
                    
                    const studentId = btn.dataset.id;
                    const student = students.find(s => s.id === studentId);
                    const studentName = student ? `${student.first_name} ${student.last_name}` : 'eleven';
                    
                    if (confirm(`‚ö†Ô∏è Arkivera ${studentName}?\n\n‚úÖ Eleven kommer att d√∂ljas fr√•n aktiv vy\n‚úÖ ALL historik och betyg bevaras\n‚úÖ Du kan √•teraktivera eleven senare om det beh√∂vs\n\nVill du forts√§tta?`)) {
                        try {
                            // üîí SOFT DELETE: Markera som inaktiv ist√§llet f√∂r att radera
                            const { error } = await supabaseClient
                                .from('students')
                                .update({
                                    is_active: false,
                                    archived_at: new Date().toISOString(),
                                    archived_reason: 'Arkiverad via anv√§ndargr√§nssnitt'
                                })
                                .eq('id', studentId);
                            
                            if (error) throw error;
                            
                            await Promise.all([
                                fetchStudents(),
                                fetchGrades(),
                                fetchGradeHistory()
                            ]);
                            
                            renderStudents(filterClass.value);
                            await loadWarningsData();
                            showSuccessNotification(`${studentName} har arkiverats`);
                        } catch (error) {
                            showError('Kunde inte arkivera elev: ' + error.message);
                        }
                    }
                });
            });
        }
        
        // Shared grade helpers (used by Grades tab + Student modal)
        async function upsertGradeForStudentCourse(studentId, courseId, grade, gradeType = 'grade') {
            if (!userCan('manage_grades')) {
                throw new Error('Du har inte beh√∂righet att s√§tta/√§ndra betyg.');
            }
            
            if (!studentId || !courseId || !grade) {
                throw new Error('Ogiltiga parametrar f√∂r betygs√§ttning.');
            }
            
            // Find existing grade in local cache
            const existingGrade = grades.find(g => g.student_id === studentId && g.course_id === courseId);
            
            if (existingGrade) {
                // Check if grade is changing from F to something else (create/update improvement record)
                if (existingGrade.grade === 'F' && grade !== 'F') {
                    const { data: existingImprovement, error: checkError } = await supabaseClient
                        .from('grade_history')
                        .select('id, to_grade')
                        .eq('student_id', studentId)
                        .eq('course_id', courseId)
                        .eq('quarter_id', activeQuarter ? activeQuarter.id : null)
                        .eq('from_grade', 'F')
                        .maybeSingle();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        console.error('Error checking existing improvement:', checkError);
                    }
                    
                    if (existingImprovement) {
                        const { error: updateError } = await supabaseClient
                            .from('grade_history')
                            .update({
                                to_grade: grade,
                                created_at: new Date().toISOString()
                            })
                            .eq('id', existingImprovement.id);
                        
                        if (updateError) {
                            console.error('Kunde inte uppdatera betygsutveckling:', updateError);
                        }
                    } else {
                        // Create new improvement record with snapshots
                        const student = students.find(s => s.id === studentId);
                        const course = courses.find(c => c.id === courseId);
                        const studentClass = student ? classes.find(cl => cl.id === student.class_id) : null;
                        
                        const { error: historyError } = await supabaseClient
                            .from('grade_history')
                            .insert({
                                student_id: studentId,
                                course_id: courseId,
                                from_grade: 'F',
                                to_grade: grade,
                                quarter_id: activeQuarter ? activeQuarter.id : null,
                                teacher_id: currentUser ? currentUser.id : null,
                                change_type: 'improvement',
                                student_snapshot: student ? {
                                    first_name: student.first_name,
                                    last_name: student.last_name,
                                    class_id: student.class_id,
                                    class_name: studentClass ? studentClass.name : null
                                } : null,
                                course_snapshot: course ? {
                                    code: course.code,
                                    name: course.name
                                } : null
                            });
                        
                        if (historyError) {
                            console.error('Kunde inte spara betygsutveckling:', historyError);
                        }
                    }
                }
                
                // Determine change type
                const oldGrade = existingGrade.grade;
                let changeType = 'modified';
                if (oldGrade === 'F' && grade !== 'F') {
                    changeType = 'improvement';
                } else if (oldGrade !== 'F' && grade === 'F') {
                    changeType = 'decline';
                } else if (oldGrade !== grade) {
                    const gradeOrder = ['F', 'E', 'D', 'C', 'B', 'A'];
                    const oldIndex = gradeOrder.indexOf(oldGrade);
                    const newIndex = gradeOrder.indexOf(grade);
                    if (newIndex > oldIndex) changeType = 'improvement';
                    else if (newIndex < oldIndex) changeType = 'decline';
                }
                
                // Log the change BEFORE updating
                await logGradeChange(studentId, courseId, oldGrade, grade, changeType, gradeType);
                
                const { error: updateError } = await supabaseClient
                    .from('grades')
                    .update({
                        grade,
                        grade_type: gradeType,
                        updated_at: new Date().toISOString(),
                        teacher_id: currentUser ? currentUser.id : null
                    })
                    .eq('id', existingGrade.id);
                
                if (updateError) throw updateError;
                return;
            }
            
            // No local grade found; double-check database (safety check)
            const { data: dbExistingGrade, error: checkError } = await supabaseClient
                .from('grades')
                .select('id, grade')
                .eq('student_id', studentId)
                .eq('course_id', courseId)
                .eq('quarter_id', activeQuarter ? activeQuarter.id : null)
                .maybeSingle();
            
            if (checkError && checkError.code !== 'PGRST116') {
                throw checkError;
            }
            
            if (dbExistingGrade) {
                const oldGrade = dbExistingGrade.grade;
                let changeType = 'modified';
                if (oldGrade === 'F' && grade !== 'F') {
                    changeType = 'improvement';
                } else if (oldGrade !== 'F' && grade === 'F') {
                    changeType = 'decline';
                } else if (oldGrade !== grade) {
                    const gradeOrder = ['F', 'E', 'D', 'C', 'B', 'A'];
                    const oldIndex = gradeOrder.indexOf(oldGrade);
                    const newIndex = gradeOrder.indexOf(grade);
                    if (newIndex > oldIndex) changeType = 'improvement';
                    else if (newIndex < oldIndex) changeType = 'decline';
                }
                
                await logGradeChange(studentId, courseId, oldGrade, grade, changeType, gradeType);
                
                const { error: updateError } = await supabaseClient
                    .from('grades')
                    .update({
                        grade,
                        grade_type: gradeType,
                        updated_at: new Date().toISOString(),
                        teacher_id: currentUser ? currentUser.id : null
                    })
                    .eq('id', dbExistingGrade.id);
                
                if (updateError) throw updateError;
                return;
            }
            
            // Insert new grade
            await logGradeChange(studentId, courseId, null, grade, 'new', gradeType);
            
            const { error: insertError } = await supabaseClient
                .from('grades')
                .insert({
                    student_id: studentId,
                    course_id: courseId,
                    grade,
                    grade_type: gradeType,
                    teacher_id: currentUser ? currentUser.id : null,
                    quarter_id: activeQuarter ? activeQuarter.id : null
                });
            
            if (insertError) throw insertError;
        }
        
        async function clearGradeForStudentCourse(studentId, courseId) {
            if (!userCan('manage_grades')) {
                throw new Error('Du har inte beh√∂righet att ta bort betyg.');
            }
            
            const existingGrade = grades.find(g => g.student_id === studentId && g.course_id === courseId);
            if (!existingGrade) return;
            
            await logGradeChange(studentId, courseId, existingGrade.grade, null, 'removed', existingGrade.grade_type || 'grade');
            
            const { error: deleteError } = await supabaseClient
                .from('grades')
                .delete()
                .eq('id', existingGrade.id);
            
            if (deleteError) throw deleteError;
        }
        
        async function renderGradeStudents() {
            gradeStudentsContainer.innerHTML = '';
            const selectedClassId = gradeClass.value;
            const selectedCourseId = gradeCourse.value;
            
            if (!selectedClassId || !selectedCourseId) {
                gradeStudentContainer.classList.add('hidden');
                return;
            }
            
            showLoading();
            
            try {
                // Get students in the selected class
                const classStudents = students.filter(s => s.class_id === selectedClassId);
                
                if (classStudents.length === 0) {
                    noStudentsMessage.classList.remove('hidden');
                    gradeStudentContainer.classList.remove('hidden');
                    return;
                }
                
                noStudentsMessage.classList.add('hidden');
                
                // Get existing grades for the selected course and students
                const existingGrades = {};
                grades.forEach(g => {
                    if (g.course_id === selectedCourseId) {
                        existingGrades[g.student_id] = g;
                    }
                });
                
                // Render students with their grades
                classStudents.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-t border-gray-200 dark:border-gray-700';
                    
                    const existingGrade = existingGrades[student.id] ? existingGrades[student.id].grade : null;
                    const existingGradeType = existingGrades[student.id] ? existingGrades[student.id].grade_type : null;
                    
                    // Create grade pills with appropriate classes based on user role
                    const gradePillsHTML = ['A', 'B', 'C', 'D', 'E', 'F'].map(grade => {
                        const isSelected = existingGrade === grade && existingGradeType === 'grade';
                        const baseClasses = `grade-pill px-3 py-1 rounded-md ${grade === 'F' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'} ${isSelected ? 'grade-pill-selected' : ''}`;
                        
                        // Add disabled classes if user can't manage grades
                        const disabledClasses = !userCan('manage_grades') ? 'opacity-50 cursor-not-allowed' : '';
                        
                        return `
                            <button 
                                class="${baseClasses} ${disabledClasses}"
                                data-student-id="${student.id}"
                                data-grade="${grade}"
                                data-grade-type="grade"
                                ${!userCan('manage_grades') ? 'disabled' : ''}>
                                ${grade}
                            </button>
                        `;
                    }).join('');
                    
                    // Create F-warning button
                    const isWarningSelected = existingGrade === 'F' && existingGradeType === 'warning';
                    const warningDisabledClasses = !userCan('manage_grades') ? 'opacity-50 cursor-not-allowed' : '';
                    const warningPillHTML = `
                        <button 
                            class="grade-pill grade-warning-pill px-3 py-1 rounded-md ${isWarningSelected ? 'grade-warning-pill-selected' : ''} ${warningDisabledClasses}"
                            data-student-id="${student.id}"
                            data-grade="F"
                            data-grade-type="warning"
                            ${!userCan('manage_grades') ? 'disabled' : ''}>
                            F-varning
                        </button>
                    `;
                    
                    // Create clear grade button (only show if student has a grade)
                    const clearButtonHTML = existingGrade ? `
                        <button 
                            class="clear-grade-btn px-3 py-1 rounded-md bg-gray-300 text-gray-700 dark:bg-gray-600 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-500 transition-all ${!userCan('manage_grades') ? 'opacity-50 cursor-not-allowed' : ''}"
                            data-student-id="${student.id}"
                            title="Ta bort betyg"
                            ${!userCan('manage_grades') ? 'disabled' : ''}>
                            <i class="fas fa-times mr-1"></i> Rensa
                        </button>
                    ` : '';
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm">${student.first_name}</td>
                        <td class="px-4 py-3 text-sm">${student.last_name}</td>
                        <td class="px-4 py-3">
                            <div class="flex justify-center space-x-2 flex-wrap gap-y-2">
                                ${gradePillsHTML}
                                <div class="w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                ${warningPillHTML}
                                ${clearButtonHTML}
                            </div>
                        </td>
                    `;
                    gradeStudentsContainer.appendChild(tr);
                });
                
                // Add event listeners to grade buttons only for users who can manage grades
                if (userCan('manage_grades')) {
                    gradeStudentsContainer.querySelectorAll('.grade-pill:not([disabled])').forEach(button => {
                        button.addEventListener('click', async () => {
                            const studentId = button.dataset.studentId;
                            const grade = button.dataset.grade;
                            const gradeType = button.dataset.gradeType || 'grade'; // Default to 'grade' if not specified
                            
                            try {
                                await upsertGradeForStudentCourse(studentId, selectedCourseId, grade, gradeType);
                                
                                // Update local state
                                await Promise.all([
                                    fetchGrades(),
                                    fetchGradeHistory()
                                ]);
                                
                                // Update UI
                                renderGradeStudents();
                                
                                // Update warnings data
                                await loadWarningsData();
                            } catch (error) {
                                showError('Kunde inte s√§tta betyg: ' + error.message);
                            }
                        });
                    });
                    
                    // Add event listeners to "Rensa" (clear grade) buttons
                    gradeStudentsContainer.querySelectorAll('.clear-grade-btn:not([disabled])').forEach(button => {
                        button.addEventListener('click', async () => {
                            const studentId = button.dataset.studentId;
                            
                            // Confirm before deleting
                            if (!confirm('√Ñr du s√§ker p√• att du vill ta bort betyget f√∂r denna elev?')) {
                                return;
                            }
                            
                            try {
                                await clearGradeForStudentCourse(studentId, selectedCourseId);
                                
                                await Promise.all([
                                    fetchGrades(),
                                    fetchGradeHistory()
                                ]);
                                
                                renderGradeStudents();
                                await loadWarningsData();
                                
                                showSuccessNotification('Betyg har tagits bort');
                            } catch (error) {
                                showError('Kunde inte ta bort betyg: ' + error.message);
                            }
                        });
                    });
                }
                
                gradeStudentContainer.classList.remove('hidden');
            } catch (error) {
                showError('Kunde inte ladda elever: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function updateGradeCourses() {
            const selectedClassId = gradeClass.value;
            
            if (!selectedClassId) {
                gradeCourse.innerHTML = '<option value="">V√§lj kurs</option>';
                gradeCourse.disabled = true;
                gradeStudentContainer.classList.add('hidden');
                return;
            }
            
            // Find course mappings for the selected class
            const classCourseIds = classCourseMappings
                .filter(mapping => mapping.class_id === selectedClassId)
                .map(mapping => mapping.course_id);
            
            // Get course details
            const classCourses = courses.filter(course => classCourseIds.includes(course.id));
            
            // Update the course dropdown
            gradeCourse.innerHTML = '<option value="">V√§lj kurs</option>';
            
            classCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.code} - ${course.name}`;
                gradeCourse.appendChild(option);
            });
            
            gradeCourse.disabled = classCourses.length === 0;
            
            if (classCourses.length === 0) {
                // If no mappings found, show all courses as fallback
                console.log('No course mappings found, showing all courses as fallback');
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.code} - ${course.name}`;
                    gradeCourse.appendChild(option);
                });
                showWarningNotification('Inga kursmappningar hittades f√∂r denna klass. Visar alla kurser.');
                gradeCourse.disabled = false;
            } else {
                gradeCourse.disabled = false;
            }
        }
        
        // F-Warnings & Analysis functions
        async function loadWarningsData(classFilter = '', courseFilter = '') {
            showLoading();
            
            try {
                // Filter F grades based on filters and active grade type
                let fGrades = grades.filter(g => {
                    if (g.grade !== 'F') return false;
                    
                    // Apply grade type filter
                    if (activeGradeTypeFilter === 'grades' && g.grade_type === 'warning') return false;
                    if (activeGradeTypeFilter === 'warnings' && g.grade_type !== 'warning') return false;
                    // 'both' shows everything
                    
                    return true;
                });
                
                // Apply class filter if provided
                if (classFilter) {
                    const studentIdsInClass = students
                        .filter(s => s.class_id === classFilter)
                        .map(s => s.id);
                    
                    fGrades = fGrades.filter(g => studentIdsInClass.includes(g.student_id));
                }
                
                // Apply course filter if provided
                if (courseFilter) {
                    fGrades = fGrades.filter(g => g.course_id === courseFilter);
                }
                
                // Get unique students with F grades
                const studentIdsWithF = [...new Set(fGrades.map(g => g.student_id))];
                
                // Statistics calculations
                totalFCount.textContent = fGrades.length;
                studentsWithF.textContent = studentIdsWithF.length;
                
                // Find worst course (most F grades)
                const courseFCounts = {};
                fGrades.forEach(g => {
                    courseFCounts[g.course_id] = (courseFCounts[g.course_id] || 0) + 1;
                });
                
                let worstCourseId = null;
                let worstCourseCount = 0;
                
                Object.entries(courseFCounts).forEach(([courseId, count]) => {
                    if (count > worstCourseCount) {
                        worstCourseId = courseId;
                        worstCourseCount = count;
                    }
                });
                
                if (worstCourseId) {
                    const course = courses.find(c => c.id === worstCourseId);
                    worstCourse.textContent = course ? `${course.name} (${worstCourseCount} F)` : '-';
                } else {
                    worstCourse.textContent = '-';
                }
                
                // Find worst class (most F grades)
                const classFCounts = {};
                
                fGrades.forEach(g => {
                    const student = students.find(s => s.id === g.student_id);
                    if (student && student.class_id) {
                        classFCounts[student.class_id] = (classFCounts[student.class_id] || 0) + 1;
                    }
                });
                
                let worstClassId = null;
                let worstClassCount = 0;
                
                Object.entries(classFCounts).forEach(([classId, count]) => {
                    if (count > worstClassCount) {
                        worstClassId = classId;
                        worstClassCount = count;
                    }
                });
                
                if (worstClassId) {
                    const classObj = classes.find(c => c.id === worstClassId);
                    worstClass.textContent = classObj ? `${classObj.name} (${worstClassCount} F)` : '-';
                } else {
                    worstClass.textContent = '-';
                }
                
                // Render warnings table
                renderWarningsTable(fGrades);
                
                // Update charts
                updateCharts();
            } catch (error) {
                showError('Kunde inte ladda data f√∂r F-varningar: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Progress analysis functions
        async function loadProgressData() {
            showLoading();
            
            try {
                // Get latest improvements (from F to any other grade) for the active quarter
                let improvements = gradeHistory.filter(h => h.from_grade === 'F');
                
                // Filter by active quarter if one is set
                if (activeQuarter && activeQuarter.id) {
                    improvements = improvements.filter(h => h.quarter_id === activeQuarter.id);
                    console.log(`Filtering progress data for active quarter: ${activeQuarter.name}`);
                    
                    // Update the quarter info text
                    const progressQuarterInfo = document.getElementById('progress-active-quarter');
                    if (progressQuarterInfo) {
                        progressQuarterInfo.textContent = activeQuarter.name;
                    }
                } else {
                    console.log('No active quarter set, showing all progress data');
                    
                    // Update the quarter info text
                    const progressQuarterInfo = document.getElementById('progress-active-quarter');
                    if (progressQuarterInfo) {
                        progressQuarterInfo.textContent = 'Alla kvartal (inget aktivt kvartal)';
                    }
                }
                
                // Update progress summary
                totalImprovements.textContent = improvements.length;
                
                // Get unique students with improvements
                const uniqueStudentImprovements = [...new Set(improvements.map(i => i.student_id))];
                studentsWithImprovements.textContent = uniqueStudentImprovements.length;
                
                // Find most improved course
                const courseImprovements = {};
                improvements.forEach(i => {
                    courseImprovements[i.course_id] = (courseImprovements[i.course_id] || 0) + 1;
                });
                
                let mostImprovedCourseId = null;
                let mostImprovedCount = 0;
                
                Object.entries(courseImprovements).forEach(([courseId, count]) => {
                    if (count > mostImprovedCount) {
                        mostImprovedCourseId = courseId;
                        mostImprovedCount = count;
                    }
                });
                
                if (mostImprovedCourseId) {
                    const course = courses.find(c => c.id === mostImprovedCourseId);
                    mostImprovedCourse.textContent = course ? `${course.name} (${mostImprovedCount} f√∂rb√§ttringar)` : '-';
                } else {
                    mostImprovedCourse.textContent = '-';
                }
                
                // Render progress table
                renderProgressTable(improvements);
                
                // Update progress charts
                updateProgressCharts(improvements);
            } catch (error) {
                showError('Kunde inte ladda utvecklingsdata: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function renderProgressTable(improvements) {
            progressContainer.innerHTML = '';
            
            if (improvements.length === 0) {
                progressContainer.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-5 text-center text-gray-500 dark:text-gray-400">
                            Inga betygsutvecklingar hittades f√∂r det valda kvartalet.
                        </td>
                    </tr>
                `;
                noProgressMessage.classList.remove('hidden');
                return;
            }
            
            noProgressMessage.classList.add('hidden');
            
            // Sort improvements by date (most recent first)
            improvements.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Render the table rows
            improvements.forEach(improvement => {
                const student = students.find(s => s.id === improvement.student_id);
                if (!student) return;
                
                const classObj = classes.find(c => c.id === student.class_id);
                const course = courses.find(c => c.id === improvement.course_id);
                
                const tr = document.createElement('tr');
                tr.className = 'border-t border-gray-200 dark:border-gray-700';
                
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm">
                        <span class="student-name" data-student-id="${student.id}">
                            ${student.first_name} ${student.last_name}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${classObj ? classObj.name : '-'}</td>
                    <td class="px-4 py-3 text-sm">${course ? `${course.code} - ${course.name}` : '-'}</td>
                    <td class="px-4 py-3 text-center text-sm">
                        <span class="progress-pill progress-negative">F</span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm">
                        <span class="progress-pill progress-positive">${improvement.to_grade}</span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400">
                        ${new Date(improvement.created_at).toLocaleDateString()}
                    </td>
                `;
                
                progressContainer.appendChild(tr);
            });
            
            // Add event listeners to student names
            document.querySelectorAll('.student-name').forEach(nameSpan => {
                nameSpan.addEventListener('click', () => {
                    const studentId = nameSpan.dataset.studentId;
                    showStudentDetailWithProgress(studentId);
                });
            });
        }
        
        function updateProgressCharts(improvements) {
            // Prepare data for class progress chart
            const classImprovements = {};
            
            improvements.forEach(i => {
                const student = students.find(s => s.id === i.student_id);
                if (student && student.class_id) {
                    const classObj = classes.find(c => c.id === student.class_id);
                    if (classObj) {
                        classImprovements[classObj.name] = (classImprovements[classObj.name] || 0) + 1;
                    }
                }
            });
            
            const classProgressLabels = Object.keys(classImprovements);
            const classProgressData = classProgressLabels.map(name => classImprovements[name]);
            
            // Prepare data for course progress chart
            const courseImprovements = {};
            
            improvements.forEach(i => {
                const course = courses.find(c => c.id === i.course_id);
                if (course) {
                    courseImprovements[course.name] = (courseImprovements[course.name] || 0) + 1;
                }
            });
            
            // Sort courses by improvement count (descending) and take top 10
            const courseProgressEntries = Object.entries(courseImprovements)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const courseProgressLabels = courseProgressEntries.map(e => e[0]);
            const courseProgressData = courseProgressEntries.map(e => e[1]);
            
            // Update class progress chart
            if (classProgressChart) {
                classProgressChart.data.labels = classProgressLabels;
                classProgressChart.data.datasets[0].data = classProgressData;
                classProgressChart.update();
            } else {
                const classProgressCtx = document.getElementById('class-progress-chart').getContext('2d');
                classProgressChart = new Chart(classProgressCtx, {
                type: 'bar',
                data: {
                    labels: classProgressLabels,
                    datasets: [{
                        label: 'Antal f√∂rb√§ttringar fr√•n F',
                        data: classProgressData,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        },
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    }
                }
            });
            }
            
            // Update course progress chart
            if (courseProgressChart) {
                courseProgressChart.data.labels = courseProgressLabels;
                courseProgressChart.data.datasets[0].data = courseProgressData;
                courseProgressChart.update();
            } else {
            
            const courseProgressCtx = document.getElementById('course-progress-chart').getContext('2d');
            courseProgressChart = new Chart(courseProgressCtx, {
                type: 'bar',
                data: {
                    labels: courseProgressLabels,
                    datasets: [{
                        label: 'Antal f√∂rb√§ttringar fr√•n F',
                        data: courseProgressData,
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        },
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    }
                }
            });
            }
        }
        
        function showStudentDetailWithProgress(studentId) {
            // Get student data
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const classObj = classes.find(c => c.id === student.class_id);
            const className = classObj ? classObj.name : '-';
            
            // Get F-grades (actual grades)
            const studentFGrades = grades.filter(g => 
                g.student_id === studentId && 
                g.grade === 'F' && 
                g.grade_type !== 'warning'
            );
            
            // Get F-warnings
            const studentFWarnings = grades.filter(g => 
                g.student_id === studentId && 
                g.grade === 'F' && 
                g.grade_type === 'warning'
            );
            
            // Get student progress history
            const studentProgress = gradeHistory.filter(h => h.student_id === studentId);
            
            // Set modal content
            modalStudentName.textContent = `${student.first_name} ${student.last_name}`;
            modalStudentClass.textContent = className;
            
            // Create count display
            const totalCount = studentFGrades.length + studentFWarnings.length;
            const countText = activeGradeTypeFilter === 'both' 
                ? `${studentFGrades.length} F-betyg, ${studentFWarnings.length} F-varningar` 
                : totalCount;
            modalFCount.textContent = countText;
            
            // Populate courses with F grades and warnings
            modalFCourses.innerHTML = '';
            
            // Show F-betyg section
            if (studentFGrades.length > 0) {
                const fGradeHeader = document.createElement('div');
                fGradeHeader.className = 'font-semibold text-sm mb-2 mt-2';
                fGradeHeader.innerHTML = '<i class="fas fa-clipboard-check mr-2 text-red-600"></i>F-betyg';
                modalFCourses.appendChild(fGradeHeader);
                
                studentFGrades.forEach(grade => {
                    const course = courses.find(c => c.id === grade.course_id);
                    const teacherInfo = teachers[grade.teacher_id] || { name: 'Ok√§nd l√§rare', role: 'analyst' };
                    
                    if (course) {
                        const li = document.createElement('li');
                        li.className = 'p-2 rounded-md bg-red-50 dark:bg-red-900/20 mb-2';
                        
                        const roleBadgeHTML = `<span class="role-badge role-badge-${teacherInfo.role} text-xs ml-1">${teacherInfo.role.charAt(0).toUpperCase() + teacherInfo.role.slice(1)}</span>`;
                        
                        li.innerHTML = `
                            <div class="font-medium">${course.code} - ${course.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <span>L√§rare: ${teacherInfo.name} ${roleBadgeHTML}</span>
                                <span class="ml-3">Datum: ${new Date(grade.updated_at).toLocaleDateString()}</span>
                            </div>
                        `;
                        modalFCourses.appendChild(li);
                    }
                });
            }
            
            // Show F-warnings section
            if (studentFWarnings.length > 0) {
                const fWarningHeader = document.createElement('div');
                fWarningHeader.className = 'font-semibold text-sm mb-2 mt-3';
                fWarningHeader.innerHTML = '<i class="fas fa-exclamation-triangle mr-2 text-orange-600"></i>F-varningar';
                modalFCourses.appendChild(fWarningHeader);
                
                studentFWarnings.forEach(grade => {
                    const course = courses.find(c => c.id === grade.course_id);
                    const teacherInfo = teachers[grade.teacher_id] || { name: 'Ok√§nd l√§rare', role: 'analyst' };
                    
                    if (course) {
                        const li = document.createElement('li');
                        li.className = 'p-2 rounded-md bg-orange-50 dark:bg-orange-900/20 mb-2';
                        
                        const roleBadgeHTML = `<span class="role-badge role-badge-${teacherInfo.role} text-xs ml-1">${teacherInfo.role.charAt(0).toUpperCase() + teacherInfo.role.slice(1)}</span>`;
                        
                        li.innerHTML = `
                            <div class="font-medium">‚ö†Ô∏è ${course.code} - ${course.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <span>L√§rare: ${teacherInfo.name} ${roleBadgeHTML}</span>
                                <span class="ml-3">Datum: ${new Date(grade.updated_at).toLocaleDateString()}</span>
                            </div>
                        `;
                        modalFCourses.appendChild(li);
                    }
                });
            }
            
            // Show message if no grades or warnings
            if (studentFGrades.length === 0 && studentFWarnings.length === 0) {
                modalFCourses.innerHTML = `
                    <li class="p-2 text-sm text-gray-500 dark:text-gray-400">
                        Inga F-betyg eller F-varningar i nuvarande kvartal.
                    </li>
                `;
            }
            
            // Populate grade editing section (all course grades for this student)
            if (modalGradeEditNote) {
                if (!userCan('manage_grades')) {
                    modalGradeEditNote.textContent = 'Du har inte beh√∂righet att √§ndra betyg.';
                } else {
                    modalGradeEditNote.textContent = 'Klicka p√• ett betyg f√∂r att s√§tta/√§ndra. "Rensa" tar bort betyget.';
                }
            }
            
            if (modalGradeCourses) {
                // Only show courses where the student currently has F or F-varning (nuvarande kvartal)
                const studentGradesAll = grades.filter(g => g.student_id === studentId);
                const studentFOnlyGrades = studentGradesAll.filter(g => g.grade === 'F'); // includes both grade + warning via grade_type
                
                const relevantCourseIdSet = new Set(studentFOnlyGrades.map(g => g.course_id));
                const relevantCourses = courses
                    .filter(c => relevantCourseIdSet.has(c.id))
                    .sort((a, b) => (a.code || a.name).localeCompare(b.code || b.name));
                
                // Map existing grades by course
                const existingByCourse = {};
                studentFOnlyGrades.forEach(g => {
                    existingByCourse[g.course_id] = g;
                });
                
                modalGradeCourses.innerHTML = '';
                
                if (relevantCourses.length === 0) {
                    modalGradeCourses.innerHTML = `
                        <div class="p-2 text-sm text-gray-500 dark:text-gray-400">
                            Inga F-betyg eller F-varningar att √§ndra i nuvarande kvartal.
                        </div>
                    `;
                } else {
                    relevantCourses.forEach(course => {
                        const existing = existingByCourse[course.id] || null;
                        const existingGrade = existing ? existing.grade : null;
                        const existingGradeType = existing ? (existing.grade_type || 'grade') : null;
                        
                        const canEdit = userCan('manage_grades');
                        const disabledClasses = !canEdit ? 'opacity-50 cursor-not-allowed' : '';
                        const disabledAttr = !canEdit ? 'disabled' : '';
                        
                        const gradePillsHTML = ['A', 'B', 'C', 'D', 'E', 'F'].map(g => {
                            const isSelected = existingGrade === g && existingGradeType === 'grade';
                            const baseClasses = `grade-pill modal-grade-pill px-2.5 py-1 rounded-md text-sm ${g === 'F' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'} ${isSelected ? 'grade-pill-selected' : ''}`;
                            return `
                                <button
                                    class="${baseClasses} ${disabledClasses}"
                                    data-student-id="${studentId}"
                                    data-course-id="${course.id}"
                                    data-grade="${g}"
                                    data-grade-type="grade"
                                    ${disabledAttr}>
                                    ${g}
                                </button>
                            `;
                        }).join('');
                        
                        const isWarningSelected = existingGrade === 'F' && existingGradeType === 'warning';
                        const warningPillHTML = `
                            <button
                                class="grade-pill modal-grade-pill grade-warning-pill px-2.5 py-1 rounded-md text-sm ${isWarningSelected ? 'grade-warning-pill-selected' : ''} ${disabledClasses}"
                                data-student-id="${studentId}"
                                data-course-id="${course.id}"
                                data-grade="F"
                                data-grade-type="warning"
                                ${disabledAttr}>
                                F-varning
                            </button>
                        `;
                        
                        const clearButtonHTML = existingGrade ? `
                            <button
                                class="modal-clear-grade-btn px-2.5 py-1 rounded-md text-sm bg-gray-300 text-gray-700 dark:bg-gray-600 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-500 transition-all ${disabledClasses}"
                                data-student-id="${studentId}"
                                data-course-id="${course.id}"
                                title="Ta bort betyg"
                                ${disabledAttr}>
                                <i class="fas fa-times mr-1"></i> Rensa
                            </button>
                        ` : '';
                        
                        const row = document.createElement('div');
                        row.className = 'p-2 rounded-md bg-gray-50 dark:bg-gray-800';
                        row.innerHTML = `
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                <div class="font-medium text-sm">${course.code} - ${course.name}</div>
                                <div class="flex flex-wrap items-center gap-2">
                                    ${gradePillsHTML}
                                    <span class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></span>
                                    ${warningPillHTML}
                                    ${clearButtonHTML}
                                </div>
                            </div>
                        `;
                        
                        modalGradeCourses.appendChild(row);
                    });
                    
                    // Bind events (scoped to modal)
                    if (userCan('manage_grades')) {
                        modalGradeCourses.querySelectorAll('.modal-grade-pill:not([disabled])').forEach(button => {
                            button.addEventListener('click', async () => {
                                const sId = button.dataset.studentId;
                                const cId = button.dataset.courseId;
                                const newGrade = button.dataset.grade;
                                const newGradeType = button.dataset.gradeType || 'grade';
                                
                                try {
                                    await upsertGradeForStudentCourse(sId, cId, newGrade, newGradeType);
                                    
                                    await Promise.all([
                                        fetchGrades(),
                                        fetchGradeHistory()
                                    ]);
                                    
                                    await loadWarningsData();
                                    
                                    // Refresh modal content with updated grades
                                    showStudentDetailWithProgress(studentId);
                                    
                                    showSuccessNotification('Betyg uppdaterat');
                                } catch (error) {
                                    showError('Kunde inte s√§tta betyg: ' + error.message);
                                }
                            });
                        });
                        
                        modalGradeCourses.querySelectorAll('.modal-clear-grade-btn:not([disabled])').forEach(button => {
                            button.addEventListener('click', async () => {
                                const sId = button.dataset.studentId;
                                const cId = button.dataset.courseId;
                                
                                if (!confirm('√Ñr du s√§ker p√• att du vill ta bort betyget f√∂r denna kurs?')) return;
                                
                                try {
                                    await clearGradeForStudentCourse(sId, cId);
                                    
                                    await Promise.all([
                                        fetchGrades(),
                                        fetchGradeHistory()
                                    ]);
                                    
                                    await loadWarningsData();
                                    
                                    showStudentDetailWithProgress(studentId);
                                    showSuccessNotification('Betyg har tagits bort');
                                } catch (error) {
                                    showError('Kunde inte ta bort betyg: ' + error.message);
                                }
                            });
                        });
                    }
                }
            }
            
            // Populate progress history
            if (studentProgress.length > 0) {
                modalStudentProgress.innerHTML = '';
                noStudentProgress.classList.add('hidden');
                modalStudentProgress.classList.remove('hidden');
                
                // Sort progress by date (most recent first)
                studentProgress.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                studentProgress.forEach(progress => {
                    const course = courses.find(c => c.id === progress.course_id);
                    const quarter = quarters.find(q => q.id === progress.quarter_id);
                    
                    const li = document.createElement('li');
                    li.className = 'p-2 rounded-md bg-gray-50 dark:bg-gray-800';
                    
                    li.innerHTML = `
                        <div class="font-medium">${course ? `${course.code} - ${course.name}` : 'Ok√§nd kurs'}</div>
                        <div class="flex items-center mt-1">
                            <span class="progress-pill progress-negative mr-2">F</span>
                            <i class="fas fa-arrow-right text-green-500 mx-2"></i>
                            <span class="progress-pill progress-positive">${progress.to_grade}</span>
                            <span class="ml-3 text-sm text-gray-500 dark:text-gray-400">
                                ${quarter ? quarter.name : 'Ok√§nt kvartal'}
                                <span class="ml-2">${new Date(progress.created_at).toLocaleDateString()}</span>
                            </span>
                        </div>
                    `;
                    
                    modalStudentProgress.appendChild(li);
                });
            } else {
                noStudentProgress.classList.remove('hidden');
                modalStudentProgress.classList.add('hidden');
            }
            
            // Show modal
            studentDetailModal.classList.remove('hidden');
        }
        
        // Quarters management
        function renderQuartersList() {
            quartersList.innerHTML = '';
            
            if (quarters.length === 0) {
                quartersList.innerHTML = `
                    <div class="py-4 text-center text-gray-500 dark:text-gray-400">
                        Inga kvartal skapade √§n. ${userCan('manage_quarters') ? 'Anv√§nd knappen "L√§gg till kvartal" f√∂r att skapa ett kvartal.' : ''}
                    </div>
                `;
                return;
            }
            
            // Sort quarters by date (newest first)
            quarters.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            quarters.forEach(quarter => {
                const div = document.createElement('div');
                div.className = 'border-b border-gray-200 dark:border-gray-700 pb-4 mb-4 last:border-0 last:mb-0 last:pb-0';
                
                // Format creation date
                const createdAt = new Date(quarter.created_at).toLocaleDateString();
                
                // Create buttons for admin actions
                const adminButtons = userCan('manage_quarters') ? `
                    <div class="flex space-x-2 mt-2">
                        <button class="set-active-quarter-btn text-white bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded text-xs ${quarter.is_active ? 'opacity-50 cursor-not-allowed' : ''}" 
                                data-id="${quarter.id}" ${quarter.is_active ? 'disabled' : ''}>
                            S√§tt som aktivt
                        </button>
                        <button class="delete-quarter-btn text-white bg-red-500 hover:bg-red-600 px-2 py-1 rounded text-xs"
                                data-id="${quarter.id}">
                            Ta bort
                        </button>
                    </div>
                ` : '';
                
                div.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="font-medium flex items-center">
                                ${quarter.name}
                                ${quarter.is_active ? '<span class="ml-2 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 text-xs font-medium px-2 py-0.5 rounded">Aktivt</span>' : ''}
                            </h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${quarter.description || 'Ingen beskrivning'}</p>
                            <div class="text-xs text-gray-400 dark:text-gray-500 mt-1">Skapad: ${createdAt}</div>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                
                quartersList.appendChild(div);
            });
            
            // Add event listeners for quarter management buttons
            if (userCan('manage_quarters')) {
                // Set active quarter button
                document.querySelectorAll('.set-active-quarter-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const quarterId = btn.dataset.id;
                        await setActiveQuarter(quarterId);
                    });
                });
                
                // Delete quarter button
                document.querySelectorAll('.delete-quarter-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const quarterId = btn.dataset.id;
                        const quarter = quarters.find(q => q.id === quarterId);
                        
                        if (quarter && quarter.is_active) {
                            showError('Du kan inte ta bort det aktiva kvartalet. S√§tt ett annat kvartal som aktivt f√∂rst.');
                            return;
                        }
                        
                        if (confirm(`√Ñr du s√§ker p√• att du vill ta bort kvartal ${quarter ? quarter.name : ''}? Detta p√•verkar inte historiska betyg.`)) {
                            await deleteQuarter(quarterId);
                        }
                    });
                });
            }
        }
        
        async function setActiveQuarter(quarterId) {
            // Debug logging
            console.log('Current userRole:', userRole);
            console.log('Can manage quarters:', userCan('manage_quarters'));
            
            if (!userCan('manage_quarters')) {
                showError(`Du har inte beh√∂righet att hantera kvartal. Din roll: ${userRole || 'ok√§nd'}`);
                return;
            }
            
            showLoading();
            
            try {
                // üîí SNAPSHOT: Skapa snapshot av nuvarande aktivt kvartal innan byte
                const currentActiveQuarter = quarters.find(q => q.is_active);
                if (currentActiveQuarter && currentActiveQuarter.id !== quarterId) {
                    console.log(`Skapar snapshot f√∂r kvartal: ${currentActiveQuarter.name}`);
                    
                    try {
                        // Anv√§nd den SQL-funktion vi skapade i databasen
                        const { data: snapshotResult, error: snapshotError } = await supabaseClient
                            .rpc('create_quarter_snapshot', {
                                p_quarter_id: currentActiveQuarter.id,
                                p_user_id: currentUser.id
                            });
                        
                        if (snapshotError) {
                            console.error('Kunde inte skapa snapshot:', snapshotError);
                            // Varning men forts√§tt √§nd√•
                            showError(`Varning: Snapshot kunde inte skapas f√∂r ${currentActiveQuarter.name}`);
                        } else {
                            console.log('Snapshot skapad med ID:', snapshotResult);
                            
                            // M√§rk som automatisk snapshot genom att uppdatera notes
                            await supabaseClient
                                .from('quarter_snapshots')
                                .update({ 
                                    notes: `ü§ñ Automatisk snapshot vid kvartalsbyte\n\nSkapad automatiskt n√§r kvartal byttes fr√•n ${currentActiveQuarter.name} till nytt kvartal.` 
                                })
                                .eq('id', snapshotResult);
                        }
                    } catch (snapshotErr) {
                        console.error('Exception vid snapshot:', snapshotErr);
                        // Forts√§tt trots fel
                    }
                }
                
                // First set all quarters to not active
                const { error: resetError } = await supabaseClient
                    .from('quarters')
                    .update({ is_active: false })
                    .neq('id', quarterId); // Update all except the one we're about to activate
                
                if (resetError) throw resetError;
                
                // Then set the selected quarter as active
                const { error: updateError } = await supabaseClient
                    .from('quarters')
                    .update({ is_active: true })
                    .eq('id', quarterId);
                
                if (updateError) throw updateError;
                
                // Refresh quarters data
                await fetchQuarters();
                
                // Refresh grades data for the active quarter
                await fetchGrades();
                
                // Update the UI
                renderQuartersList();
                await loadWarningsData();
                updateDashboardWidgets();
                
                const newQuarterName = quarters.find(q => q.id === quarterId)?.name || 'nytt kvartal';
                showSuccessNotification(`Aktivt kvartal har uppdaterats till ${newQuarterName}${currentActiveQuarter ? ` (snapshot skapad f√∂r ${currentActiveQuarter.name})` : ''}.`);
            } catch (error) {
                handleError(error, 'Kvartaluppdatering');
            } finally {
                hideLoading();
            }
        }
        
        async function deleteQuarter(quarterId) {
            if (!userCan('manage_quarters')) {
                showError('Du har inte beh√∂righet att hantera kvartal.');
                return;
            }
            
            showLoading();
            
            try {
                // Check if this quarter has associated grades
                const { data: quarterGrades, error: gradesError } = await supabaseClient
                    .from('grades')
                    .select('id')
                    .eq('quarter_id', quarterId);
                
                if (gradesError) throw gradesError;
                
                if (quarterGrades && quarterGrades.length > 0) {
                    showError(`Detta kvartal har ${quarterGrades.length} betyg kopplade till sig. Ta bort betygen f√∂rst eller arkivera kvartalet ist√§llet.`);
                    return;
                }
                
                // Delete the quarter
                const { error: deleteError } = await supabaseClient
                    .from('quarters')
                    .delete()
                    .eq('id', quarterId);
                
                if (deleteError) throw deleteError;
                
                // Refresh quarters data
                await fetchQuarters();
                
                // Update the UI
                renderQuartersList();
                
                showError('Kvartalet har tagits bort.');
            } catch (error) {
                showError('Ett fel intr√§ffade n√§r kvartalet skulle tas bort: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // üîí ARCHIVE RENDER FUNCTIONS
        async function renderArchivedStudents() {
            const container = document.getElementById('archived-students-container');
            const countElement = document.getElementById('archived-students-count');
            
            if (!container) return;
            
            container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Laddar...</div>';
            
            await fetchArchivedStudents();
            
            countElement.textContent = archivedStudents.length;
            
            if (archivedStudents.length === 0) {
                container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Inga arkiverade elever</div>';
                return;
            }
            
            container.innerHTML = '';
            
            archivedStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';
                
                const archivedDate = student.archived_at ? new Date(student.archived_at).toLocaleDateString('sv-SE') : 'Ok√§nt datum';
                const className = student.classes ? student.classes.name : 'Ingen klass';
                
                div.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium">${student.first_name} ${student.last_name}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${className}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            Arkiverad: ${archivedDate}
                            ${student.archived_reason ? `<br>Anledning: ${student.archived_reason}` : ''}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="reactivate-student-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-id="${student.id}">
                            <i class="fas fa-undo mr-1"></i> √Öteraktivera
                        </button>
                        <button class="permanent-delete-student-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" data-id="${student.id}">
                            <i class="fas fa-trash mr-1"></i> Radera permanent
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Add event listeners
            document.querySelectorAll('.reactivate-student-btn').forEach(btn => {
                btn.addEventListener('click', () => reactivateStudent(btn.dataset.id));
            });
            
            document.querySelectorAll('.permanent-delete-student-btn').forEach(btn => {
                btn.addEventListener('click', () => permanentDeleteStudent(btn.dataset.id));
            });
        }
        
        async function renderArchivedCourses() {
            const container = document.getElementById('archived-courses-container');
            const countElement = document.getElementById('archived-courses-count');
            
            if (!container) return;
            
            container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Laddar...</div>';
            
            await fetchArchivedCourses();
            
            countElement.textContent = archivedCourses.length;
            
            if (archivedCourses.length === 0) {
                container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Inga arkiverade kurser</div>';
                return;
            }
            
            container.innerHTML = '';
            
            archivedCourses.forEach(course => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';
                
                const archivedDate = course.archived_at ? new Date(course.archived_at).toLocaleDateString('sv-SE') : 'Ok√§nt datum';
                
                div.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium">${course.name}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Kurskod: ${course.code}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            Arkiverad: ${archivedDate}
                            ${course.archived_reason ? `<br>Anledning: ${course.archived_reason}` : ''}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="reactivate-course-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-id="${course.id}">
                            <i class="fas fa-undo mr-1"></i> √Öteraktivera
                        </button>
                        <button class="permanent-delete-course-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" data-id="${course.id}">
                            <i class="fas fa-trash mr-1"></i> Radera permanent
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Add event listeners
            document.querySelectorAll('.reactivate-course-btn').forEach(btn => {
                btn.addEventListener('click', () => reactivateCourse(btn.dataset.id));
            });
            
            document.querySelectorAll('.permanent-delete-course-btn').forEach(btn => {
                btn.addEventListener('click', () => permanentDeleteCourse(btn.dataset.id));
            });
        }
        
        async function renderArchivedClasses() {
            const container = document.getElementById('archived-classes-container');
            const countElement = document.getElementById('archived-classes-count');
            
            if (!container) return;
            
            container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Laddar...</div>';
            
            await fetchArchivedClasses();
            
            countElement.textContent = archivedClasses.length;
            
            if (archivedClasses.length === 0) {
                container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Inga arkiverade klasser</div>';
                return;
            }
            
            container.innerHTML = '';
            
            archivedClasses.forEach(classObj => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';
                
                const archivedDate = classObj.archived_at ? new Date(classObj.archived_at).toLocaleDateString('sv-SE') : 'Ok√§nt datum';
                
                div.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium">${classObj.name}</h4>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            Arkiverad: ${archivedDate}
                            ${classObj.archived_reason ? `<br>Anledning: ${classObj.archived_reason}` : ''}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="reactivate-class-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-id="${classObj.id}">
                            <i class="fas fa-undo mr-1"></i> √Öteraktivera
                        </button>
                        <button class="permanent-delete-class-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" data-id="${classObj.id}">
                            <i class="fas fa-trash mr-1"></i> Radera permanent
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Add event listeners
            document.querySelectorAll('.reactivate-class-btn').forEach(btn => {
                btn.addEventListener('click', () => reactivateClass(btn.dataset.id));
            });
            
            document.querySelectorAll('.permanent-delete-class-btn').forEach(btn => {
                btn.addEventListener('click', () => permanentDeleteClass(btn.dataset.id));
            });
        }
        
        // üîí BULK ARCHIVE & SEARCH FUNCTIONS
        async function bulkArchiveClass() {
            if (classes.length === 0) {
                showError('Inga klasser tillg√§ngliga.');
                return;
            }
            
            // Create a simple selection dialog
            const classOptions = classes.map((c, index) => {
                const studentsInClass = students.filter(s => s.class_id === c.id);
                return `${index + 1}. ${c.name} (${studentsInClass.length} elever)`;
            }).join('\n');
            
            const selection = prompt(`V√§lj klass att arkivera (skriv nummer):\n\n${classOptions}\n\nAnge nummer:`);
            
            if (!selection) return;
            
            const classIndex = parseInt(selection) - 1;
            if (isNaN(classIndex) || classIndex < 0 || classIndex >= classes.length) {
                showError('Ogiltigt val. F√∂rs√∂k igen.');
                return;
            }
            
            const selectedClass = classes[classIndex];
            const studentsInClass = students.filter(s => s.class_id === selectedClass.id);
            
            if (studentsInClass.length === 0) {
                showError('Inga elever hittades i den valda klassen.');
                return;
            }
            
            const confirmMsg = `‚ö†Ô∏è Arkivera hela ${selectedClass.name}?\n\n${studentsInClass.length} elever kommer att arkiveras:\n${studentsInClass.map(s => `- ${s.first_name} ${s.last_name}`).slice(0, 10).join('\n')}${studentsInClass.length > 10 ? `\n...och ${studentsInClass.length - 10} till` : ''}\n\n‚úÖ All historik bevaras\n‚úÖ Kan √•teraktiveras senare\n\nVill du forts√§tta?`;
            
            if (!confirm(confirmMsg)) return;
            
            showLoading();
            
            try {
                // Archive all students in class
                const { error } = await supabaseClient
                    .from('students')
                    .update({
                        is_active: false,
                        archived_at: new Date().toISOString(),
                        archived_reason: `Bulk-arkivering av klass ${selectedClass.name}`
                    })
                    .eq('class_id', selectedClass.id)
                    .eq('is_active', true);
                
                if (error) throw error;
                
                await fetchStudents();
                await renderArchivedStudents();
                renderStudents();
                await loadWarningsData();
                
                showSuccessNotification(`${studentsInClass.length} elever fr√•n ${selectedClass.name} har arkiverats!`);
            } catch (error) {
                showError('Kunde inte arkivera klassen: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function bulkReactivateArchivedStudents() {
            if (archivedStudents.length === 0) {
                showError('Inga arkiverade elever att √•teraktivera.');
                return;
            }
            
            if (!confirm(`Vill du √•teraktivera ALLA ${archivedStudents.length} arkiverade elever?\n\nAlla kommer att bli synliga igen i systemet.`)) {
                return;
            }
            
            showLoading();
            
            try {
                const studentIds = archivedStudents.map(s => s.id);
                
                const { error } = await supabaseClient
                    .from('students')
                    .update({
                        is_active: true,
                        archived_at: null,
                        archived_reason: null
                    })
                    .in('id', studentIds);
                
                if (error) throw error;
                
                await fetchStudents();
                await renderArchivedStudents();
                renderStudents();
                
                showSuccessNotification(`${studentIds.length} elever har √•teraktiverats!`);
            } catch (error) {
                showError('Kunde inte √•teraktivera elever: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Search in archive
        function searchArchivedStudents(searchTerm) {
            const container = document.getElementById('archived-students-container');
            if (!container) return;
            
            const filtered = archivedStudents.filter(student => {
                const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
                const className = student.classes ? student.classes.name.toLowerCase() : '';
                const search = searchTerm.toLowerCase();
                
                return fullName.includes(search) || className.includes(search);
            });
            
            // Re-render with filtered students
            container.innerHTML = '';
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Inga matchande elever hittades</div>';
                return;
            }
            
            filtered.forEach(student => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';
                
                const archivedDate = student.archived_at ? new Date(student.archived_at).toLocaleDateString('sv-SE') : 'Ok√§nt datum';
                const className = student.classes ? student.classes.name : 'Ingen klass';
                
                div.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium">${student.first_name} ${student.last_name}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${className}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            Arkiverad: ${archivedDate}
                            ${student.archived_reason ? `<br>Anledning: ${student.archived_reason}` : ''}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="reactivate-student-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-id="${student.id}">
                            <i class="fas fa-undo mr-1"></i> √Öteraktivera
                        </button>
                        <button class="permanent-delete-student-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" data-id="${student.id}">
                            <i class="fas fa-trash mr-1"></i> Radera permanent
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Re-add event listeners
            document.querySelectorAll('.reactivate-student-btn').forEach(btn => {
                btn.addEventListener('click', () => reactivateStudent(btn.dataset.id));
            });
            
            document.querySelectorAll('.permanent-delete-student-btn').forEach(btn => {
                btn.addEventListener('click', () => permanentDeleteStudent(btn.dataset.id));
            });
        }
        
        // üîí SNAPSHOT FUNCTIONS
        async function fetchSnapshots() {
            try {
                const { data, error } = await supabaseClient
                    .from('quarter_snapshots')
                    .select('*, quarters(name)')
                    .order('snapshot_date', { ascending: false });
                
                if (error) throw error;
                
                return data || [];
            } catch (error) {
                console.error('Kunde inte h√§mta snapshots:', error);
                showError('Kunde inte h√§mta snapshots: ' + error.message);
                return [];
            }
        }
        
        async function renderSnapshots() {
            const container = document.getElementById('snapshots-container');
            const countElement = document.getElementById('snapshots-count');
            const comparisonSection = document.getElementById('snapshot-comparison-section');
            
            if (!container) return;
            
            container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Laddar...</div>';
            
            const snapshots = await fetchSnapshots();
            
            countElement.textContent = snapshots.length;
            
            if (snapshots.length === 0) {
                container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic py-4 text-center">Inga snapshots sparade √§n. Snapshots skapas automatiskt n√§r du byter kvartal.</div>';
                comparisonSection.classList.add('hidden');
                return;
            }
            
            // Show comparison section if there are 2+ snapshots
            if (snapshots.length >= 2) {
                comparisonSection.classList.remove('hidden');
                populateSnapshotSelects(snapshots);
            }
            
            container.innerHTML = '';
            
            snapshots.forEach(snapshot => {
                const div = document.createElement('div');
                
                // Determine if manual or automatic snapshot
                const isManual = snapshot.notes && snapshot.notes.includes('(Manuell snapshot)');
                const isAuto = snapshot.notes && snapshot.notes.includes('Automatisk snapshot vid kvartalsbyte');
                
                // Extract clean name from notes if manual
                let displayName = '';
                if (isManual && snapshot.notes) {
                    const match = snapshot.notes.match(/üì∏\s+([^\n]+)/);
                    displayName = match ? match[1] : '';
                }
                
                div.className = `border ${isManual ? 'border-amber-300 dark:border-amber-700' : 'border-blue-300 dark:border-blue-700'} rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors`;
                
                const snapshotDate = new Date(snapshot.snapshot_date).toLocaleString('sv-SE');
                const quarterName = snapshot.quarters ? snapshot.quarters.name : 'Ok√§nt kvartal';
                const passRate = snapshot.pass_rate ? snapshot.pass_rate.toFixed(1) : '0';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 cursor-pointer" data-snapshot-id="${snapshot.id}" onclick="openSnapshotDetails('${snapshot.id}')">
                            <div class="flex items-center gap-2">
                                <h4 class="font-medium text-lg hover:text-primary-color transition-colors">${quarterName}</h4>
                                ${isManual ? '<span class="px-2 py-0.5 bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 text-xs rounded-full font-medium"><i class="fas fa-hand-pointer mr-1"></i>Manuell</span>' : isAuto ? '<span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-xs rounded-full font-medium"><i class="fas fa-robot mr-1"></i>Automatisk</span>' : ''}
                            </div>
                            ${isManual && displayName ? `<p class="text-sm font-medium text-amber-600 dark:text-amber-400 mt-1">${displayName}</p>` : ''}
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                <i class="fas fa-camera mr-1"></i> ${snapshotDate}
                                ${snapshot.locked ? '<span class="ml-2 text-amber-500"><i class="fas fa-lock"></i> L√•st</span>' : ''}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-green-600 dark:text-green-400">${passRate}%</div>
                            <div class="text-xs text-gray-500">Godk√§nda</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Elever</div>
                            <div class="text-lg font-semibold">${snapshot.total_students || 0}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Betyg</div>
                            <div class="text-lg font-semibold">${snapshot.total_grades || 0}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">F-betyg</div>
                            <div class="text-lg font-semibold text-red-600">${snapshot.total_f_grades || 0}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">F-varningar</div>
                            <div class="text-lg font-semibold text-amber-600">${snapshot.total_f_warnings || 0}</div>
                        </div>
                    </div>
                    
                    ${snapshot.notes ? `<div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">${snapshot.notes}</div>` : ''}
                    
                    <div class="flex gap-2 mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <button class="view-snapshot-details-btn flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm" data-snapshot-id="${snapshot.id}">
                            <i class="fas fa-chart-line mr-1"></i> Visa Detaljerad Analys
                        </button>
                        <button class="delete-snapshot-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm" data-snapshot-id="${snapshot.id}">
                            <i class="fas fa-trash mr-1"></i> Radera
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-snapshot-details-btn').forEach(btn => {
                btn.addEventListener('click', () => openSnapshotDetails(btn.dataset.snapshotId));
            });
            
            document.querySelectorAll('.delete-snapshot-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteSnapshot(btn.dataset.snapshotId));
            });
        }
        
        // üóëÔ∏è DELETE SNAPSHOT FUNCTION
        async function deleteSnapshot(snapshotId) {
            const snapshots = await fetchSnapshots();
            const snapshot = snapshots.find(s => s.id === snapshotId);
            const snapshotName = snapshot?.quarters?.name || 'snapshoten';
            
            if (!confirm(`‚ö†Ô∏è Radera snapshot?\n\nDu √§r p√• v√§g att radera snapshoten f√∂r ${snapshotName}.\n\nDetta g√•r inte att √•ngra!\n\nVill du forts√§tta?`)) {
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabaseClient
                    .from('quarter_snapshots')
                    .delete()
                    .eq('id', snapshotId);
                
                if (error) throw error;
                
                await renderSnapshots();
                showSuccessNotification('Snapshot har raderats!');
            } catch (error) {
                showError('Kunde inte radera snapshot: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // üìä SNAPSHOT DETAILS MODAL
        async function openSnapshotDetails(snapshotId) {
            showLoading();
            
            try {
                // Fetch the specific snapshot
                const { data: snapshot, error } = await supabaseClient
                    .from('quarter_snapshots')
                    .select('*, quarters(name)')
                    .eq('id', snapshotId)
                    .single();
                
                if (error) throw error;
                
                // Show the modal
                const modal = document.getElementById('snapshot-details-modal');
                if (!modal) {
                    console.error('Snapshot details modal not found');
                    return;
                }
                
                // Populate modal with data
                await populateSnapshotDetails(snapshot);
                
                modal.classList.remove('hidden');
            } catch (error) {
                showError('Kunde inte √∂ppna snapshot-detaljer: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function populateSnapshotDetails(snapshot) {
            // Extract data from snapshot
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            const classesData = snapshot.classes_snapshot || [];
            
            const isManual = snapshot.notes && snapshot.notes.includes('(Manuell snapshot)');
            let displayName = '';
            if (isManual && snapshot.notes) {
                const match = snapshot.notes.match(/üì∏\s+([^\n]+)/);
                displayName = match ? match[1] : '';
            }
            
            const quarterName = snapshot.quarters ? snapshot.quarters.name : 'Ok√§nt kvartal';
            const snapshotDate = new Date(snapshot.snapshot_date).toLocaleString('sv-SE');
            
            // Update header
            document.getElementById('snapshot-detail-title').innerHTML = `
                ${quarterName}
                ${isManual ? '<span class="ml-2 px-2 py-0.5 bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 text-xs rounded-full font-medium"><i class="fas fa-hand-pointer mr-1"></i>Manuell</span>' : '<span class="ml-2 px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-xs rounded-full font-medium"><i class="fas fa-robot mr-1"></i>Automatisk</span>'}
            `;
            
            document.getElementById('snapshot-detail-subtitle').textContent = `${isManual && displayName ? displayName + ' - ' : ''}${snapshotDate}`;
            
            // Overview stats
            const passRate = snapshot.pass_rate ? snapshot.pass_rate.toFixed(1) : '0';
            document.getElementById('snapshot-overview-stats').innerHTML = `
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="showSnapshotStudentsList('${snapshot.id}')">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Elever</div>
                        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">${snapshot.total_students || 0}</div>
                        <div class="text-xs text-gray-500 mt-1">Klicka f√∂r lista</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Totalt Betyg</div>
                        <div class="text-3xl font-bold">${snapshot.total_grades || 0}</div>
                        <div class="text-xs text-gray-500 mt-1">Alla betyg</div>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="showSnapshotFGradesList('${snapshot.id}', 'grade')">
                        <div class="text-sm text-gray-600 dark:text-gray-400">F-betyg</div>
                        <div class="text-3xl font-bold text-red-600 dark:text-red-400">${snapshot.total_f_grades || 0}</div>
                        <div class="text-xs text-gray-500 mt-1">Klicka f√∂r lista</div>
                    </div>
                    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="showSnapshotFGradesList('${snapshot.id}', 'warning')">
                        <div class="text-sm text-gray-600 dark:text-gray-400">F-varningar</div>
                        <div class="text-3xl font-bold text-amber-600 dark:text-amber-400">${snapshot.total_f_warnings || 0}</div>
                        <div class="text-xs text-gray-500 mt-1">Klicka f√∂r lista</div>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-green-600 dark:text-green-400">${passRate}%</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Godk√§nda betyg</div>
                    </div>
                </div>
            `;
            
            // Store snapshot data globally for detail views
            window.currentSnapshotData = snapshot;
            
            // Render course statistics
            renderSnapshotCourseStats(gradesData, coursesData);
            
            // Render class statistics
            renderSnapshotClassStats(gradesData, studentsData, classesData);
            
            // Add event listeners for export buttons
            const exportExcelBtn = document.getElementById('export-snapshot-excel-btn');
            const exportPdfBtn = document.getElementById('export-snapshot-pdf-btn');
            
            if (exportExcelBtn) {
                exportExcelBtn.onclick = () => exportSnapshotToExcel();
            }
            
            if (exportPdfBtn) {
                exportPdfBtn.onclick = () => exportSnapshotToPDF();
            }
        }
        
        // üìã RENDER COURSE STATS IN SNAPSHOT
        function renderSnapshotCourseStats(gradesData, coursesData) {
            const container = document.getElementById('snapshot-course-stats');
            if (!container) return;
            
            // Group grades by course
            const courseStats = {};
            gradesData.forEach(grade => {
                if (!courseStats[grade.course_id]) {
                    courseStats[grade.course_id] = {
                        total: 0,
                        f_grades: 0,
                        f_warnings: 0
                    };
                }
                courseStats[grade.course_id].total++;
                if (grade.grade === 'F' && grade.grade_type !== 'warning') {
                    courseStats[grade.course_id].f_grades++;
                }
                if (grade.grade === 'F' && grade.grade_type === 'warning') {
                    courseStats[grade.course_id].f_warnings++;
                }
            });
            
            // Sort courses by most F-grades
            const sortedCourses = Object.entries(courseStats)
                .sort((a, b) => b[1].f_grades - a[1].f_grades)
                .slice(0, 10); // Top 10
            
            if (sortedCourses.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm italic">Ingen kursdata tillg√§nglig</div>';
                return;
            }
            
            container.innerHTML = sortedCourses.map(([courseId, stats]) => {
                const course = coursesData.find(c => c.id === courseId);
                const courseName = course ? course.name : 'Ok√§nd kurs';
                const courseCode = course ? course.code : '';
                const passRate = stats.total > 0 ? (((stats.total - stats.f_grades) / stats.total) * 100).toFixed(1) : '0';
                
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer" onclick="showSnapshotCourseDetails('${courseId}')">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <h5 class="font-medium">${courseName}</h5>
                                <p class="text-xs text-gray-500">${courseCode}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm">
                                    <span class="font-semibold">${stats.total}</span> betyg
                                </div>
                                <div class="flex gap-2 text-xs mt-1">
                                    <span class="text-red-600 font-semibold">${stats.f_grades} F</span>
                                    ${stats.f_warnings > 0 ? `<span class="text-amber-600 font-semibold">${stats.f_warnings} ‚ö†Ô∏è</span>` : ''}
                                    <span class="text-green-600">${passRate}% godk√§nd</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // üìã RENDER CLASS STATS IN SNAPSHOT
        function renderSnapshotClassStats(gradesData, studentsData, classesData) {
            const container = document.getElementById('snapshot-class-stats');
            if (!container) return;
            
            // Group students by class
            const classGroups = {};
            studentsData.forEach(student => {
                if (!classGroups[student.class_id]) {
                    classGroups[student.class_id] = {
                        students: [],
                        total_grades: 0,
                        f_grades: 0,
                        f_warnings: 0
                    };
                }
                classGroups[student.class_id].students.push(student);
            });
            
            // Add grade statistics
            gradesData.forEach(grade => {
                const student = studentsData.find(s => s.id === grade.student_id);
                if (student && classGroups[student.class_id]) {
                    classGroups[student.class_id].total_grades++;
                    if (grade.grade === 'F' && grade.grade_type !== 'warning') {
                        classGroups[student.class_id].f_grades++;
                    }
                    if (grade.grade === 'F' && grade.grade_type === 'warning') {
                        classGroups[student.class_id].f_warnings++;
                    }
                }
            });
            
            const sortedClasses = Object.entries(classGroups)
                .sort((a, b) => b[1].f_grades - a[1].f_grades);
            
            if (sortedClasses.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm italic">Ingen klassdata tillg√§nglig</div>';
                return;
            }
            
            container.innerHTML = sortedClasses.map(([classId, stats]) => {
                const classObj = classesData.find(c => c.id === classId);
                const className = classObj ? classObj.name : 'Ok√§nd klass';
                const passRate = stats.total_grades > 0 ? (((stats.total_grades - stats.f_grades) / stats.total_grades) * 100).toFixed(1) : '0';
                
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer" onclick="showSnapshotClassDetails('${classId}')">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <h5 class="font-medium">${className}</h5>
                                <p class="text-xs text-gray-500">${stats.students.length} elever</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm">
                                    <span class="font-semibold">${stats.total_grades}</span> betyg
                                </div>
                                <div class="flex gap-2 text-xs mt-1">
                                    <span class="text-red-600 font-semibold">${stats.f_grades} F</span>
                                    ${stats.f_warnings > 0 ? `<span class="text-amber-600 font-semibold">${stats.f_warnings} ‚ö†Ô∏è</span>` : ''}
                                    <span class="text-green-600">${passRate}% godk√§nd</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // üìä SHOW F-GRADES LIST FROM SNAPSHOT
        function showSnapshotFGradesList(snapshotId, gradeType = 'grade') {
            const snapshot = window.currentSnapshotData;
            if (!snapshot) return;
            
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            
            // Filter F-grades by type
            const fGrades = gradesData.filter(g => {
                if (g.grade !== 'F') return false;
                if (gradeType === 'grade') return g.grade_type !== 'warning';
                if (gradeType === 'warning') return g.grade_type === 'warning';
                return true;
            });
            
            const listContainer = document.getElementById('snapshot-detail-list');
            const titleElement = document.getElementById('detail-list-title');
            const contentElement = document.getElementById('detail-list-content');
            
            titleElement.textContent = gradeType === 'warning' ? `F-varningar (${fGrades.length})` : `F-betyg (${fGrades.length})`;
            
            if (fGrades.length === 0) {
                contentElement.innerHTML = '<div class="text-gray-500 text-sm italic">Inga F-betyg hittades</div>';
                listContainer.classList.remove('hidden');
                return;
            }
            
            // Build table
            contentElement.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-800">
                            <tr>
                                <th class="px-3 py-2 text-left">Elev</th>
                                <th class="px-3 py-2 text-left">Klass</th>
                                <th class="px-3 py-2 text-left">Kurs</th>
                                <th class="px-3 py-2 text-center">Betyg</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${fGrades.map(grade => {
                                const student = studentsData.find(s => s.id === grade.student_id);
                                const course = coursesData.find(c => c.id === grade.course_id);
                                const studentClass = student ? classesData.find(cl => cl.id === student.class_id) : null;
                                
                                return `
                                    <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-3 py-2">${student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd'}</td>
                                        <td class="px-3 py-2">${studentClass ? studentClass.name : '-'}</td>
                                        <td class="px-3 py-2">${course ? course.name : 'Ok√§nd kurs'}</td>
                                        <td class="px-3 py-2 text-center">
                                            <span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded font-semibold">
                                                F${grade.grade_type === 'warning' ? ' ‚ö†Ô∏è' : ''}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            listContainer.classList.remove('hidden');
        }
        
        // üë®‚Äçüéì SHOW STUDENTS LIST WITH THEIR F-GRADES
        function showSnapshotStudentsList(snapshotId) {
            const snapshot = window.currentSnapshotData;
            if (!snapshot) return;
            
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            const classesData = snapshot.classes_snapshot || [];
            
            // Group F-grades by student
            const studentFGrades = {};
            gradesData.forEach(grade => {
                if (grade.grade === 'F') {
                    if (!studentFGrades[grade.student_id]) {
                        studentFGrades[grade.student_id] = {
                            grades: [],
                            warnings: []
                        };
                    }
                    if (grade.grade_type === 'warning') {
                        studentFGrades[grade.student_id].warnings.push(grade);
                    } else {
                        studentFGrades[grade.student_id].grades.push(grade);
                    }
                }
            });
            
            // Get students with F-grades sorted by number of F's
            const studentsWithF = Object.entries(studentFGrades)
                .map(([studentId, fData]) => {
                    const student = studentsData.find(s => s.id === studentId);
                    return {
                        student,
                        fCount: fData.grades.length,
                        warningCount: fData.warnings.length,
                        grades: fData.grades,
                        warnings: fData.warnings
                    };
                })
                .filter(item => item.student)
                .sort((a, b) => b.fCount - a.fCount);
            
            const listContainer = document.getElementById('snapshot-detail-list');
            const titleElement = document.getElementById('detail-list-title');
            const contentElement = document.getElementById('detail-list-content');
            
            titleElement.textContent = `Elever med F-betyg (${studentsWithF.length})`;
            
            if (studentsWithF.length === 0) {
                contentElement.innerHTML = '<div class="text-gray-500 text-sm italic">Inga elever med F-betyg</div>';
                listContainer.classList.remove('hidden');
                return;
            }
            
            contentElement.innerHTML = `
                <div class="space-y-3">
                    ${studentsWithF.map(item => {
                        const studentClass = classesData.find(c => c.id === item.student.class_id);
                        const className = studentClass ? studentClass.name : 'Ingen klass';
                        
                        const allFGrades = [...item.grades, ...item.warnings];
                        const coursesList = allFGrades.map(grade => {
                            const course = coursesData.find(c => c.id === grade.course_id);
                            const courseName = course ? course.name : 'Ok√§nd kurs';
                            const isWarning = grade.grade_type === 'warning';
                            return `<span class="inline-block px-2 py-1 ${isWarning ? 'bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300' : 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'} rounded text-xs mr-1 mb-1">${courseName}${isWarning ? ' ‚ö†Ô∏è' : ''}</span>`;
                        }).join('');
                        
                        return `
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 ${item.fCount >= 3 ? 'bg-red-50 dark:bg-red-900/10' : ''}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h5 class="font-medium">${item.student.first_name} ${item.student.last_name}</h5>
                                        <p class="text-sm text-gray-500">${className}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-red-600">${item.fCount}</div>
                                        <div class="text-xs text-gray-500">F-betyg</div>
                                        ${item.warningCount > 0 ? `<div class="text-sm text-amber-600 font-medium">${item.warningCount} varningar</div>` : ''}
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Kurser med F:</div>
                                    ${coursesList}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            listContainer.classList.remove('hidden');
            listContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // üìö SHOW COURSE DETAILS FROM SNAPSHOT
        function showSnapshotCourseDetails(courseId) {
            const snapshot = window.currentSnapshotData;
            if (!snapshot) return;
            
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            const classesData = snapshot.classes_snapshot || [];
            
            const course = coursesData.find(c => c.id === courseId);
            const courseName = course ? course.name : 'Ok√§nd kurs';
            
            const courseGrades = gradesData.filter(g => g.course_id === courseId);
            
            const listContainer = document.getElementById('snapshot-detail-list');
            const titleElement = document.getElementById('detail-list-title');
            const contentElement = document.getElementById('detail-list-content');
            
            titleElement.textContent = `${courseName} - Alla betyg (${courseGrades.length})`;
            
            // Grade distribution
            const gradeDist = {};
            courseGrades.forEach(grade => {
                const gradeKey = grade.grade + (grade.grade_type === 'warning' ? ' ‚ö†Ô∏è' : '');
                gradeDist[gradeKey] = (gradeDist[gradeKey] || 0) + 1;
            });
            
            contentElement.innerHTML = `
                <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h5 class="font-medium mb-2">Betygsf√∂rdelning:</h5>
                    <div class="flex flex-wrap gap-2">
                        ${Object.entries(gradeDist).map(([grade, count]) => `
                            <span class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">
                                <span class="font-semibold">${grade}</span>: ${count} st
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-800">
                            <tr>
                                <th class="px-3 py-2 text-left">Elev</th>
                                <th class="px-3 py-2 text-left">Klass</th>
                                <th class="px-3 py-2 text-center">Betyg</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${courseGrades.map(grade => {
                                const student = studentsData.find(s => s.id === grade.student_id);
                                const studentClass = student ? classesData.find(cl => cl.id === student.class_id) : null;
                                const gradeClass = grade.grade === 'F' ? 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300' : 
                                                    grade.grade === 'E' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300' :
                                                    'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
                                
                                return `
                                    <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-3 py-2">${student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd'}</td>
                                        <td class="px-3 py-2">${studentClass ? studentClass.name : '-'}</td>
                                        <td class="px-3 py-2 text-center">
                                            <span class="px-2 py-1 ${gradeClass} rounded font-semibold">
                                                ${grade.grade}${grade.grade_type === 'warning' ? ' ‚ö†Ô∏è' : ''}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            listContainer.classList.remove('hidden');
            listContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // üè´ SHOW CLASS DETAILS FROM SNAPSHOT
        function showSnapshotClassDetails(classId) {
            const snapshot = window.currentSnapshotData;
            if (!snapshot) return;
            
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            const classesData = snapshot.classes_snapshot || [];
            
            const classObj = classesData.find(c => c.id === classId);
            const className = classObj ? classObj.name : 'Ok√§nd klass';
            
            const studentsInClass = studentsData.filter(s => s.class_id === classId);
            
            const listContainer = document.getElementById('snapshot-detail-list');
            const titleElement = document.getElementById('detail-list-title');
            const contentElement = document.getElementById('detail-list-content');
            
            titleElement.textContent = `${className} - Elever (${studentsInClass.length})`;
            
            // Calculate stats per student
            const studentStats = studentsInClass.map(student => {
                const studentGrades = gradesData.filter(g => g.student_id === student.id);
                const fGrades = studentGrades.filter(g => g.grade === 'F' && g.grade_type !== 'warning');
                const fWarnings = studentGrades.filter(g => g.grade === 'F' && g.grade_type === 'warning');
                
                return {
                    student,
                    totalGrades: studentGrades.length,
                    fCount: fGrades.length,
                    warningCount: fWarnings.length,
                    fGrades,
                    fWarnings
                };
            }).sort((a, b) => b.fCount - a.fCount);
            
            contentElement.innerHTML = `
                <div class="space-y-3">
                    ${studentStats.map(stat => {
                        const allFGrades = [...stat.fGrades, ...stat.fWarnings];
                        const coursesList = allFGrades.length > 0 ? allFGrades.map(grade => {
                            const course = coursesData.find(c => c.id === grade.course_id);
                            const courseName = course ? course.name : 'Ok√§nd kurs';
                            const isWarning = grade.grade_type === 'warning';
                            return `<span class="inline-block px-2 py-1 ${isWarning ? 'bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300' : 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'} rounded text-xs mr-1 mb-1">${courseName}${isWarning ? ' ‚ö†Ô∏è' : ''}</span>`;
                        }).join('') : '<span class="text-gray-500 text-sm">Inga F-betyg</span>';
                        
                        return `
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 ${stat.fCount >= 3 ? 'bg-red-50 dark:bg-red-900/10' : ''}">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h5 class="font-medium">${stat.student.first_name} ${stat.student.last_name}</h5>
                                        <div class="text-xs text-gray-500 mt-1">
                                            ${stat.totalGrades} betyg totalt
                                            ${stat.fCount > 0 ? `<span class="ml-2 text-red-600 font-semibold">${stat.fCount} F-betyg</span>` : ''}
                                            ${stat.warningCount > 0 ? `<span class="ml-2 text-amber-600 font-semibold">${stat.warningCount} varningar</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ${allFGrades.length > 0 ? `
                                    <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">F-betyg i:</div>
                                        ${coursesList}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            listContainer.classList.remove('hidden');
            listContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // üì§ EXPORT SNAPSHOT TO EXCEL
        function exportSnapshotToExcel() {
            const snapshot = window.currentSnapshotData;
            if (!snapshot) {
                showError('Ingen snapshot att exportera');
                return;
            }
            
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            const classesData = snapshot.classes_snapshot || [];
            
            const quarterName = snapshot.quarters ? snapshot.quarters.name : 'Snapshot';
            const snapshotDate = new Date(snapshot.snapshot_date).toLocaleDateString('sv-SE');
            
            // Prepare data for Excel
            const excelData = gradesData.map(grade => {
                const student = studentsData.find(s => s.id === grade.student_id);
                const course = coursesData.find(c => c.id === grade.course_id);
                const studentClass = student ? classesData.find(cl => cl.id === student.class_id) : null;
                
                return {
                    'Elev': student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd',
                    'Klass': studentClass ? studentClass.name : '-',
                    'Kurs': course ? course.name : 'Ok√§nd kurs',
                    'Kurskod': course ? course.code : '-',
                    'Betyg': grade.grade,
                    'Typ': grade.grade_type === 'warning' ? 'Varning' : 'Betyg'
                };
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Betyg');
            
            // Add summary sheet
            const summary = [
                { 'Statistik': 'Kvartal', 'V√§rde': quarterName },
                { 'Statistik': 'Datum', 'V√§rde': snapshotDate },
                { 'Statistik': 'Totalt elever', 'V√§rde': snapshot.total_students || 0 },
                { 'Statistik': 'Totalt betyg', 'V√§rde': snapshot.total_grades || 0 },
                { 'Statistik': 'F-betyg', 'V√§rde': snapshot.total_f_grades || 0 },
                { 'Statistik': 'F-varningar', 'V√§rde': snapshot.total_f_warnings || 0 },
                { 'Statistik': 'Godk√§nd %', 'V√§rde': snapshot.pass_rate ? snapshot.pass_rate.toFixed(1) + '%' : '0%' }
            ];
            
            const ws_summary = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws_summary, 'Sammanfattning');
            
            // Download
            const fileName = `Snapshot_${quarterName.replace(/\s+/g, '_')}_${snapshotDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccessNotification('Snapshot exporterad till Excel!');
        }
        
        // üìÑ EXPORT SNAPSHOT TO PDF
        function exportSnapshotToPDF() {
            const snapshot = window.currentSnapshotData;
            if (!snapshot) {
                showError('Ingen snapshot att exportera');
                return;
            }
            
            const gradesData = snapshot.grades_snapshot || [];
            const studentsData = snapshot.students_snapshot || [];
            const coursesData = snapshot.courses_snapshot || [];
            const classesData = snapshot.classes_snapshot || [];
            
            const quarterName = snapshot.quarters ? snapshot.quarters.name : 'Snapshot';
            const snapshotDate = new Date(snapshot.snapshot_date).toLocaleString('sv-SE');
            const isManual = snapshot.notes && snapshot.notes.includes('(Manuell snapshot)');
            let displayName = '';
            if (isManual && snapshot.notes) {
                const match = snapshot.notes.match(/üì∏\s+([^\n]+)/);
                displayName = match ? match[1] : '';
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            
            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(`Snapshot: ${quarterName}`, 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            if (isManual && displayName) {
                doc.text(displayName, 20, yPos);
                yPos += 7;
            }
            doc.text(`${snapshotDate} - ${isManual ? 'Manuell' : 'Automatisk'} snapshot`, 20, yPos);
            yPos += 15;
            
            // Summary stats
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Sammanfattning:', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Totalt elever: ${snapshot.total_students || 0}`, 20, yPos);
            yPos += 7;
            doc.text(`Totalt betyg: ${snapshot.total_grades || 0}`, 20, yPos);
            yPos += 7;
            doc.text(`F-betyg: ${snapshot.total_f_grades || 0}`, 20, yPos);
            yPos += 7;
            doc.text(`F-varningar: ${snapshot.total_f_warnings || 0}`, 20, yPos);
            yPos += 7;
            doc.text(`Godk√§nd %: ${snapshot.pass_rate ? snapshot.pass_rate.toFixed(1) : '0'}%`, 20, yPos);
            yPos += 15;
            
            // Course statistics
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Top 10 Kurser (flest F):', 20, yPos);
            yPos += 10;
            
            const courseStats = {};
            gradesData.forEach(grade => {
                if (!courseStats[grade.course_id]) {
                    courseStats[grade.course_id] = { total: 0, f_grades: 0 };
                }
                courseStats[grade.course_id].total++;
                if (grade.grade === 'F' && grade.grade_type !== 'warning') {
                    courseStats[grade.course_id].f_grades++;
                }
            });
            
            const sortedCourses = Object.entries(courseStats)
                .sort((a, b) => b[1].f_grades - a[1].f_grades)
                .slice(0, 10);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            sortedCourses.forEach(([courseId, stats]) => {
                const course = coursesData.find(c => c.id === courseId);
                const courseName = course ? course.name : 'Ok√§nd kurs';
                const passRate = stats.total > 0 ? (((stats.total - stats.f_grades) / stats.total) * 100).toFixed(1) : '0';
                
                if (yPos > 270) { // New page if needed
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.text(`${courseName}: ${stats.total} betyg, ${stats.f_grades} F (${passRate}% godk√§nd)`, 25, yPos);
                yPos += 6;
            });
            
            yPos += 10;
            
            // Class statistics (if space)
            if (yPos < 250) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Klasser:', 20, yPos);
                yPos += 10;
                
                const classGroups = {};
                studentsData.forEach(student => {
                    if (!classGroups[student.class_id]) {
                        classGroups[student.class_id] = { students: 0, f_grades: 0 };
                    }
                    classGroups[student.class_id].students++;
                });
                
                gradesData.forEach(grade => {
                    const student = studentsData.find(s => s.id === grade.student_id);
                    if (student && classGroups[student.class_id] && grade.grade === 'F' && grade.grade_type !== 'warning') {
                        classGroups[student.class_id].f_grades++;
                    }
                });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                Object.entries(classGroups).forEach(([classId, stats]) => {
                    const classObj = classesData.find(c => c.id === classId);
                    const className = classObj ? classObj.name : 'Ok√§nd klass';
                    
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.text(`${className}: ${stats.students} elever, ${stats.f_grades} F-betyg`, 25, yPos);
                    yPos += 6;
                });
            }
            
            // Save PDF
            const fileName = `Snapshot_${quarterName.replace(/\s+/g, '_')}_${snapshotDate.replace(/\s+/g, '_')}.pdf`;
            doc.save(fileName);
            
            showSuccessNotification('Snapshot exporterad till PDF!');
        }
        
        // ‚öñÔ∏è COMPARISON VIEW FUNCTIONS
        let comparisonChart = null;
        
        async function initializeComparisonView() {
            const snapshots = await fetchSnapshots();
            const snapshotOptions = snapshots.map(s => {
                const name = s.quarters ? s.quarters.name : 'Ok√§nt';
                const date = new Date(s.snapshot_date).toLocaleDateString('sv-SE');
                return `<option value="${s.id}">${name} (${date})</option>`;
            }).join('');
            
            document.getElementById('compare-snap-a').innerHTML = '<option value="">V√§lj snapshot...</option>' + snapshotOptions;
            document.getElementById('compare-snap-b').innerHTML = '<option value="">V√§lj snapshot...</option>' + snapshotOptions;
            
            const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('compare-class-a').innerHTML = '<option value="">V√§lj klass...</option>' + classOptions;
            document.getElementById('compare-class-b').innerHTML = '<option value="">V√§lj klass...</option>' + classOptions;
            
            const courseOptions = courses.map(c => `<option value="${c.id}">${c.name} (${c.code})</option>`).join('');
            document.getElementById('compare-course-a').innerHTML = '<option value="">V√§lj kurs...</option>' + courseOptions;
            document.getElementById('compare-course-b').innerHTML = '<option value="">V√§lj kurs...</option>' + courseOptions;
        }
        
        function switchComparisonType(type) {
            document.getElementById('compare-snapshots-section').classList.toggle('hidden', type !== 'snapshots');
            document.getElementById('compare-classes-section').classList.toggle('hidden', type !== 'classes');
            document.getElementById('compare-courses-section').classList.toggle('hidden', type !== 'courses');
            document.getElementById('comparison-results').classList.add('hidden');
            
            document.querySelectorAll('.comparison-type-btn').forEach(btn => {
                btn.className = btn.dataset.type === type ?
                    'comparison-type-btn bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-4 py-2 rounded font-medium' :
                    'comparison-type-btn bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded';
            });
        }
        
        async function runSnapshotComparison() {
            const snapIdA = document.getElementById('compare-snap-a').value;
            const snapIdB = document.getElementById('compare-snap-b').value;
            
            if (!snapIdA || !snapIdB || snapIdA === snapIdB) {
                showError(snapIdA === snapIdB ? 'V√§lj tv√• OLIKA snapshots.' : 'V√§lj tv√• snapshots att j√§mf√∂ra.');
                return;
            }
            
            showLoading();
            try {
                const { data, error } = await supabaseClient.from('quarter_snapshots').select('*, quarters(name)').in('id', [snapIdA, snapIdB]).order('snapshot_date');
                if (error || data.length !== 2) throw new Error('Kunde inte hitta snapshots');
                
                renderSnapshotSideBySide(data[0], data[1]);
                document.getElementById('comparison-results').classList.remove('hidden');
                document.getElementById('comparison-results').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showError('Kunde inte j√§mf√∂ra: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function renderSnapshotSideBySide(snapA, snapB) {
            const fChange = (snapB.total_f_grades || 0) - (snapA.total_f_grades || 0);
            const fWarningChange = (snapB.total_f_warnings || 0) - (snapA.total_f_warnings || 0);
            const passRateChange = (snapB.pass_rate || 0) - (snapA.pass_rate || 0);
            
            document.getElementById('comparison-content').innerHTML = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4">
                        <h5 class="text-lg font-bold text-blue-600">${snapA.quarters?.name || 'A'}</h5>
                        <p class="text-xs text-gray-500 mb-3">${new Date(snapA.snapshot_date).toLocaleDateString('sv-SE')}</p>
                        <div class="space-y-2">
                            <div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded"><span class="text-sm">Elever:</span><span class="font-bold">${snapA.total_students || 0}</span></div>
                            <div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded"><span class="text-sm">F-betyg:</span><span class="font-bold text-red-600">${snapA.total_f_grades || 0}</span></div>
                            <div class="flex justify-between p-2 bg-amber-50 dark:bg-amber-900/20 rounded"><span class="text-sm">F-varningar:</span><span class="font-bold text-amber-600">${snapA.total_f_warnings || 0}</span></div>
                            <div class="flex justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="text-sm">Godk√§nd %:</span><span class="font-bold text-green-600">${(snapA.pass_rate || 0).toFixed(1)}%</span></div>
                        </div>
                    </div>
                    <div class="border-2 border-green-300 dark:border-green-700 rounded-lg p-4">
                        <h5 class="text-lg font-bold text-green-600">${snapB.quarters?.name || 'B'}</h5>
                        <p class="text-xs text-gray-500 mb-3">${new Date(snapB.snapshot_date).toLocaleDateString('sv-SE')}</p>
                        <div class="space-y-2">
                            <div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded"><span class="text-sm">Elever:</span><span class="font-bold">${snapB.total_students || 0}</span></div>
                            <div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded"><span class="text-sm">F-betyg:</span><span class="font-bold text-red-600">${snapB.total_f_grades || 0} <span class="text-xs ${fChange < 0 ? 'text-green-600' : fChange > 0 ? 'text-red-600' : 'text-gray-500'}">(${fChange > 0 ? '+' : ''}${fChange})</span></span></div>
                            <div class="flex justify-between p-2 bg-amber-50 dark:bg-amber-900/20 rounded"><span class="text-sm">F-varningar:</span><span class="font-bold text-amber-600">${snapB.total_f_warnings || 0} <span class="text-xs ${fWarningChange < 0 ? 'text-green-600' : fWarningChange > 0 ? 'text-amber-600' : 'text-gray-500'}">(${fWarningChange > 0 ? '+' : ''}${fWarningChange})</span></span></div>
                            <div class="flex justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="text-sm">Godk√§nd %:</span><span class="font-bold text-green-600">${(snapB.pass_rate || 0).toFixed(1)}% <span class="text-xs ${passRateChange > 0 ? 'text-green-600' : passRateChange < 0 ? 'text-red-600' : 'text-gray-500'}">(${passRateChange > 0 ? '+' : ''}${passRateChange.toFixed(1)}%)</span></span></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-lg ${passRateChange > 0 ? 'bg-green-50 dark:bg-green-900/20 border-2 border-green-200' : passRateChange < 0 ? 'bg-red-50 dark:bg-red-900/20 border-2 border-red-200' : 'bg-gray-50 dark:bg-gray-800 border-2 border-gray-200'} text-center mb-6">
                    <div class="text-2xl font-bold">${passRateChange > 0 ? 'üìà F√∂rb√§ttring!' : passRateChange < 0 ? 'üìâ F√∂rs√§mring' : '‚û°Ô∏è Of√∂r√§ndrat'}</div>
                    <p class="text-sm mt-2">
                        ${passRateChange !== 0 ? `Godk√§nd% ${passRateChange > 0 ? '√∂kade' : 'minskade'} med ${Math.abs(passRateChange).toFixed(1)}%` : ''} 
                        ${fChange !== 0 ? ` ‚Ä¢ F-betyg ${fChange > 0 ? '√∂kade' : 'minskade'} med ${Math.abs(fChange)} st` : ''}
                        ${fWarningChange !== 0 ? ` ‚Ä¢ F-varningar ${fWarningChange > 0 ? '√∂kade' : 'minskade'} med ${Math.abs(fWarningChange)} st` : ''}
                    </p>
                </div>
                <div class="chart-container" style="height: 300px;"><canvas id="comparison-chart"></canvas></div>
            `;
            
            const ctx = document.getElementById('comparison-chart');
            if (ctx) {
                if (comparisonChart) comparisonChart.destroy();
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['F-betyg', 'F-varningar', 'Godk√§nd %'],
                        datasets: [{
                            label: snapA.quarters?.name || 'A',
                            data: [snapA.total_f_grades || 0, snapA.total_f_warnings || 0, snapA.pass_rate || 0],
                            backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgb(59, 130, 246)', borderWidth: 2
                        }, {
                            label: snapB.quarters?.name || 'B',
                            data: [snapB.total_f_grades || 0, snapB.total_f_warnings || 0, snapB.pass_rate || 0],
                            backgroundColor: 'rgba(34, 197, 94, 0.5)', borderColor: 'rgb(34, 197, 94)', borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
                });
            }
        }
        
        async function runClassComparison() {
            const classIdA = document.getElementById('compare-class-a').value;
            const classIdB = document.getElementById('compare-class-b').value;
            
            if (!classIdA || !classIdB || classIdA === classIdB) {
                showError(classIdA === classIdB ? 'V√§lj tv√• OLIKA klasser.' : 'V√§lj tv√• klasser.');
                return;
            }
            
            const classA = classes.find(c => c.id === classIdA);
            const classB = classes.find(c => c.id === classIdB);
            const studentsA = students.filter(s => s.class_id === classIdA);
            const studentsB = students.filter(s => s.class_id === classIdB);
            const gradesA = grades.filter(g => studentsA.some(s => s.id === g.student_id));
            const gradesB = grades.filter(g => studentsB.some(s => s.id === g.student_id));
            
            const statsA = { 
                students: studentsA.length, 
                grades: gradesA.length, 
                f_grades: gradesA.filter(g => g.grade === 'F' && g.grade_type !== 'warning').length,
                f_warnings: gradesA.filter(g => g.grade === 'F' && g.grade_type === 'warning').length,
                pass_rate: gradesA.length > 0 ? ((gradesA.filter(g => g.grade !== 'F').length / gradesA.length) * 100) : 0 
            };
            const statsB = { 
                students: studentsB.length, 
                grades: gradesB.length, 
                f_grades: gradesB.filter(g => g.grade === 'F' && g.grade_type !== 'warning').length,
                f_warnings: gradesB.filter(g => g.grade === 'F' && g.grade_type === 'warning').length,
                pass_rate: gradesB.length > 0 ? ((gradesB.filter(g => g.grade !== 'F').length / gradesB.length) * 100) : 0 
            };
            
            renderClassSideBySide(classA, classB, statsA, statsB);
            document.getElementById('comparison-results').classList.remove('hidden');
            document.getElementById('comparison-results').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderClassSideBySide(classA, classB, statsA, statsB) {
            const passRateDiff = statsB.pass_rate - statsA.pass_rate;
            const fDiff = statsB.f_grades - statsA.f_grades;
            const fWarningDiff = statsB.f_warnings - statsA.f_warnings;
            
            document.getElementById('comparison-content').innerHTML = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4">
                        <h5 class="text-lg font-bold text-blue-600 mb-3">${classA.name}</h5>
                        <div class="space-y-2">
                            <div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded"><span class="text-sm">Elever:</span><span class="font-bold">${statsA.students}</span></div>
                            <div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded"><span class="text-sm">F-betyg:</span><span class="font-bold text-red-600">${statsA.f_grades}</span></div>
                            <div class="flex justify-between p-2 bg-amber-50 dark:bg-amber-900/20 rounded"><span class="text-sm">F-varningar:</span><span class="font-bold text-amber-600">${statsA.f_warnings}</span></div>
                            <div class="flex justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="text-sm">Godk√§nd %:</span><span class="font-bold text-green-600">${statsA.pass_rate.toFixed(1)}%</span></div>
                        </div>
                    </div>
                    <div class="border-2 border-green-300 dark:border-green-700 rounded-lg p-4">
                        <h5 class="text-lg font-bold text-green-600 mb-3">${classB.name}</h5>
                        <div class="space-y-2">
                            <div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded"><span class="text-sm">Elever:</span><span class="font-bold">${statsB.students}</span></div>
                            <div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded"><span class="text-sm">F-betyg:</span><span class="font-bold text-red-600">${statsB.f_grades} <span class="text-xs ${fDiff < 0 ? 'text-green-600' : fDiff > 0 ? 'text-red-600' : 'text-gray-500'}">(${fDiff > 0 ? '+' : ''}${fDiff})</span></span></div>
                            <div class="flex justify-between p-2 bg-amber-50 dark:bg-amber-900/20 rounded"><span class="text-sm">F-varningar:</span><span class="font-bold text-amber-600">${statsB.f_warnings} <span class="text-xs ${fWarningDiff < 0 ? 'text-green-600' : fWarningDiff > 0 ? 'text-amber-600' : 'text-gray-500'}">(${fWarningDiff > 0 ? '+' : ''}${fWarningDiff})</span></span></div>
                            <div class="flex justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="text-sm">Godk√§nd %:</span><span class="font-bold text-green-600">${statsB.pass_rate.toFixed(1)}% <span class="text-xs ${passRateDiff > 0 ? 'text-green-600' : passRateDiff < 0 ? 'text-red-600' : 'text-gray-500'}">(${passRateDiff > 0 ? '+' : ''}${passRateDiff.toFixed(1)}%)</span></span></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-lg ${passRateDiff > 0 ? 'bg-green-50 border-2 border-green-200' : passRateDiff < 0 ? 'bg-red-50 border-2 border-red-200' : 'bg-gray-50 border-2 border-gray-200'} text-center mb-6">
                    <div class="text-xl font-bold">${passRateDiff > 0 ? `${classB.name} presterar ${passRateDiff.toFixed(1)}% b√§ttre` : passRateDiff < 0 ? `${classA.name} presterar ${Math.abs(passRateDiff).toFixed(1)}% b√§ttre` : 'Lika prestanda'}</div>
                </div>
                <div class="chart-container" style="height: 300px;"><canvas id="comparison-chart"></canvas></div>
            `;
            
            const ctx = document.getElementById('comparison-chart');
            if (ctx) {
                if (comparisonChart) comparisonChart.destroy();
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: { 
                        labels: ['F-betyg', 'F-varningar', 'Godk√§nd %'], 
                        datasets: [
                            { label: classA.name, data: [statsA.f_grades, statsA.f_warnings, statsA.pass_rate], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgb(59, 130, 246)', borderWidth: 2 }, 
                            { label: classB.name, data: [statsB.f_grades, statsB.f_warnings, statsB.pass_rate], backgroundColor: 'rgba(34, 197, 94, 0.5)', borderColor: 'rgb(34, 197, 94)', borderWidth: 2 }
                        ] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
                });
            }
        }
        
        async function runCourseComparison() {
            const courseIdA = document.getElementById('compare-course-a').value;
            const courseIdB = document.getElementById('compare-course-b').value;
            
            if (!courseIdA || !courseIdB || courseIdA === courseIdB) {
                showError(courseIdA === courseIdB ? 'V√§lj tv√• OLIKA kurser.' : 'V√§lj tv√• kurser.');
                return;
            }
            
            const courseA = courses.find(c => c.id === courseIdA);
            const courseB = courses.find(c => c.id === courseIdB);
            const gradesA = grades.filter(g => g.course_id === courseIdA);
            const gradesB = grades.filter(g => g.course_id === courseIdB);
            
            const statsA = { 
                grades: gradesA.length, 
                f_grades: gradesA.filter(g => g.grade === 'F' && g.grade_type !== 'warning').length,
                f_warnings: gradesA.filter(g => g.grade === 'F' && g.grade_type === 'warning').length,
                pass_rate: gradesA.length > 0 ? ((gradesA.filter(g => g.grade !== 'F').length / gradesA.length) * 100) : 0 
            };
            const statsB = { 
                grades: gradesB.length, 
                f_grades: gradesB.filter(g => g.grade === 'F' && g.grade_type !== 'warning').length,
                f_warnings: gradesB.filter(g => g.grade === 'F' && g.grade_type === 'warning').length,
                pass_rate: gradesB.length > 0 ? ((gradesB.filter(g => g.grade !== 'F').length / gradesB.length) * 100) : 0 
            };
            
            const passRateDiff = statsB.pass_rate - statsA.pass_rate;
            const fDiff = statsB.f_grades - statsA.f_grades;
            const fWarningDiff = statsB.f_warnings - statsA.f_warnings;
            
            document.getElementById('comparison-content').innerHTML = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div class="border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4">
                        <h5 class="text-lg font-bold text-blue-600 mb-1">${courseA.name}</h5>
                        <p class="text-xs text-gray-500 mb-3">${courseA.code}</p>
                        <div class="space-y-2">
                            <div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded"><span class="text-sm">Betyg:</span><span class="font-bold">${statsA.grades}</span></div>
                            <div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded"><span class="text-sm">F-betyg:</span><span class="font-bold text-red-600">${statsA.f_grades}</span></div>
                            <div class="flex justify-between p-2 bg-amber-50 dark:bg-amber-900/20 rounded"><span class="text-sm">F-varningar:</span><span class="font-bold text-amber-600">${statsA.f_warnings}</span></div>
                            <div class="flex justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="text-sm">Godk√§nd %:</span><span class="font-bold text-green-600">${statsA.pass_rate.toFixed(1)}%</span></div>
                        </div>
                    </div>
                    <div class="border-2 border-green-300 dark:border-green-700 rounded-lg p-4">
                        <h5 class="text-lg font-bold text-green-600 mb-1">${courseB.name}</h5>
                        <p class="text-xs text-gray-500 mb-3">${courseB.code}</p>
                        <div class="space-y-2">
                            <div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded"><span class="text-sm">Betyg:</span><span class="font-bold">${statsB.grades}</span></div>
                            <div class="flex justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded"><span class="text-sm">F-betyg:</span><span class="font-bold text-red-600">${statsB.f_grades} <span class="text-xs ${fDiff < 0 ? 'text-green-600' : fDiff > 0 ? 'text-red-600' : 'text-gray-500'}">(${fDiff > 0 ? '+' : ''}${fDiff})</span></span></div>
                            <div class="flex justify-between p-2 bg-amber-50 dark:bg-amber-900/20 rounded"><span class="text-sm">F-varningar:</span><span class="font-bold text-amber-600">${statsB.f_warnings} <span class="text-xs ${fWarningDiff < 0 ? 'text-green-600' : fWarningDiff > 0 ? 'text-amber-600' : 'text-gray-500'}">(${fWarningDiff > 0 ? '+' : ''}${fWarningDiff})</span></span></div>
                            <div class="flex justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="text-sm">Godk√§nd %:</span><span class="font-bold text-green-600">${statsB.pass_rate.toFixed(1)}% <span class="text-xs ${passRateDiff > 0 ? 'text-green-600' : passRateDiff < 0 ? 'text-red-600' : 'text-gray-500'}">(${passRateDiff > 0 ? '+' : ''}${passRateDiff.toFixed(1)}%)</span></span></div>
                        </div>
                    </div>
                </div>
                <div class="chart-container" style="height: 300px;"><canvas id="comparison-chart"></canvas></div>
            `;
            
            const ctx = document.getElementById('comparison-chart');
            if (ctx) {
                if (comparisonChart) comparisonChart.destroy();
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: { 
                        labels: ['F-betyg', 'F-varningar', 'Godk√§nd %'], 
                        datasets: [
                            { label: courseA.name, data: [statsA.f_grades, statsA.f_warnings, statsA.pass_rate], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgb(59, 130, 246)', borderWidth: 2 }, 
                            { label: courseB.name, data: [statsB.f_grades, statsB.f_warnings, statsB.pass_rate], backgroundColor: 'rgba(34, 197, 94, 0.5)', borderColor: 'rgb(34, 197, 94)', borderWidth: 2 }
                        ] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
                });
            }
            
            document.getElementById('comparison-results').classList.remove('hidden');
            document.getElementById('comparison-results').scrollIntoView({ behavior: 'smooth' });
        }
        
        function populateSnapshotSelects(snapshots) {
            const select1 = document.getElementById('compare-snapshot-1');
            const select2 = document.getElementById('compare-snapshot-2');
            
            if (!select1 || !select2) return;
            
            const options = snapshots.map(s => {
                const quarterName = s.quarters ? s.quarters.name : 'Ok√§nt';
                const date = new Date(s.snapshot_date).toLocaleDateString('sv-SE');
                return `<option value="${s.id}">${quarterName} (${date})</option>`;
            }).join('');
            
            select1.innerHTML = '<option value="">V√§lj snapshot</option>' + options;
            select2.innerHTML = '<option value="">V√§lj snapshot</option>' + options;
        }
        
        async function compareSnapshots(snapshotId1, snapshotId2) {
            if (!snapshotId1 || !snapshotId2) {
                showError('V√§lj tv√• snapshots att j√§mf√∂ra.');
                return;
            }
            
            showLoading();
            
            try {
                const { data, error } = await supabaseClient
                    .from('quarter_snapshots')
                    .select('*, quarters(name)')
                    .in('id', [snapshotId1, snapshotId2]);
                
                if (error) throw error;
                
                if (data.length !== 2) {
                    throw new Error('Kunde inte hitta b√•da snapshots');
                }
                
                const [snap1, snap2] = data;
                const resultsDiv = document.getElementById('snapshot-comparison-results');
                
                const fChange = (snap2.total_f_grades || 0) - (snap1.total_f_grades || 0);
                const passRateChange = (snap2.pass_rate || 0) - (snap1.pass_rate || 0);
                
                resultsDiv.innerHTML = `
                    <h4 class="font-semibold mb-3">J√§mf√∂relse: ${snap1.quarters?.name} ‚Üí ${snap2.quarters?.name}</h4>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">F-betyg</div>
                            <div class="flex items-baseline justify-between mt-1">
                                <span class="text-xl font-bold">${snap1.total_f_grades || 0} ‚Üí ${snap2.total_f_grades || 0}</span>
                                <span class="text-sm ${fChange < 0 ? 'text-green-600' : fChange > 0 ? 'text-red-600' : 'text-gray-500'}">
                                    ${fChange > 0 ? '+' : ''}${fChange}
                                </span>
                            </div>
                        </div>
                        
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Godk√§nd %</div>
                            <div class="flex items-baseline justify-between mt-1">
                                <span class="text-xl font-bold">${(snap1.pass_rate || 0).toFixed(1)}% ‚Üí ${(snap2.pass_rate || 0).toFixed(1)}%</span>
                                <span class="text-sm ${passRateChange > 0 ? 'text-green-600' : passRateChange < 0 ? 'text-red-600' : 'text-gray-500'}">
                                    ${passRateChange > 0 ? '+' : ''}${passRateChange.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                        
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Betyg</div>
                            <div class="flex items-baseline justify-between mt-1">
                                <span class="text-xl font-bold">${snap1.total_grades || 0} ‚Üí ${snap2.total_grades || 0}</span>
                                <span class="text-sm text-gray-500">
                                    ${((snap2.total_grades || 0) - (snap1.total_grades || 0)) > 0 ? '+' : ''}${(snap2.total_grades || 0) - (snap1.total_grades || 0)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 rounded ${passRateChange > 0 ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800' : passRateChange < 0 ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800' : 'bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700'}">
                        <div class="text-sm">
                            ${passRateChange > 0 ? '‚úÖ <strong>F√∂rb√§ttring!</strong> Godk√§nd-procenten har √∂kat.' : passRateChange < 0 ? '‚ö†Ô∏è <strong>F√∂rs√§mring.</strong> Godk√§nd-procenten har minskat.' : '‚û°Ô∏è <strong>Of√∂r√§ndrat.</strong> Ingen f√∂r√§ndring i godk√§nd-procent.'}
                        </div>
                    </div>
                `;
                
                resultsDiv.classList.remove('hidden');
            } catch (error) {
                showError('Kunde inte j√§mf√∂ra snapshots: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // üì∏ MANUAL SNAPSHOT CREATION
        async function createManualSnapshot(snapshotName, notes = '') {
            if (!activeQuarter) {
                showError('Inget aktivt kvartal att skapa snapshot f√∂r.');
                return false;
            }
            
            if (!snapshotName || snapshotName.trim() === '') {
                showError('Du m√•ste ange ett namn f√∂r snapshoten.');
                return false;
            }
            
            showLoading();
            
            try {
                // Gather all data for current state
                const currentGrades = grades; // Already filtered for active quarter
                const activeStudents = students;
                const activeCourses = courses;
                const activeClasses = classes;
                
                // Calculate statistics
                const totalStudents = new Set(currentGrades.map(g => g.student_id)).size;
                const totalGrades = currentGrades.length;
                const totalFGrades = currentGrades.filter(g => g.grade === 'F' && g.grade_type !== 'warning').length;
                const totalFWarnings = currentGrades.filter(g => g.grade === 'F' && g.grade_type === 'warning').length;
                const passRate = totalGrades > 0 ? ((totalGrades - totalFGrades) / totalGrades * 100) : 0;
                
                // Create manual snapshot
                const { data, error } = await supabaseClient
                    .from('quarter_snapshots')
                    .insert({
                        quarter_id: activeQuarter.id,
                        snapshot_date: new Date().toISOString(),
                        total_students: totalStudents,
                        total_grades: totalGrades,
                        total_f_grades: totalFGrades,
                        total_f_warnings: totalFWarnings,
                        pass_rate: passRate,
                        grades_snapshot: currentGrades,
                        students_snapshot: activeStudents,
                        courses_snapshot: activeCourses,
                        classes_snapshot: activeClasses,
                        created_by: currentUser.id,
                        locked: true,
                        notes: `üì∏ ${snapshotName}${notes ? `\n\n${notes}` : ''}\n\n(Manuell snapshot)`
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('‚úÖ Manuell snapshot skapad:', data);
                showSuccessNotification(`Snapshot "${snapshotName}" har skapats!`);
                
                return true;
            } catch (error) {
                console.error('Kunde inte skapa snapshot:', error);
                showError('Kunde inte skapa snapshot: ' + error.message);
                return false;
            } finally {
                hideLoading();
            }
        }
        
        // üîí REACTIVATE FUNCTIONS
        async function reactivateStudent(studentId) {
            if (!confirm('Vill du √•teraktivera denna elev? Eleven kommer att bli synlig igen i systemet.')) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('students')
                    .update({
                        is_active: true,
                        archived_at: null,
                        archived_reason: null
                    })
                    .eq('id', studentId);
                
                if (error) throw error;
                
                await fetchStudents();
                await renderArchivedStudents();
                renderStudents();
                
                showSuccessNotification('Eleven har √•teraktiverats!');
            } catch (error) {
                showError('Kunde inte √•teraktivera elev: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function reactivateCourse(courseId) {
            if (!confirm('Vill du √•teraktivera denna kurs? Kursen kommer att bli synlig igen i systemet.')) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('courses')
                    .update({
                        is_active: true,
                        archived_at: null,
                        archived_reason: null
                    })
                    .eq('id', courseId);
                
                if (error) throw error;
                
                await fetchCourses();
                await renderArchivedCourses();
                renderCourses();
                
                showSuccessNotification('Kursen har √•teraktiverats!');
            } catch (error) {
                showError('Kunde inte √•teraktivera kurs: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function reactivateClass(classId) {
            if (!confirm('Vill du √•teraktivera denna klass? Klassen kommer att bli synlig igen i systemet.')) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('classes')
                    .update({
                        is_active: true,
                        archived_at: null,
                        archived_reason: null
                    })
                    .eq('id', classId);
                
                if (error) throw error;
                
                await fetchClasses();
                await renderArchivedClasses();
                renderClasses();
                
                showSuccessNotification('Klassen har √•teraktiverats!');
            } catch (error) {
                showError('Kunde inte √•teraktivera klass: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // üîí PERMANENT DELETE FUNCTIONS (with strong warnings)
        async function permanentDeleteStudent(studentId) {
            const student = archivedStudents.find(s => s.id === studentId);
            const studentName = student ? `${student.first_name} ${student.last_name}` : 'eleven';
            
            if (!confirm(`‚ö†Ô∏è VARNING! PERMANENT RADERING!\n\nDu √§r p√• v√§g att PERMANENT radera ${studentName}.\n\nDetta kommer att:\n‚ùå Radera eleven helt fr√•n databasen\n‚ùå Radera ALLA betyg kopplade till eleven\n‚ùå Radera ALL historik f√∂r eleven\n\nDetta g√•r INTE att √•ngra!\n\n√Ñr du ABSOLUT S√ÑKER?`)) {
                return;
            }
            
            // Double confirmation
            if (!confirm(`Bekr√§fta en g√•ng till:\n\nRadera ${studentName} PERMANENT?\n\nKlicka OK f√∂r att radera, Avbryt f√∂r att avbryta.`)) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('students')
                    .delete()
                    .eq('id', studentId);
                
                if (error) throw error;
                
                await renderArchivedStudents();
                
                showSuccessNotification(`${studentName} har raderats permanent.`);
            } catch (error) {
                showError('Kunde inte radera elev: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function permanentDeleteCourse(courseId) {
            const course = archivedCourses.find(c => c.id === courseId);
            const courseName = course ? course.name : 'kursen';
            
            if (!confirm(`‚ö†Ô∏è VARNING! PERMANENT RADERING!\n\nDu √§r p√• v√§g att PERMANENT radera ${courseName}.\n\nDetta kommer att:\n‚ùå Radera kursen helt fr√•n databasen\n‚ùå Radera ALLA betyg kopplade till kursen\n‚ùå Radera ALL historik f√∂r kursen\n\nDetta g√•r INTE att √•ngra!\n\n√Ñr du ABSOLUT S√ÑKER?`)) {
                return;
            }
            
            // Double confirmation
            if (!confirm(`Bekr√§fta en g√•ng till:\n\nRadera ${courseName} PERMANENT?\n\nKlicka OK f√∂r att radera, Avbryt f√∂r att avbryta.`)) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('courses')
                    .delete()
                    .eq('id', courseId);
                
                if (error) throw error;
                
                await renderArchivedCourses();
                
                showSuccessNotification(`${courseName} har raderats permanent.`);
            } catch (error) {
                showError('Kunde inte radera kurs: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function permanentDeleteClass(classId) {
            const classObj = archivedClasses.find(c => c.id === classId);
            const className = classObj ? classObj.name : 'klassen';
            
            if (!confirm(`‚ö†Ô∏è VARNING! PERMANENT RADERING!\n\nDu √§r p√• v√§g att PERMANENT radera ${className}.\n\nDetta kommer att:\n‚ùå Radera klassen helt fr√•n databasen\n‚ùå Kan p√•verka elever kopplade till klassen\n‚ùå Radera ALL historik f√∂r klassen\n\nDetta g√•r INTE att √•ngra!\n\n√Ñr du ABSOLUT S√ÑKER?`)) {
                return;
            }
            
            // Double confirmation
            if (!confirm(`Bekr√§fta en g√•ng till:\n\nRadera ${className} PERMANENT?\n\nKlicka OK f√∂r att radera, Avbryt f√∂r att avbryta.`)) {
                return;
            }
            
            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('classes')
                    .delete()
                    .eq('id', classId);
                
                if (error) throw error;
                
                await renderArchivedClasses();
                
                showSuccessNotification(`${className} har raderats permanent.`);
            } catch (error) {
                showError('Kunde inte radera klass: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Compare quarters function
        async function compareQuarters(fromQuarterId, toQuarterId) {
            if (!fromQuarterId || !toQuarterId) {
                showError('V√§lj tv√• kvartal att j√§mf√∂ra.');
                return;
            }
            
            showLoading();
            
            try {
                // Get grades from both quarters
                const { data: fromGrades, error: fromError } = await supabaseClient
                    .from('grades')
                    .select('*')
                    .eq('quarter_id', fromQuarterId);
                
                if (fromError) throw fromError;
                
                const { data: toGrades, error: toError } = await supabaseClient
                    .from('grades')
                    .select('*')
                    .eq('quarter_id', toQuarterId);
                
                if (toError) throw toError;
                
                // Group grades by student and course for comparison
                const studentCourseGrades = {};
                
                // Process "from" quarter grades
                fromGrades.forEach(grade => {
                    const key = `${grade.student_id}_${grade.course_id}`;
                    if (!studentCourseGrades[key]) {
                        studentCourseGrades[key] = { 
                            student_id: grade.student_id,
                            course_id: grade.course_id,
                            from_grade: grade.grade
                        };
                    }
                });
                
                // Process "to" quarter grades and compare
                toGrades.forEach(grade => {
                    const key = `${grade.student_id}_${grade.course_id}`;
                    if (studentCourseGrades[key]) {
                        studentCourseGrades[key].to_grade = grade.grade;
                    } else {
                        studentCourseGrades[key] = {
                            student_id: grade.student_id,
                            course_id: grade.course_id,
                            to_grade: grade.grade
                        };
                    }
                });
                
                // Count improvements, declines, and unchanged
                let improvements = 0;
                let declines = 0;
                let unchanged = 0;
                
                // Track changes by class
                const classProgramData = {};
                
                // Process each student-course pair
                Object.values(studentCourseGrades).forEach(item => {
                    if (!item.from_grade || !item.to_grade) return; // Skip if missing grade in either quarter
                    
                    const student = students.find(s => s.id === item.student_id);
                    if (!student) return;
                    
                    const classObj = classes.find(c => c.id === student.class_id);
                    if (!classObj) return;
                    
                    const className = classObj.name;
                    
                    // Initialize class data if not exists
                    if (!classProgramData[className]) {
                        classProgramData[className] = { improved: 0, declined: 0, unchanged: 0 };
                    }
                    
                    // Convert grades to numeric values (A=5, B=4, etc.)
                    const gradeValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, 'F': 0 };
                    const fromValue = gradeValues[item.from_grade];
                    const toValue = gradeValues[item.to_grade];
                    
                    if (toValue > fromValue) {
                        improvements++;
                        classProgramData[className].improved++;
                    } else if (toValue < fromValue) {
                        declines++;
                        classProgramData[className].declined++;
                    } else {
                        unchanged++;
                        classProgramData[className].unchanged++;
                    }
                });
                
                // Update comparison results
                comparisonImprovements.textContent = improvements;
                comparisonUnchanged.textContent = unchanged;
                comparisonDeclines.textContent = declines;
                
                // Update comparison chart
                updateQuarterComparisonChart(classProgramData);
                
                // Show results
                quarterComparisonResults.classList.remove('hidden');
            } catch (error) {
                showError('Ett fel intr√§ffade vid j√§mf√∂relsen: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function updateQuarterComparisonChart(classProgramData) {
            // Extract data for chart
            const labels = Object.keys(classProgramData);
            const improvedData = labels.map(className => classProgramData[className].improved);
            const unchangedData = labels.map(className => classProgramData[className].unchanged);
            const declinedData = labels.map(className => classProgramData[className].declined);
            
            // Create or update chart
            if (quarterComparisonChart) {
                quarterComparisonChart.destroy();
            }
            
            const ctx = document.getElementById('quarter-comparison-chart').getContext('2d');
            quarterComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'F√∂rb√§ttrade',
                            data: improvedData,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'Of√∂r√§ndrade',
                            data: unchangedData,
                            backgroundColor: '#6b7280',
                            borderColor: '#4b5563',
                            borderWidth: 1
                        },
                        {
                            label: 'F√∂rs√§mrade',
                            data: declinedData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        function renderWarningsTable(fGrades) {
            warningsContainer.innerHTML = '';
            
            if (fGrades.length === 0) {
                warningsContainer.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-5 text-center text-gray-500 dark:text-gray-400">
                            Inga F-varningar hittades med de valda filtren.
                        </td>
                    </tr>
                `;
                noWarningsMessage.classList.remove('hidden');
                return;
            }
            
            noWarningsMessage.classList.add('hidden');
            
            // Group F grades by student
            const studentFGrades = {};
            
            fGrades.forEach(g => {
                if (!studentFGrades[g.student_id]) {
                    studentFGrades[g.student_id] = {
                        student: students.find(s => s.id === g.student_id),
                        grades: [],
                        warnings: []
                    };
                }
                
                const course = courses.find(c => c.id === g.course_id);
                const teacherInfo = teachers[g.teacher_id] || { name: 'Ok√§nd l√§rare', role: 'admin' };
                
                if (course) {
                    const gradeInfo = {
                        course,
                        teacher: teacherInfo.name,
                        teacherRole: teacherInfo.role,
                        gradeId: g.id,
                        gradeType: g.grade_type || 'grade',
                        date: new Date(g.updated_at)
                    };
                    
                    // Separate into grades and warnings
                    if (g.grade_type === 'warning') {
                        studentFGrades[g.student_id].warnings.push(gradeInfo);
                    } else {
                        studentFGrades[g.student_id].grades.push(gradeInfo);
                    }
                }
            });
            
            // Convert to array
            let studentsList = Object.values(studentFGrades)
                .filter(item => item.student && (item.grades.length > 0 || item.warnings.length > 0));
            
            // Get filter settings
            const statusFilters = {
                critical: document.getElementById('filter-critical')?.checked ?? true,
                warning: document.getElementById('filter-warning')?.checked ?? true,
                action: document.getElementById('filter-action')?.checked ?? true
            };
            
            const typeFilters = {
                fgrade: document.getElementById('filter-has-fgrade')?.checked ?? true,
                warning: document.getElementById('filter-has-warning')?.checked ?? true,
                both: document.getElementById('filter-has-both')?.checked ?? true
            };
            
            const sortBy = document.getElementById('student-sort-by')?.value || 'total_desc';
            
            // Apply status filters (based on total count)
            studentsList = studentsList.filter(item => {
                const total = item.grades.length + item.warnings.length;
                if (total >= 3 && statusFilters.critical) return true;
                if (total === 2 && statusFilters.warning) return true;
                if (total === 1 && statusFilters.action) return true;
                return false;
            });
            
            // Apply type filters (based on what type of F they have)
            studentsList = studentsList.filter(item => {
                const hasGrades = item.grades.length > 0;
                const hasWarnings = item.warnings.length > 0;
                
                if (hasGrades && hasWarnings && typeFilters.both) return true;
                if (hasGrades && !hasWarnings && typeFilters.fgrade) return true;
                if (!hasGrades && hasWarnings && typeFilters.warning) return true;
                
                return false;
            });
            
            // Apply sorting
            studentsList.sort((a, b) => {
                const aTotal = a.grades.length + a.warnings.length;
                const bTotal = b.grades.length + b.warnings.length;
                const aClass = classes.find(c => c.id === a.student.class_id);
                const bClass = classes.find(c => c.id === b.student.class_id);
                const aName = `${a.student.first_name} ${a.student.last_name}`;
                const bName = `${b.student.first_name} ${b.student.last_name}`;
                
                switch(sortBy) {
                    case 'total_desc':
                        return bTotal - aTotal;
                    case 'total_asc':
                        return aTotal - bTotal;
                    case 'name_asc':
                        return aName.localeCompare(bName);
                    case 'name_desc':
                        return bName.localeCompare(aName);
                    case 'class_asc':
                        return (aClass?.name || '').localeCompare(bClass?.name || '');
                    case 'class_desc':
                        return (bClass?.name || '').localeCompare(aClass?.name || '');
                    case 'fgrade_desc':
                        return b.grades.length - a.grades.length;
                    case 'warning_desc':
                        return b.warnings.length - a.warnings.length;
                    case 'ratio_desc':
                        const aRatio = a.grades.length > 0 ? a.warnings.length / a.grades.length : a.warnings.length;
                        const bRatio = b.grades.length > 0 ? b.warnings.length / b.grades.length : b.warnings.length;
                        return bRatio - aRatio;
                    default:
                        return bTotal - aTotal;
                }
            });
            
            // Filter students by selected classes
            const filteredStudents = studentsList.filter(item => {
                // If no classes are selected, don't show any students
                if (selectedClassIds.length === 0) return false;
                
                // Only show students in selected classes
                return item.student && item.student.class_id && selectedClassIds.includes(item.student.class_id);
            });
            
            // Update counters
            const totalStudentCountEl = document.getElementById('total-student-count');
            const filteredStudentCountEl = document.getElementById('filtered-student-count');
            if (totalStudentCountEl) totalStudentCountEl.textContent = studentsList.length;
            if (filteredStudentCountEl) filteredStudentCountEl.textContent = filteredStudents.length;
            
            if (filteredStudents.length === 0) {
                warningsContainer.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-5 text-center text-gray-500 dark:text-gray-400">
                            Inga F-varningar hittades med de valda filtren.
                        </td>
                    </tr>
                `;
                noWarningsMessage.classList.remove('hidden');
                return;
            }
            
            // Render table
            filteredStudents.forEach(item => {
                const { student, grades, warnings } = item;
                const classObj = classes.find(c => c.id === student.class_id);
                const className = classObj ? classObj.name : '-';
                const fCount = grades.length;
                const warningCount = warnings.length;
                const totalCount = fCount + warningCount;
                
                // Determine row color based on total count
                let rowColorClass = '';
                let statusText = '';
                let statusColor = '';
                
                if (totalCount >= 3) {
                    rowColorClass = 'f-count-3plus';
                    statusText = 'Kritisk';
                    statusColor = 'text-red-600 dark:text-red-400';
                } else if (totalCount === 2) {
                    rowColorClass = 'f-count-2';
                    statusText = 'Varning';
                    statusColor = 'text-amber-600 dark:text-amber-400';
                } else {
                    rowColorClass = 'f-count-1';
                    statusText = '√Ötg√§rd';
                    statusColor = 'text-emerald-600 dark:text-emerald-400';
                }
                
                // Create count display with badges
                let countDisplay = '';
                if (activeGradeTypeFilter === 'both') {
                    // Show both separately
                    const fBadge = fCount > 0 ? `<span class="warning-badge mr-1">${fCount} F</span>` : '';
                    const wBadge = warningCount > 0 ? `<span class="warning-badge-orange">${warningCount} ‚ö†Ô∏è</span>` : '';
                    countDisplay = `<div class="flex items-center justify-center gap-2">${fBadge}${wBadge}</div>`;
                } else if (activeGradeTypeFilter === 'warnings') {
                    countDisplay = warningCount;
                } else {
                    countDisplay = fCount;
                }
                
                const tr = document.createElement('tr');
                tr.className = `border-t border-gray-200 dark:border-gray-700 ${rowColorClass}`;
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm">
                        <span class="student-name" data-student-id="${student.id}">
                            ${student.first_name} ${student.last_name}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${className}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold">${countDisplay}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold ${statusColor}">${statusText}</td>
                `;
                warningsContainer.appendChild(tr);
            });
            
            // Add event listeners to student names
            document.querySelectorAll('.student-name').forEach(nameSpan => {
                nameSpan.addEventListener('click', () => {
                    const studentId = nameSpan.dataset.studentId;
                    showStudentDetailWithProgress(studentId);
                });
            });
        }
        
        function showStudentDetailModal(studentId, studentData) {
            showStudentDetailWithProgress(studentId);
        }
        
        function updateCharts() {
            // Prepare data for class chart
            const classLabels = [];
            const classDataPassing = [];
            const classDataFailing = [];
            const classDataWarnings = [];
            
            classes.forEach(c => {
                classLabels.push(c.name);
                
                // Count all grades in this class
                const classGrades = grades.filter(g => {
                    const student = students.find(s => s.id === g.student_id);
                    return student && student.class_id === c.id;
                });
                
                // Count F grades and warnings in this class based on filter
                let classFGrades = 0;
                let classFWarnings = 0;
                
                classGrades.forEach(g => {
                    if (g.grade === 'F') {
                        if (g.grade_type === 'warning') {
                            classFWarnings++;
                        } else {
                            classFGrades++;
                        }
                    }
                });
                
                // Apply grade type filter
                let totalF = 0;
                if (activeGradeTypeFilter === 'grades') {
                    totalF = classFGrades;
                } else if (activeGradeTypeFilter === 'warnings') {
                    totalF = classFWarnings;
                } else { // 'both'
                    totalF = classFGrades + classFWarnings;
                }
                
                // Count passing grades in this class
                const classPassingGrades = classGrades.length - classFGrades - classFWarnings;
                
                classDataPassing.push(classPassingGrades);
                classDataFailing.push(activeGradeTypeFilter === 'both' ? classFGrades : totalF);
                classDataWarnings.push(activeGradeTypeFilter === 'both' ? classFWarnings : 0);
            });
            
            // Prepare data for course chart
            const courseLabels = [];
            const courseDataPassing = [];
            const courseDataFailing = [];
            const courseDataWarnings = [];
            
            // Limit to top 10 courses by F count for readability
            const courseFCounts = {};
            courses.forEach(c => {
                const courseGrades = grades.filter(g => g.course_id === c.id);
                const courseFGradesActual = courseGrades.filter(g => g.grade === 'F' && g.grade_type !== 'warning').length;
                const courseFWarnings = courseGrades.filter(g => g.grade === 'F' && g.grade_type === 'warning').length;
                
                let totalF = 0;
                if (activeGradeTypeFilter === 'grades') {
                    totalF = courseFGradesActual;
                } else if (activeGradeTypeFilter === 'warnings') {
                    totalF = courseFWarnings;
                } else {
                    totalF = courseFGradesActual + courseFWarnings;
                }
                
                courseFCounts[c.id] = {
                    name: c.name,
                    totalGrades: courseGrades.length,
                    fGrades: courseFGradesActual,
                    fWarnings: courseFWarnings,
                    totalF: totalF
                };
            });
            
            const topCourses = Object.entries(courseFCounts)
                .sort((a, b) => b[1].totalF - a[1].totalF)
                .slice(0, 10);
            
            topCourses.forEach(([_, data]) => {
                courseLabels.push(data.name);
                courseDataPassing.push(data.totalGrades - data.fGrades - data.fWarnings);
                courseDataFailing.push(activeGradeTypeFilter === 'both' ? data.fGrades : (activeGradeTypeFilter === 'warnings' ? data.fWarnings : data.fGrades));
                courseDataWarnings.push(activeGradeTypeFilter === 'both' ? data.fWarnings : 0);
            });
            
            // Update class chart
            if (classChart) {
                classChart.destroy();
            }
            
            // Build datasets based on active filter
            const classDatasets = [];
            
            // ALDRIG visa godk√§nda betyg - endast F-betyg och F-varningar
            if (activeGradeTypeFilter === 'both') {
                // Visa b√•de F-betyg och F-varningar (INTE godk√§nda)
                classDatasets.push({
                    label: 'F-betyg',
                    data: classDataFailing,
                    backgroundColor: '#f87171',
                    borderColor: '#ef4444',
                    borderWidth: 1
                });
                classDatasets.push({
                    label: 'F-varningar',
                    data: classDataWarnings,
                    backgroundColor: '#fb923c',
                    borderColor: '#f97316',
                    borderWidth: 1
                });
            } else if (activeGradeTypeFilter === 'warnings') {
                // Only show F-varningar when filtering for warnings
                classDatasets.push({
                    label: 'F-varningar',
                    data: classDataFailing,
                    backgroundColor: '#fb923c',
                    borderColor: '#f97316',
                    borderWidth: 1
                });
            } else {
                // Only show F-betyg when filtering for grades
                classDatasets.push({
                    label: 'F-betyg',
                    data: classDataFailing,
                    backgroundColor: '#f87171',
                    borderColor: '#ef4444',
                    borderWidth: 1
                });
            }
            
            const classCtx = document.getElementById('class-chart').getContext('2d');
            classChart = new Chart(classCtx, {
                type: 'bar',
                data: {
                    labels: classLabels,
                    datasets: classDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    }
                }
            });
            
            // Update course chart
            if (courseChart) {
                courseChart.destroy();
            }
            
            // Build datasets based on active filter
            const courseDatasets = [];
            
            // ALDRIG visa godk√§nda betyg - endast F-betyg och F-varningar
            if (activeGradeTypeFilter === 'both') {
                // Visa b√•de F-betyg och F-varningar (INTE godk√§nda)
                courseDatasets.push({
                    label: 'F-betyg',
                    data: courseDataFailing,
                    backgroundColor: '#f87171',
                    borderColor: '#ef4444',
                    borderWidth: 1
                });
                courseDatasets.push({
                    label: 'F-varningar',
                    data: courseDataWarnings,
                    backgroundColor: '#fb923c',
                    borderColor: '#f97316',
                    borderWidth: 1
                });
            } else if (activeGradeTypeFilter === 'warnings') {
                // Only show F-varningar when filtering for warnings
                courseDatasets.push({
                    label: 'F-varningar',
                    data: courseDataFailing,
                    backgroundColor: '#fb923c',
                    borderColor: '#f97316',
                    borderWidth: 1
                });
            } else {
                // Only show F-betyg when filtering for grades
                courseDatasets.push({
                    label: 'F-betyg',
                    data: courseDataFailing,
                    backgroundColor: '#f87171',
                    borderColor: '#ef4444',
                    borderWidth: 1
                });
            }
            
            const courseCtx = document.getElementById('course-chart').getContext('2d');
            courseChart = new Chart(courseCtx, {
                type: 'bar',
                data: {
                    labels: courseLabels,
                    datasets: courseDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e0e0e0' : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        // Removed: updateGradeDistributionChart() and updateTrendChart() functions
        // Graferna "Betygsf√∂rdelning" och "Trend √∂ver kvartal" √§r helt borttagna
        
        function exportWarningsReport() {
            // Filter F grades based on current filters
            let fGrades = grades.filter(g => g.grade === 'F');
            
            const classFilter = warningClassFilter.value;
            const courseFilter = warningCourseFilter.value;
            
            // Apply class filter if provided
            if (classFilter) {
                const studentIdsInClass = students
                    .filter(s => s.class_id === classFilter)
                    .map(s => s.id);
                
                fGrades = fGrades.filter(g => studentIdsInClass.includes(g.student_id));
            }
            
            // Apply course filter if provided
            if (courseFilter) {
                fGrades = fGrades.filter(g => g.course_id === courseFilter);
            }
            
            // Create report data
            const reportData = fGrades.map(g => {
                const student = students.find(s => s.id === g.student_id);
                const course = courses.find(c => c.id === g.course_id);
                const classObj = student ? classes.find(c => c.id === student.class_id) : null;
                const teacherInfo = teachers[g.teacher_id] || { name: 'Ok√§nd l√§rare', role: 'admin' };
                const quarter = quarters.find(q => q.id === g.quarter_id);
                
                return {
                    student: student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd elev',
                    class: classObj ? classObj.name : '-',
                    course: course ? `${course.code} - ${course.name}` : 'Ok√§nd kurs',
                    grade: 'F',
                    teacher: teacherInfo.name,
                    teacherRole: teacherInfo.role,
                    quarter: quarter ? quarter.name : 'Ok√§nt kvartal',
                    date: new Date(g.updated_at).toLocaleDateString()
                };
            });
            
            // Create CSV content
            let csvContent = 'Elev,Klass,Kurs,Betyg,L√§rare,L√§rarroll,Kvartal,Datum\n';
            
            reportData.forEach(row => {
                csvContent += `"${row.student}","${row.class}","${row.course}","${row.grade}","${row.teacher}","${row.teacherRole}","${row.quarter}","${row.date}"\n`;
            });
            
            // Create blob and download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // Open in new window instead of downloading directly
            window.open(url, '_blank');
            
            // Revoke the URL to free memory
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        function exportProgressReport() {
            // Get improvements (from F to any other grade)
            const improvements = gradeHistory.filter(h => h.from_grade === 'F');
            
            // Create report data
            const reportData = improvements.map(improvement => {
                const student = students.find(s => s.id === improvement.student_id);
                const course = courses.find(c => c.id === improvement.course_id);
                const classObj = student ? classes.find(c => c.id === student.class_id) : null;
                const teacherInfo = teachers[improvement.teacher_id] || { name: 'Ok√§nd l√§rare', role: 'admin' };
                const quarter = quarters.find(q => q.id === improvement.quarter_id);
                
                return {
                    student: student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd elev',
                    class: classObj ? classObj.name : '-',
                    course: course ? `${course.code} - ${course.name}` : 'Ok√§nd kurs',
                    from_grade: improvement.from_grade,
                    to_grade: improvement.to_grade,
                    teacher: teacherInfo.name,
                    teacherRole: teacherInfo.role,
                    quarter: quarter ? quarter.name : 'Ok√§nt kvartal',
                    date: new Date(improvement.created_at).toLocaleDateString()
                };
            });
            
            // Create CSV content
            let csvContent = 'Elev,Klass,Kurs,Fr√•n betyg,Till betyg,L√§rare,L√§rarroll,Kvartal,Datum\n';
            
            reportData.forEach(row => {
                csvContent += `"${row.student}","${row.class}","${row.course}","${row.from_grade}","${row.to_grade}","${row.teacher}","${row.teacherRole}","${row.quarter}","${row.date}"\n`;
            });
            
            // Create blob and download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // Open in new window instead of downloading directly
            window.open(url, '_blank');
            
            // Revoke the URL to free memory
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Event listeners
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        
        // Export menu toggle
        document.getElementById('export-warnings-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleExportMenu();
        });
        
        // Advanced filters toggle
        document.getElementById('toggle-advanced-filters').addEventListener('click', () => {
            const advancedFilters = document.getElementById('advanced-filters');
            const toggleBtn = document.getElementById('toggle-advanced-filters');
            
            advancedFilters.classList.toggle('hidden');
            
            if (advancedFilters.classList.contains('hidden')) {
                toggleBtn.innerHTML = '<i class="fas fa-cog mr-1"></i> Fler alternativ';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-cog mr-1"></i> F√§rre alternativ';
            }
        });
        
        // Reset filters
        document.getElementById('reset-filters-btn').addEventListener('click', () => {
            document.getElementById('warning-class-filter').value = '';
            document.getElementById('warning-course-filter').value = '';
            document.getElementById('student-search').value = '';
            document.getElementById('grade-filter').value = '';
            document.getElementById('quarter-filter').value = '';
            document.getElementById('sort-by').value = 'student';
            
            // Apply reset filters (this will restore original charts)
            applyAdvancedFilters();
            showInfoNotification('Filter har √•terst√§llts');
        });
        
        // Student search with debounce
        let searchTimeout;
        document.getElementById('student-search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyAdvancedFilters();
            }, 300);
        });
        
        // Add event listeners for all filter changes
        document.getElementById('warning-class-filter').addEventListener('change', applyAdvancedFilters);
        document.getElementById('warning-course-filter').addEventListener('change', applyAdvancedFilters);
        document.getElementById('grade-filter').addEventListener('change', applyAdvancedFilters);
        document.getElementById('quarter-filter').addEventListener('change', applyAdvancedFilters);
        document.getElementById('sort-by').addEventListener('change', applyAdvancedFilters);
        
        // Apply filters button
        document.getElementById('apply-filters-btn').addEventListener('click', applyAdvancedFilters);
        
        // Grade type toggle buttons
        document.querySelectorAll('.grade-type-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const type = button.dataset.type;
                
                // Update active state
                document.querySelectorAll('.grade-type-toggle').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
                
                // Update global filter
                activeGradeTypeFilter = type;
                
                // Reload data with new filter
                loadWarningsData();
            });
        });
        
        // Clean duplicates button
        document.getElementById('clean-duplicates-btn').addEventListener('click', async () => {
            const confirmed = confirm('√Ñr du s√§ker p√• att du vill rensa dubbletter i betygsutvecklingen? Detta kan inte √•ngras.');
            if (confirmed) {
                await cleanDuplicateImprovements();
            }
        });
        
        // üì∏ SNAPSHOT MODAL EVENT LISTENERS
        document.getElementById('create-snapshot-btn')?.addEventListener('click', () => {
            if (!activeQuarter) {
                showError('Inget aktivt kvartal. Skapa eller aktivera ett kvartal f√∂rst.');
                return;
            }
            document.getElementById('create-snapshot-modal').classList.remove('hidden');
            document.getElementById('snapshot-name').value = '';
            document.getElementById('snapshot-notes').value = '';
            document.getElementById('snapshot-name').focus();
        });
        
        document.getElementById('close-snapshot-modal-btn')?.addEventListener('click', () => {
            document.getElementById('create-snapshot-modal').classList.add('hidden');
        });
        
        document.getElementById('cancel-snapshot-btn')?.addEventListener('click', () => {
            document.getElementById('create-snapshot-modal').classList.add('hidden');
        });
        
        document.getElementById('confirm-snapshot-btn')?.addEventListener('click', async () => {
            const name = document.getElementById('snapshot-name').value;
            const notes = document.getElementById('snapshot-notes').value;
            
            if (!name || name.trim() === '') {
                showError('Du m√•ste ange ett namn f√∂r snapshoten.');
                return;
            }
            
            const success = await createManualSnapshot(name, notes);
            
            if (success) {
                document.getElementById('create-snapshot-modal').classList.add('hidden');
                // Refresh snapshots view if currently visible
                const snapshotsView = document.getElementById('snapshots-view');
                if (snapshotsView && !snapshotsView.classList.contains('hidden')) {
                    await renderSnapshots();
                }
            }
        });
        
        // Close snapshot details modal
        document.getElementById('close-snapshot-details-btn')?.addEventListener('click', () => {
            document.getElementById('snapshot-details-modal').classList.add('hidden');
        });
        
        // Tab navigation
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveTab(button.dataset.tab);
            });
        });
        
        // Archive sub-tabs navigation
        document.querySelectorAll('.archive-sub-tab').forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.archiveTab;
                
                // Update sub-tab buttons
                document.querySelectorAll('.archive-sub-tab').forEach(btn => {
                    if (btn.dataset.archiveTab === targetTab) {
                        btn.classList.add('archive-tab-active');
                    } else {
                        btn.classList.remove('archive-tab-active');
                    }
                });
                
                // Show/hide archive content
                document.querySelectorAll('.archive-content').forEach(content => {
                    if (content.id === targetTab) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
                
                // Load appropriate content
                if (targetTab === 'archived-students') {
                    renderArchivedStudents();
                } else if (targetTab === 'archived-courses') {
                    renderArchivedCourses();
                } else if (targetTab === 'archived-classes') {
                    renderArchivedClasses();
                } else if (targetTab === 'snapshots-view') {
                    renderSnapshots();
                } else if (targetTab === 'comparison-view') {
                    initializeComparisonView();
                }
            });
        });
        
        // Archive-specific event listeners
        document.getElementById('archive-search-students')?.addEventListener('input', (e) => {
            searchArchivedStudents(e.target.value);
        });
        
        document.getElementById('bulk-archive-class-btn')?.addEventListener('click', () => {
            bulkArchiveClass();
        });
        
        document.getElementById('bulk-reactivate-students-btn')?.addEventListener('click', () => {
            bulkReactivateArchivedStudents();
        });
        
        document.getElementById('compare-snapshots-btn')?.addEventListener('click', () => {
            const snapshot1 = document.getElementById('compare-snapshot-1').value;
            const snapshot2 = document.getElementById('compare-snapshot-2').value;
            compareSnapshots(snapshot1, snapshot2);
        });
        
        // Comparison View event listeners
        document.querySelectorAll('.comparison-type-btn').forEach(btn => {
            btn.addEventListener('click', () => switchComparisonType(btn.dataset.type));
        });
        
        document.getElementById('run-snapshot-comparison-btn')?.addEventListener('click', runSnapshotComparison);
        document.getElementById('run-class-comparison-btn')?.addEventListener('click', runClassComparison);
        document.getElementById('run-course-comparison-btn')?.addEventListener('click', runCourseComparison);
        
        // Warning filters
        applyFiltersBtn.addEventListener('click', () => {
            loadWarningsData(warningClassFilter.value, warningCourseFilter.value);
        });
        
        refreshWarningsBtn.addEventListener('click', async () => {
            // Reload all data and refresh warnings
            await Promise.all([
                fetchGrades(),
                fetchStudents(),
                fetchClasses(),
                fetchCourses()
            ]);
            
            loadWarningsData(warningClassFilter.value, warningCourseFilter.value);
        });
        
        exportWarningsBtn.addEventListener('click', exportWarningsReport);
        
        // Progress tab actions
        refreshProgressBtn.addEventListener('click', loadProgressData);
        exportProgressBtn.addEventListener('click', exportProgressReport);
        

        
        // Student detail modal close events
        closeModalBtn.addEventListener('click', () => {
            studentDetailModal.classList.add('hidden');
        });
        
        modalCloseBtn.addEventListener('click', () => {
            studentDetailModal.classList.add('hidden');
        });
        
        // Close modal when clicking outside
        studentDetailModal.addEventListener('click', (e) => {
            if (e.target === studentDetailModal) {
                studentDetailModal.classList.add('hidden');
            }
        });
        
        // "Select All" and "Clear All" class checkboxes functionality
        selectAllClassesBtn.addEventListener('click', () => {
            selectedClassIds = classes.map(c => c.id);
            document.querySelectorAll('.class-filter-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            filterWarningsBySelectedClasses();
        });
        
        clearAllClassesBtn.addEventListener('click', () => {
            selectedClassIds = [];
            document.querySelectorAll('.class-filter-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            filterWarningsBySelectedClasses();
        });
        
        // Class form events
        addClassBtn.addEventListener('click', () => {
            if (!userCan('manage_classes')) {
                showError('Du har inte beh√∂righet att l√§gga till klasser.');
                return;
            }
            
            classFormContainer.classList.remove('hidden');
            document.getElementById('class-name').value = '';
            document.getElementById('class-name').focus();
        });
        
        cancelClassBtn.addEventListener('click', () => {
            classFormContainer.classList.add('hidden');
        });
        
        classForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userCan('manage_classes')) {
                showError('Du har inte beh√∂righet att l√§gga till klasser.');
                return;
            }
            
            const className = document.getElementById('class-name').value.trim();
            
            if (!className) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('classes')
                    .insert([{ name: className }])
                    .select();
                
                if (error) throw error;
                
                await fetchClasses();
                updateUI();
                classFormContainer.classList.add('hidden');
            } catch (error) {
                showError('Kunde inte skapa klass: ' + error.message);
            }
        });
        
        // Edit class events
        cancelEditClassBtn.addEventListener('click', () => {
            editClassFormContainer.classList.add('hidden');
        });

        editClassForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userCan('manage_classes')) {
                showError('Du har inte beh√∂righet att redigera klasser.');
                return;
            }
            
            const classId = editClassId.value;
            const className = editClassName.value.trim();
            
            if (!className) return;
            
            // Get selected courses
            const selectedCourseIds = [...document.querySelectorAll('.edit-class-course-checkbox:checked')]
                .map(cb => cb.value);
            
            await updateClass(classId, className, selectedCourseIds);
        });
        
        // Course form events
        addCourseBtn.addEventListener('click', () => {
            if (!userCan('manage_courses')) {
                showError('Du har inte beh√∂righet att l√§gga till kurser.');
                return;
            }
            
            courseFormContainer.classList.remove('hidden');
            document.getElementById('course-code').value = '';
            document.getElementById('course-name').value = '';
            renderCourseClassCheckboxes();
            document.getElementById('course-code').focus();
        });
        
        cancelCourseBtn.addEventListener('click', () => {
            courseFormContainer.classList.add('hidden');
        });
        
        courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userCan('manage_courses')) {
                showError('Du har inte beh√∂righet att l√§gga till kurser.');
                return;
            }
            
            const courseCode = document.getElementById('course-code').value.trim();
            const courseName = document.getElementById('course-name').value.trim();
            
            if (!courseCode || !courseName) return;
            
            try {
                // Insert course
                const { data: courseData, error: courseError } = await supabaseClient
                    .from('courses')
                    .insert([{ code: courseCode, name: courseName }])
                    .select();
                
                if (courseError) throw courseError;
                
                const courseId = courseData[0].id;
                
                // Get selected classes
                const selectedClassIds = [...document.querySelectorAll('.course-class-checkbox:checked')]
                    .map(cb => cb.value);
                
                if (selectedClassIds.length > 0) {
                    // Create class mappings
                    const mappings = selectedClassIds.map(classId => ({
                        course_id: courseId,
                        class_id: classId
                    }));
                    
                    const { error: mappingError } = await supabaseClient
                        .from('course_class')
                        .insert(mappings);
                    
                    if (mappingError) throw mappingError;
                }
                
                await Promise.all([
                    fetchCourses(),
                    fetchClassCourseMappings()
                ]);
                
                updateUI();
                courseFormContainer.classList.add('hidden');
                await loadWarningsData();
            } catch (error) {
                showError('Kunde inte skapa kurs: ' + error.message);
            }
        });
        
        // Student form events
        addStudentBtn.addEventListener('click', () => {
            if (!userCan('manage_students')) {
                showError('Du har inte beh√∂righet att l√§gga till elever.');
                return;
            }
            
            studentFormContainer.classList.remove('hidden');
            document.getElementById('student-firstname').value = '';
            document.getElementById('student-lastname').value = '';
            document.getElementById('student-class').value = '';
            document.getElementById('student-firstname').focus();
        });
        
        cancelStudentBtn.addEventListener('click', () => {
            studentFormContainer.classList.add('hidden');
        });
        
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userCan('manage_students')) {
                showError('Du har inte beh√∂righet att l√§gga till elever.');
                return;
            }
            
            const firstName = document.getElementById('student-firstname').value.trim();
            const lastName = document.getElementById('student-lastname').value.trim();
            const classId = document.getElementById('student-class').value;
            
            if (!firstName || !lastName) return;
            
            try {
                const { error } = await supabaseClient
                    .from('students')
                    .insert([{
                        first_name: firstName,
                        last_name: lastName,
                        class_id: classId || null
                    }]);
                
                if (error) throw error;
                
                await fetchStudents();
                renderStudents(filterClass.value);
                studentFormContainer.classList.add('hidden');
                await loadWarningsData();
            } catch (error) {
                showError('Kunde inte skapa elev: ' + error.message);
            }
        });
        
        // Quarter form events
        addQuarterBtn.addEventListener('click', () => {
            if (!userCan('manage_quarters')) {
                showError('Du har inte beh√∂righet att l√§gga till kvartal.');
                return;
            }
            
            quarterFormContainer.classList.remove('hidden');
            document.getElementById('quarter-name').value = '';
            document.getElementById('quarter-description').value = '';
            document.getElementById('quarter-is-active').checked = false;
            document.getElementById('quarter-name').focus();
        });
        
        cancelQuarterBtn.addEventListener('click', () => {
            quarterFormContainer.classList.add('hidden');
        });
        
        quarterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userCan('manage_quarters')) {
                showError('Du har inte beh√∂righet att l√§gga till kvartal.');
                return;
            }
            
            const quarterName = document.getElementById('quarter-name').value.trim();
            const description = document.getElementById('quarter-description').value.trim();
            const isActive = document.getElementById('quarter-is-active').checked;
            
            if (!quarterName) return;
            
            try {
                // If setting as active, first set all others to inactive
                if (isActive) {
                    const { error: resetError } = await supabaseClient
                        .from('quarters')
                        .update({ is_active: false })
                        .eq('is_active', true); // Only update currently active quarters
                    
                    if (resetError) throw resetError;
                }
                
                // Insert new quarter
                const { data, error } = await supabaseClient
                    .from('quarters')
                    .insert([{
                        name: quarterName,
                        description: description || null,
                        is_active: isActive
                    }])
                    .select();
                
                if (error) throw error;
                
                await fetchQuarters();
                renderQuartersList();
                quarterFormContainer.classList.add('hidden');
                
                // Refresh grades if a new active quarter was set
                if (isActive) {
                    await fetchGrades();
                    await loadWarningsData();
                }
            } catch (error) {
                showError('Kunde inte skapa kvartal: ' + error.message);
            }
        });
        

        

        
        // Quarter comparison
        compareQuartersBtn.addEventListener('click', () => {
            const fromId = compareFromQuarter.value;
            const toId = compareToQuarter.value;
            
            if (fromId && toId) {
                compareQuarters(fromId, toId);
            } else {
                showError('V√§lj b√•de fr√•n- och till-kvartal f√∂r att g√∂ra en j√§mf√∂relse.');
            }
        });
        
        // Filter students by class
        filterClass.addEventListener('change', () => {
            renderStudents(filterClass.value);
        });
        
        // Grade selection events
        gradeClass.addEventListener('change', async () => {
            await updateGradeCourses();
            gradeStudentContainer.classList.add('hidden');
        });
        
        gradeCourse.addEventListener('change', () => {
            renderGradeStudents();
        });
        
        // Check if user is already logged in
        async function checkSession() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                userEmail.textContent = currentUser.email;
                setUserAvatar(currentUser.email);
                
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                
                // VIKTIGT: S√§tt anv√§ndarroll F√ñRST innan allt annat!
                await fetchUserRole();
                console.log('üîç Session check - User role set to:', userRole, 'for user:', currentUser.email);
                
                // Load critical data first with progress tracking
                await fetchWithProgress('roles', fetchRoles);
                await fetchWithProgress('quarters', fetchQuarters);
                
                // Load remaining data in background
                loadRemainingData();
                
                updateUI();
                updateUIBasedOnRole();
                
                // Re-enable all controls after UI is built (for admin override)
                setTimeout(async () => {
                    reEnableAllControls();
                    await renderGradeDropdowns();
                }, 1000);
                
                await loadWarningsData();
            }
        }
        
        // Update charts when switching to dark/light mode
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (classChart || courseChart) {
                updateCharts();
            }
            
            if (classProgressChart || courseProgressChart) {
                loadProgressData();
            }
            
            if (quarterComparisonChart && !quarterComparisonChart.classList.contains('hidden')) {
                const fromId = compareFromQuarter.value;
                const toId = compareToQuarter.value;
                if (fromId && toId) {
                    compareQuarters(fromId, toId);
                }
            }
        });
        
        // Touch/swipe support for mobile tab navigation
        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;
        
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isSwiping = false;
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!touchStartX || !touchStartY) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const diffX = touchStartX - touchX;
            const diffY = touchStartY - touchY;
            
            // Check if horizontal swipe is more prominent than vertical
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
                isSwiping = true;
                e.preventDefault(); // Prevent scrolling while swiping
            }
        });
        
        document.addEventListener('touchend', (e) => {
            if (!touchStartX || !touchStartY || !isSwiping) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            // Only handle horizontal swipes that are significant
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                const tabs = ['warnings-tab', 'progress-tab', 'classes-tab', 'courses-tab', 'students-tab', 'grades-tab', 'quarters-tab'];
                const activeTab = document.querySelector('.tab-button.tab-active')?.dataset.tab;
                const currentIndex = tabs.indexOf(activeTab);
                
                if (currentIndex !== -1) {
                    let newIndex;
                    if (diffX > 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - next tab
                        newIndex = currentIndex + 1;
                    } else if (diffX < 0 && currentIndex > 0) {
                        // Swipe right - previous tab
                        newIndex = currentIndex - 1;
                    }
                    
                    if (newIndex !== undefined) {
                        setActiveTab(tabs[newIndex]);
                        showInfoNotification(`Navigerade till ${getTabName(tabs[newIndex])}`);
                    }
                }
            }
            
            // Reset values
            touchStartX = 0;
            touchStartY = 0;
            isSwiping = false;
        });
        
        function getTabName(tabId) {
            const tabNames = {
                'warnings-tab': 'F-varningar',
                'progress-tab': 'Elevutveckling',
                'classes-tab': 'Klasser',
                'courses-tab': 'Kurser',
                'students-tab': 'Elever',
                'grades-tab': 'Betygs√§ttning',
                'quarters-tab': 'Kvartal'
            };
            return tabNames[tabId] || tabId;
        }
        
        // Progress tracking
        let loadingProgress = {
            total: 6,
            completed: 0,
            steps: ['roles', 'quarters', 'classes', 'courses', 'students', 'grades']
        };
        
        function showDetailedLoading() {
            document.getElementById('detailed-loading').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }
        
        function hideDetailedLoading() {
            document.getElementById('detailed-loading').classList.add('hidden');
        }
        
        function updateLoadingProgress(stepName, status = 'completed') {
            const step = document.querySelector(`[data-step="${stepName}"]`);
            const progressBar = document.getElementById('progress-bar-fill');
            
            if (step) {
                // Update step status
                step.classList.remove('pending', 'active', 'completed');
                step.classList.add(status);
                
                const icon = step.querySelector('.loading-step-icon');
                
                if (status === 'active') {
                    icon.innerHTML = '<div class="loading-step-spinner"></div>';
                } else if (status === 'completed') {
                    icon.innerHTML = '<i class="fas fa-check"></i>';
                    loadingProgress.completed++;
                } else if (status === 'error') {
                    icon.innerHTML = '<i class="fas fa-times"></i>';
                    step.classList.add('text-red-600');
                }
                
                // Update progress bar
                const percentage = (loadingProgress.completed / loadingProgress.total) * 100;
                progressBar.style.width = `${percentage}%`;
                
                // Hide detailed loading when complete
                if (loadingProgress.completed >= loadingProgress.total) {
                    setTimeout(() => {
                        hideDetailedLoading();
                    }, 1000);
                }
            }
        }
        
        // Enhanced data fetching with progress tracking
        async function fetchWithProgress(stepName, fetchFunction) {
            updateLoadingProgress(stepName, 'active');
            try {
                const result = await fetchFunction();
                updateLoadingProgress(stepName, 'completed');
                return result;
            } catch (error) {
                updateLoadingProgress(stepName, 'error');
                throw error;
            }
        }
        
        // Lazy loading function for non-critical data
        async function loadRemainingData() {
            try {
                showDetailedLoading();
                
                // Load data with progress tracking
                await fetchWithProgress('classes', fetchClasses);
                await fetchWithProgress('courses', fetchCourses);
                await fetchClassCourseMappings(); // Critical for grade dropdown functionality
                await fetchWithProgress('students', fetchStudents);
                await fetchWithProgress('grades', fetchGrades);
                
                // Update UI after all data is loaded
                updateUI();
                showSuccessNotification('All data har laddats!');
                
            } catch (error) {
                handleError(error, 'Bakgrundsladdning av data');
            }
        }
        
        // Tab-specific data loading
        const tabDataLoaders = {
            'warnings-tab': async () => {
                if (grades.length === 0) await fetchGrades();
                if (students.length === 0) await fetchStudents();
                await loadWarningsData();
            },
            'progress-tab': async () => {
                if (gradeHistory.length === 0) await fetchGradeHistory();
                await loadProgressData();
            },
            'classes-tab': async () => {
                if (classes.length === 0) await fetchClasses();
                if (classCourseMappings.length === 0) await fetchClassCourseMappings();
                renderClasses();
            },
            'courses-tab': async () => {
                if (courses.length === 0) await fetchCourses();
                renderCourses();
            },
            'students-tab': async () => {
                if (students.length === 0) await fetchStudents();
                renderStudents();
            },
            'grades-tab': async () => {
                if (classes.length === 0) await fetchClasses();
                if (courses.length === 0) await fetchCourses();
                if (students.length === 0) await fetchStudents();
                renderGradeDropdowns();
            },
            'quarters-tab': async () => {
                renderQuartersList();
            }
        };
        
        // Enhanced tab switching with lazy loading
        function setActiveTab(tabId) {
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('tab-active');
                } else {
                    btn.classList.remove('tab-active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('hidden');
                    content.classList.add('fade-in');
                    
                    // Load tab-specific data if needed
                    if (tabDataLoaders[tabId]) {
                        tabDataLoaders[tabId]().catch(error => {
                            handleError(error, `Laddning av ${tabId} data`);
                        });
                    }
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('fade-in');
                }
            });
            
        }
        
        // Export functionality
        function exportWarningsToExcel() {
            try {
                const warningsData = [];
                
                // Get F-warnings data with grade type filter
                const fWarnings = grades.filter(g => {
                    if (g.grade !== 'F') return false;
                    
                    // Apply grade type filter
                    if (activeGradeTypeFilter === 'grades' && g.grade_type === 'warning') return false;
                    if (activeGradeTypeFilter === 'warnings' && g.grade_type !== 'warning') return false;
                    
                    return true;
                });
                
                fWarnings.forEach(warning => {
                    const student = students.find(s => s.id === warning.student_id);
                    const course = courses.find(c => c.id === warning.course_id);
                    const classObj = student ? classes.find(c => c.id === student.class_id) : null;
                    const gradeType = warning.grade_type === 'warning' ? 'F-varning' : 'F-betyg';
                    const studentName = student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd';
                    
                    warningsData.push({
                        'Elev': studentName,
                        'Klass': classObj ? classObj.name : 'Ok√§nd',
                        'Kurs': course ? course.name : 'Ok√§nd',
                        'Kurskod': course ? course.code : 'Ok√§nd',
                        'Typ': gradeType,
                        'Betyg': warning.grade,
                        'Datum': new Date().toLocaleDateString('sv-SE')
                    });
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(warningsData);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'F-varningar');
                
                // Save file
                XLSX.writeFile(wb, `F-varningar_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showSuccessNotification('Excel-fil har exporterats!');
                toggleExportMenu();
            } catch (error) {
                handleError(error, 'Excel-export');
            }
        }
        
        function exportWarningsToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('F-varningar Rapport', 20, 30);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Genererad: ${new Date().toLocaleDateString('sv-SE')}`, 20, 45);
                
                // Add summary
                const fWarnings = grades.filter(g => g.grade === 'F');
                doc.text(`Totalt antal F-varningar: ${fWarnings.length}`, 20, 60);
                
                // Add warnings list
                let yPos = 80;
                doc.setFontSize(10);
                
                fWarnings.slice(0, 30).forEach(warning => { // Limit to first 30 for PDF
                    const student = students.find(s => s.id === warning.student_id);
                    const course = courses.find(c => c.id === warning.course_id);
                    const classObj = student ? classes.find(c => c.id === student.class_id) : null;
                    const studentName = student ? `${student.first_name} ${student.last_name}` : 'Ok√§nd';
                    
                    const line = `${studentName} (${classObj?.name || 'Ok√§nd'}) - ${course?.name || 'Ok√§nd'}`;
                    
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    doc.text(line, 20, yPos);
                    yPos += 8;
                });
                
                if (fWarnings.length > 30) {
                    doc.text(`... och ${fWarnings.length - 30} fler`, 20, yPos + 10);
                }
                
                // Save PDF
                doc.save(`F-varningar_${new Date().toISOString().split('T')[0]}.pdf`);
                
                showSuccessNotification('PDF har exporterats!');
                toggleExportMenu();
            } catch (error) {
                handleError(error, 'PDF-export');
            }
        }
        
        function exportChartsToImage() {
            try {
                const charts = [
                    { chart: classChart, name: 'F-varningar_per_klass' },
                    { chart: courseChart, name: 'F-varningar_per_kurs' },
                    { chart: gradeDistributionChart, name: 'Betygsf√∂rdelning' },
                    { chart: trendChart, name: 'Trend_√∂ver_kvartal' }
                ];
                
                charts.forEach(({ chart, name }) => {
                    if (chart) {
                        const canvas = chart.canvas;
                        const link = document.createElement('a');
                        link.download = `${name}_${new Date().toISOString().split('T')[0]}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                });
                
                showSuccessNotification('Grafbilder har exporterats!');
                toggleExportMenu();
            } catch (error) {
                handleError(error, 'Graf-export');
            }
        }
        
        function toggleExportMenu() {
            const menu = document.getElementById('export-warnings-menu');
            menu.classList.toggle('hidden');
        }
        
        // Close export menu when clicking outside
        document.addEventListener('click', (e) => {
            const exportBtn = document.getElementById('export-warnings-btn');
            const exportMenu = document.getElementById('export-warnings-menu');
            
            if (!exportBtn.contains(e.target) && !exportMenu.contains(e.target)) {
                exportMenu.classList.add('hidden');
            }
        });
        
        // Advanced filtering function
        function applyAdvancedFilters() {
            const classFilter = document.getElementById('warning-class-filter').value;
            const courseFilter = document.getElementById('warning-course-filter').value;
            const studentSearch = document.getElementById('student-search').value.toLowerCase();
            const gradeFilter = document.getElementById('grade-filter').value;
            const quarterFilter = document.getElementById('quarter-filter').value;
            const sortBy = document.getElementById('sort-by').value;
            
            // Check if any filters are active
            const hasActiveFilters = classFilter || courseFilter || studentSearch || gradeFilter || quarterFilter;
            
            // Filter grades based on criteria
            let filteredGrades = grades.filter(grade => {
                const student = students.find(s => s.id === grade.student_id);
                const course = courses.find(c => c.id === grade.course_id);
                const classObj = student ? classes.find(cl => cl.id === student.class_id) : null;
                
                // Apply filters
                if (classFilter && (!classObj || classObj.id !== classFilter)) return false;
                if (courseFilter && grade.course_id !== courseFilter) return false;
                if (gradeFilter && grade.grade !== gradeFilter) return false;
                if (quarterFilter && grade.quarter_id !== quarterFilter) return false;
                if (studentSearch && (!student || !student.name.toLowerCase().includes(studentSearch))) return false;
                
                return true;
            });
            
            // Sort filtered results
            filteredGrades.sort((a, b) => {
                const studentA = students.find(s => s.id === a.student_id);
                const studentB = students.find(s => s.id === b.student_id);
                const courseA = courses.find(c => c.id === a.course_id);
                const courseB = courses.find(c => c.id === b.course_id);
                const classA = studentA ? classes.find(cl => cl.id === studentA.class_id) : null;
                const classB = studentB ? classes.find(cl => cl.id === studentB.class_id) : null;
                
                switch (sortBy) {
                    case 'student':
                        return (studentA?.name || '').localeCompare(studentB?.name || '');
                    case 'class':
                        return (classA?.name || '').localeCompare(classB?.name || '');
                    case 'course':
                        return (courseA?.name || '').localeCompare(courseB?.name || '');
                    case 'grade':
                        return a.grade.localeCompare(b.grade);
                    default:
                        return 0;
                }
            });
            
            // Update the warnings table with filtered results
            renderFilteredWarnings(filteredGrades);
            
            // Update charts and widgets
            if (hasActiveFilters) {
                // Update with filtered data
                updateChartsWithFilteredData(filteredGrades);
                updateDashboardWidgetsWithFilteredData(filteredGrades);
                
                // Show filter summary
                const totalGrades = grades.length;
                const filteredCount = filteredGrades.length;
                showInfoNotification(`Visar ${filteredCount} av ${totalGrades} resultat`);
            } else {
                // No filters active, restore original charts and widgets
                updateCharts();
                updateDashboardWidgets();
            }
        }
        
        function renderFilteredWarnings(filteredGrades) {
            const warningsTable = document.getElementById('warnings-table-body');
            if (!warningsTable) return;
            
            warningsTable.innerHTML = '';
            
            if (filteredGrades.length === 0) {
                warningsTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-search mb-2 text-2xl"></i>
                            <p>Inga resultat hittades f√∂r de valda filtren</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredGrades.forEach(grade => {
                const student = students.find(s => s.id === grade.student_id);
                const course = courses.find(c => c.id === grade.course_id);
                const classObj = student ? classes.find(cl => cl.id === student.class_id) : null;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                
                const gradeColor = {
                    'F': 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-200',
                    'E': 'text-orange-600 bg-orange-100 dark:bg-orange-900 dark:text-orange-200',
                    'D': 'text-yellow-600 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-200',
                    'C': 'text-blue-600 bg-blue-100 dark:bg-blue-900 dark:text-blue-200',
                    'B': 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-200',
                    'A': 'text-emerald-600 bg-emerald-100 dark:bg-emerald-900 dark:text-emerald-200'
                }[grade.grade] || '';
                
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${student?.name || 'Ok√§nd'}</td>
                    <td class="px-4 py-3">${classObj?.name || 'Ok√§nd'}</td>
                    <td class="px-4 py-3">${course?.name || 'Ok√§nd'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${gradeColor}">
                            ${grade.grade}
                        </span>
                    </td>
                `;
                
                warningsTable.appendChild(row);
            });
        }
        
        // Update charts with filtered data
        function updateChartsWithFilteredData(filteredGrades) {
            // Prepare data for class chart with filtered grades
            const classLabels = [];
            const classDataPassing = [];
            const classDataFailing = [];
            
            classes.forEach(c => {
                classLabels.push(c.name);
                
                // Count filtered grades in this class
                const classGrades = filteredGrades.filter(g => {
                    const student = students.find(s => s.id === g.student_id);
                    return student && student.class_id === c.id;
                });
                
                // Count F grades in this class
                const classFGrades = classGrades.filter(g => g.grade === 'F').length;
                
                // Count passing grades in this class
                const classPassingGrades = classGrades.length - classFGrades;
                
                classDataPassing.push(classPassingGrades);
                classDataFailing.push(classFGrades);
            });
            
            // Update class chart
            if (classChart) {
                classChart.data.labels = classLabels;
                classChart.data.datasets[0].data = classDataPassing;
                classChart.data.datasets[1].data = classDataFailing;
                classChart.update();
            }
            
            // Prepare data for course chart with filtered grades
            const courseFCounts = {};
            filteredGrades.filter(g => g.grade === 'F').forEach(grade => {
                courseFCounts[grade.course_id] = (courseFCounts[grade.course_id] || 0) + 1;
            });
            
            const coursePassingCounts = {};
            filteredGrades.filter(g => g.grade !== 'F').forEach(grade => {
                coursePassingCounts[grade.course_id] = (coursePassingCounts[grade.course_id] || 0) + 1;
            });
            
            // Get top 10 courses by total grade count
            const courseGradeCounts = {};
            courses.forEach(c => {
                const courseGrades = filteredGrades.filter(g => g.course_id === c.id);
                if (courseGrades.length > 0) {
                    courseGradeCounts[c.id] = {
                        name: c.name,
                        totalGrades: courseGrades.length,
                        fGrades: courseFCounts[c.id] || 0,
                        passingGrades: coursePassingCounts[c.id] || 0
                    };
                }
            });
            
            const topCourses = Object.entries(courseGradeCounts)
                .sort((a, b) => b[1].totalGrades - a[1].totalGrades)
                .slice(0, 10);
            
            const courseLabels = topCourses.map(([_, data]) => data.name);
            const courseDataPassing = topCourses.map(([_, data]) => data.passingGrades);
            const courseDataFailing = topCourses.map(([_, data]) => data.fGrades);
            
            // Update course chart
            if (courseChart) {
                courseChart.data.labels = courseLabels;
                courseChart.data.datasets[0].data = courseDataPassing;
                courseChart.data.datasets[1].data = courseDataFailing;
                courseChart.update();
            }
            
            // Update grade distribution chart
            const gradeCounts = {
                'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0, 'F': 0
            };
            
            filteredGrades.forEach(grade => {
                if (gradeCounts.hasOwnProperty(grade.grade)) {
                    gradeCounts[grade.grade]++;
                }
            });
            
            if (gradeDistributionChart) {
                gradeDistributionChart.data.datasets[0].data = Object.values(gradeCounts);
                gradeDistributionChart.update();
            }
        }
        
        // Update dashboard widgets with filtered data
        function updateDashboardWidgetsWithFilteredData(filteredGrades) {
            try {
                // Calculate stats from filtered data
                const totalFGrades = filteredGrades.filter(g => g.grade === 'F').length;
                const totalGrades = filteredGrades.length;
                const passingGrades = filteredGrades.filter(g => g.grade !== 'F').length;
                const passRate = totalGrades > 0 ? ((passingGrades / totalGrades) * 100).toFixed(1) : 0;
                
                // Calculate average grade
                const gradeValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, 'F': 0 };
                const totalGradeValue = filteredGrades.reduce((sum, grade) => sum + (gradeValues[grade.grade] || 0), 0);
                const averageGrade = totalGrades > 0 ? (totalGradeValue / totalGrades).toFixed(1) : 0;
                
                // Find students with F grades
                const studentsWithF = new Set(filteredGrades.filter(g => g.grade === 'F').map(g => g.student_id)).size;
                
                // Update widgets
                document.getElementById('total-f-count').textContent = totalFGrades;
                document.getElementById('students-with-f').textContent = studentsWithF;
                document.getElementById('pass-rate').textContent = `${passRate}%`;
                document.getElementById('average-grade').textContent = averageGrade;
                
                // Update trend indicators
                const fTrendElement = document.getElementById('f-warnings-trend');
                if (fTrendElement) {
                    if (totalFGrades > 10) {
                        fTrendElement.innerHTML = '<i class="fas fa-arrow-up text-red-500 mr-1"></i>H√∂g niv√•';
                        fTrendElement.className = 'text-xs text-red-500 mt-1';
                    } else if (totalFGrades > 5) {
                        fTrendElement.innerHTML = '<i class="fas fa-arrow-right text-yellow-500 mr-1"></i>Medel niv√•';
                        fTrendElement.className = 'text-xs text-yellow-500 mt-1';
                    } else {
                        fTrendElement.innerHTML = '<i class="fas fa-arrow-down text-green-500 mr-1"></i>L√•g niv√•';
                        fTrendElement.className = 'text-xs text-green-500 mt-1';
                    }
                }
                
            } catch (error) {
                console.error('Error updating dashboard widgets with filtered data:', error);
            }
        }
        
        // Form validation system
        class FormValidator {
            constructor() {
                this.rules = {};
                this.messages = {
                    required: 'Detta f√§lt √§r obligatoriskt',
                    email: 'Ange en giltig e-postadress',
                    minLength: 'Minst {min} tecken kr√§vs',
                    maxLength: 'H√∂gst {max} tecken till√•tet',
                    pattern: 'Ogiltigt format',
                    numeric: 'Endast siffror till√•tet',
                    unique: 'Detta v√§rde finns redan'
                };
            }
            
            addRule(fieldId, rules) {
                this.rules[fieldId] = rules;
                this.attachValidation(fieldId);
            }
            
            attachValidation(fieldId) {
                const field = document.getElementById(fieldId);
                if (!field) return;
                
                const wrapper = this.wrapField(field);
                
                // Real-time validation on input/blur
                field.addEventListener('input', () => this.validateField(fieldId, false));
                field.addEventListener('blur', () => this.validateField(fieldId, true));
            }
            
            wrapField(field) {
                if (field.parentElement.classList.contains('form-field')) {
                    return field.parentElement;
                }
                
                const wrapper = document.createElement('div');
                wrapper.className = 'form-field';
                field.parentNode.insertBefore(wrapper, field);
                wrapper.appendChild(field);
                
                return wrapper;
            }
            
            validateField(fieldId, showSuccess = false) {
                const field = document.getElementById(fieldId);
                const wrapper = field.closest('.form-field');
                const rules = this.rules[fieldId];
                
                if (!field || !wrapper || !rules) return true;
                
                const value = field.value.trim();
                let isValid = true;
                let errorMessage = '';
                
                // Clear previous states
                wrapper.classList.remove('has-error', 'has-success');
                this.clearFieldMessages(wrapper);
                
                // Required validation
                if (rules.required && !value) {
                    isValid = false;
                    errorMessage = this.messages.required;
                }
                
                // Email validation
                if (isValid && rules.email && value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = this.messages.email;
                    }
                }
                
                // Length validation
                if (isValid && value) {
                    if (rules.minLength && value.length < rules.minLength) {
                        isValid = false;
                        errorMessage = this.messages.minLength.replace('{min}', rules.minLength);
                    }
                    
                    if (rules.maxLength && value.length > rules.maxLength) {
                        isValid = false;
                        errorMessage = this.messages.maxLength.replace('{max}', rules.maxLength);
                    }
                }
                
                // Pattern validation
                if (isValid && rules.pattern && value) {
                    if (!rules.pattern.test(value)) {
                        isValid = false;
                        errorMessage = rules.patternMessage || this.messages.pattern;
                    }
                }
                
                // Custom validation
                if (isValid && rules.custom && value) {
                    const customResult = rules.custom(value);
                    if (customResult !== true) {
                        isValid = false;
                        errorMessage = customResult;
                    }
                }
                
                // Update UI
                if (!isValid) {
                    wrapper.classList.add('has-error');
                    this.showFieldError(wrapper, errorMessage);
                } else if (showSuccess && value) {
                    wrapper.classList.add('has-success');
                    this.showFieldSuccess(wrapper, 'Ser bra ut!');
                }
                
                return isValid;
            }
            
            showFieldError(wrapper, message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
                wrapper.appendChild(errorDiv);
            }
            
            showFieldSuccess(wrapper, message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'field-success';
                successDiv.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
                wrapper.appendChild(successDiv);
            }
            
            clearFieldMessages(wrapper) {
                const messages = wrapper.querySelectorAll('.field-error, .field-success');
                messages.forEach(msg => msg.remove());
            }
            
            validateForm(formId) {
                const form = document.getElementById(formId);
                if (!form) return false;
                
                const fields = form.querySelectorAll('input, select, textarea');
                let isValid = true;
                
                fields.forEach(field => {
                    if (this.rules[field.id]) {
                        const fieldValid = this.validateField(field.id, true);
                        if (!fieldValid) {
                            isValid = false;
                        }
                    }
                });
                
                return isValid;
            }
        }
        
        // Initialize form validator
        const formValidator = new FormValidator();
        
        // Keyboard shortcuts system
        class KeyboardShortcuts {
            constructor() {
                this.shortcuts = {};
                this.init();
            }
            
            init() {
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.registerDefaultShortcuts();
                this.showShortcutsHelp();
            }
            
            register(key, callback, description, requireCtrl = true) {
                const shortcutKey = requireCtrl ? `ctrl+${key}` : key;
                this.shortcuts[shortcutKey] = {
                    callback,
                    description,
                    requireCtrl
                };
            }
            
            handleKeydown(e) {
                // Don't trigger shortcuts when typing in inputs
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                    return;
                }
                
                const key = e.key.toLowerCase();
                const shortcutKey = e.ctrlKey ? `ctrl+${key}` : key;
                
                if (this.shortcuts[shortcutKey]) {
                    e.preventDefault();
                    this.shortcuts[shortcutKey].callback();
                }
            }
            
            registerDefaultShortcuts() {
                // Tab navigation
                this.register('1', () => setActiveTab('warnings-tab'), 'G√• till F-varningar');
                this.register('2', () => setActiveTab('progress-tab'), 'G√• till Elevutveckling');
                this.register('3', () => setActiveTab('classes-tab'), 'G√• till Klasser');
                this.register('4', () => setActiveTab('courses-tab'), 'G√• till Kurser');
                this.register('5', () => setActiveTab('students-tab'), 'G√• till Elever');
                this.register('6', () => setActiveTab('grades-tab'), 'G√• till Betygs√§ttning');
                this.register('7', () => setActiveTab('quarters-tab'), 'G√• till Kvartal');
                this.register('8', () => setActiveTab('archive-tab'), 'G√• till Arkiv');
                
                // Actions
                this.register('r', () => location.reload(), 'Uppdatera sidan');
                this.register('e', () => document.getElementById('export-warnings-btn')?.click(), 'Exportera data');
                this.register('f', () => {
                    const searchField = document.getElementById('student-search');
                    if (searchField) {
                        searchField.focus();
                        searchField.select();
                    }
                }, 'Fokusera s√∂kf√§lt');
                
                // Help
                this.register('h', () => this.toggleShortcutsModal(), 'Visa/d√∂lj genv√§gar', false);
                
                // ESC to close modals
                this.register('escape', () => this.closeModals(), 'St√§ng modaler', false);
            }
            
            showShortcutsHelp() {
                // Tangentbordsknappen √§r borttagen - st√∂r anv√§ndare
                // Genv√§gar fungerar fortfarande (tryck H f√∂r att se dem)
            }
            
            toggleShortcutsModal() {
                let modal = document.getElementById('shortcuts-modal');
                
                if (!modal) {
                    modal = this.createShortcutsModal();
                    document.body.appendChild(modal);
                }
                
                modal.classList.toggle('hidden');
            }
            
            createShortcutsModal() {
                const modal = document.createElement('div');
                modal.id = 'shortcuts-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                
                const shortcuts = Object.entries(this.shortcuts)
                    .map(([key, data]) => {
                        const displayKey = key.replace('ctrl+', 'Ctrl + ').toUpperCase();
                        return `
                            <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                <span>${data.description}</span>
                                <kbd class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-sm font-mono">${displayKey}</kbd>
                            </div>
                        `;
                    }).join('');
                
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Tangentbordsgenv√§gar</h3>
                                <button onclick="this.closest('.fixed').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="space-y-1">
                                ${shortcuts}
                            </div>
                            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                                <p><i class="fas fa-info-circle mr-2"></i>Genv√§gar fungerar inte n√§r du skriver i f√§lt</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
                
                return modal;
            }
            
            closeModals() {
                // Close all modals
                document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
                
                // Close dropdown menus
                document.querySelectorAll('.absolute:not(.hidden)').forEach(menu => {
                    if (menu.id && menu.id.includes('menu')) {
                        menu.classList.add('hidden');
                    }
                });
            }
        }
        
        // Initialize keyboard shortcuts
        const keyboardShortcuts = new KeyboardShortcuts();
        
        // Function to re-enable all controls after permission override
        function reEnableAllControls() {
            console.log('Re-enabling all controls for admin override...');
            
            // Re-enable grade pills
            document.querySelectorAll('.grade-pill').forEach(pill => {
                pill.classList.remove('opacity-50', 'cursor-not-allowed');
                pill.disabled = false;
            });
            
            // Re-enable add buttons
            document.querySelectorAll('.add-btn, #add-quarter-btn, #add-class-btn, #add-course-btn, #add-student-btn').forEach(btn => {
                btn.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
            });
            

            
            // Re-add event listeners for grade buttons
            document.querySelectorAll('.grade-pill').forEach(button => {
                // Remove existing listeners by cloning the element
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Add new event listener
                newButton.addEventListener('click', async () => {
                    const studentId = newButton.dataset.studentId;
                    const grade = newButton.dataset.grade;
                    
                    if (!studentId || !grade) return;
                    
                    try {
                        console.log(`Setting grade ${grade} for student ${studentId}`);
                        await updateGrade(studentId, grade);
                        showSuccessNotification(`Betyg ${grade} har satts!`);
                    } catch (error) {
                        handleError(error, 'Betygs√§ttning');
                    }
                });
            });
            
            console.log('All controls re-enabled successfully');
        }
        
        // Function to ensure grade dropdowns are properly populated
        async function renderGradeDropdowns() {
            console.log('Rendering grade dropdowns...');
            
            // Ensure all necessary data is loaded
            if (classes.length === 0) {
                console.log('Loading classes for grading...');
                await fetchClasses();
            }
            
            if (courses.length === 0) {
                console.log('Loading courses for grading...');
                await fetchCourses();
            }
            
            if (classCourseMappings.length === 0) {
                console.log('Loading class course mappings for grading...');
                await fetchClassCourseMappings();
            }
            
            // Update class dropdown
            const gradeClassDropdown = document.getElementById('grade-class');
            if (gradeClassDropdown && classes.length > 0) {
                gradeClassDropdown.innerHTML = '<option value="">V√§lj klass</option>';
                classes.forEach(classObj => {
                    const option = document.createElement('option');
                    option.value = classObj.id;
                    option.textContent = classObj.name;
                    gradeClassDropdown.appendChild(option);
                });
                console.log('Grade class dropdown populated with', classes.length, 'classes');
            }
            
            // Reset course dropdown
            const gradeCourseDropdown = document.getElementById('grade-course');
            if (gradeCourseDropdown) {
                gradeCourseDropdown.innerHTML = '<option value="">V√§lj kurs</option>';
                gradeCourseDropdown.disabled = true;
            }
            
            console.log('Grade dropdowns rendered successfully');
        }
        

        
        // Function to clean duplicate improvement records
        async function cleanDuplicateImprovements() {
            if (!userCan('manage_grades')) {
                showErrorNotification('Du har inte beh√∂righet att rensa dubbletter.');
                return;
            }
            
            try {
                showInfoNotification('Rensar dubbletter i betygsutveckling...');
                
                // Get all grade history records
                const { data: allHistory, error: fetchError } = await supabaseClient
                    .from('grade_history')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (fetchError) throw fetchError;
                
                // Group by student_id + course_id + quarter_id + from_grade
                const grouped = {};
                const duplicatesToDelete = [];
                
                allHistory.forEach(record => {
                    const key = `${record.student_id}_${record.course_id}_${record.quarter_id}_${record.from_grade}`;
                    
                    if (grouped[key]) {
                        // This is a duplicate - mark the older one for deletion
                        duplicatesToDelete.push(grouped[key].id);
                        // Keep the newer one
                        grouped[key] = record;
                    } else {
                        grouped[key] = record;
                    }
                });
                
                if (duplicatesToDelete.length > 0) {
                    console.log(`Found ${duplicatesToDelete.length} duplicate records to delete`);
                    
                    // Delete duplicates
                    const { error: deleteError } = await supabaseClient
                        .from('grade_history')
                        .delete()
                        .in('id', duplicatesToDelete);
                    
                    if (deleteError) throw deleteError;
                    
                    // Refresh grade history data
                    await fetchGradeHistory();
                    await loadProgressData();
                    
                    showSuccessNotification(`${duplicatesToDelete.length} dubbletter har rensats!`);
                } else {
                    showInfoNotification('Inga dubbletter hittades.');
                }
                
            } catch (error) {
                handleError(error, 'Rensning av dubbletter');
            }
        }
        
        // Enhanced dashboard widgets
        function updateDashboardWidgets() {
            try {
                // Calculate basic stats
                const totalFGrades = grades.filter(g => g.grade === 'F').length;
                const totalStudents = students.length;
                const totalClasses = classes.length;
                const totalCourses = courses.length;
                const totalGrades = grades.length;
                
                // Calculate pass rate
                const passingGrades = grades.filter(g => g.grade !== 'F').length;
                const passRate = totalGrades > 0 ? ((passingGrades / totalGrades) * 100).toFixed(1) : 0;
                
                // Calculate average grade (numerical approximation)
                const gradeValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, 'F': 0 };
                const totalGradeValue = grades.reduce((sum, grade) => sum + (gradeValues[grade.grade] || 0), 0);
                const averageGrade = totalGrades > 0 ? (totalGradeValue / totalGrades).toFixed(1) : 0;
                
                // Find students with F grades
                const studentsWithF = new Set(grades.filter(g => g.grade === 'F').map(g => g.student_id)).size;
                
                // Find worst performing course
                const courseFCounts = {};
                grades.filter(g => g.grade === 'F').forEach(grade => {
                    courseFCounts[grade.course_id] = (courseFCounts[grade.course_id] || 0) + 1;
                });
                
                let worstCourseId = null;
                let worstCourseCount = 0;
                Object.entries(courseFCounts).forEach(([courseId, count]) => {
                    if (count > worstCourseCount) {
                        worstCourseId = courseId;
                        worstCourseCount = count;
                    }
                });
                
                // Find worst performing class
                const classFCounts = {};
                grades.filter(g => g.grade === 'F').forEach(grade => {
                    const student = students.find(s => s.id === grade.student_id);
                    if (student && student.class_id) {
                        classFCounts[student.class_id] = (classFCounts[student.class_id] || 0) + 1;
                    }
                });
                
                let worstClassId = null;
                let worstClassCount = 0;
                Object.entries(classFCounts).forEach(([classId, count]) => {
                    if (count > worstClassCount) {
                        worstClassId = classId;
                        worstClassCount = count;
                    }
                });
                
                // Update main widgets
                document.getElementById('total-f-count').textContent = totalFGrades;
                document.getElementById('students-with-f').textContent = studentsWithF;
                
                // Update worst course
                const worstCourse = worstCourseId ? courses.find(c => c.id === worstCourseId) : null;
                document.getElementById('worst-course').textContent = worstCourse ? worstCourse.name : '-';
                document.getElementById('worst-course-count').textContent = worstCourseCount > 0 ? `${worstCourseCount} F-betyg` : '-';
                
                // Update worst class
                const worstClass = worstClassId ? classes.find(c => c.id === worstClassId) : null;
                document.getElementById('worst-class').textContent = worstClass ? worstClass.name : '-';
                document.getElementById('worst-class-count').textContent = worstClassCount > 0 ? `${worstClassCount} F-betyg` : '-';
                
                // Update quick stats
                document.getElementById('pass-rate').textContent = `${passRate}%`;
                document.getElementById('total-classes').textContent = totalClasses;
                document.getElementById('total-courses').textContent = totalCourses;
                document.getElementById('average-grade').textContent = averageGrade;
                
                // Add trend indicators (simplified)
                const fTrendElement = document.getElementById('f-warnings-trend');
                const studentsTrendElement = document.getElementById('students-trend');
                
                if (fTrendElement) {
                    if (totalFGrades > 10) {
                        fTrendElement.innerHTML = '<i class="fas fa-arrow-up text-red-500 mr-1"></i>H√∂g niv√•';
                        fTrendElement.className = 'text-xs text-red-500 mt-1';
                    } else if (totalFGrades > 5) {
                        fTrendElement.innerHTML = '<i class="fas fa-arrow-right text-yellow-500 mr-1"></i>Medel niv√•';
                        fTrendElement.className = 'text-xs text-yellow-500 mt-1';
                    } else {
                        fTrendElement.innerHTML = '<i class="fas fa-arrow-down text-green-500 mr-1"></i>L√•g niv√•';
                        fTrendElement.className = 'text-xs text-green-500 mt-1';
                    }
                }
                
                if (studentsTrendElement) {
                    const fPercentage = totalStudents > 0 ? ((studentsWithF / totalStudents) * 100) : 0;
                    studentsTrendElement.textContent = `${fPercentage.toFixed(1)}% av alla elever`;
                }
                
            } catch (error) {
                console.error('Error updating dashboard widgets:', error);
            }
        }
        
        // Add validation rules for common forms
        formValidator.addRule('email', {
            required: true,
            email: true
        });
        
        formValidator.addRule('password', {
            required: true,
            minLength: 6
        });
        
        formValidator.addRule('quarter-name', {
            required: true,
            minLength: 2,
            maxLength: 50,
            custom: (value) => {
                // Check if quarter name already exists
                const exists = quarters.some(q => q.name.toLowerCase() === value.toLowerCase());
                return exists ? 'Ett kvartal med detta namn finns redan' : true;
            }
        });
        
        formValidator.addRule('class-name', {
            required: true,
            minLength: 2,
            maxLength: 20,
            pattern: /^[A-Za-z0-9\s-]+$/,
            patternMessage: 'Endast bokst√§ver, siffror, mellanslag och bindestreck till√•tet'
        });
        
        formValidator.addRule('course-code', {
            required: true,
            minLength: 6,
            maxLength: 10,
            pattern: /^[A-Za-z]{6}[0-9]{2}$/,
            patternMessage: 'Kurskod ska vara 6 bokst√§ver f√∂ljt av 2 siffror (t.ex. MATMAT01)'
        });
        
        formValidator.addRule('course-name', {
            required: true,
            minLength: 3,
            maxLength: 100
        });
        
        // Course students modal event listeners
        document.getElementById('close-course-modal-btn').addEventListener('click', () => {
            document.getElementById('course-students-modal').classList.add('hidden');
        });
        
        document.getElementById('modal-course-close-btn').addEventListener('click', () => {
            document.getElementById('course-students-modal').classList.add('hidden');
        });
        
        document.getElementById('export-course-students-pdf').addEventListener('click', () => {
            exportCourseStudentsToPDF();
        });
        
        // Close modal when clicking outside
        document.getElementById('course-students-modal').addEventListener('click', (e) => {
            if (e.target.id === 'course-students-modal') {
                document.getElementById('course-students-modal').classList.add('hidden');
            }
        });
        
        // Student filtering event listeners
        function setupStudentFilters() {
            // Status filters (Kritisk, Varning, √Ötg√§rd)
            document.querySelectorAll('.student-status-filter').forEach(filter => {
                filter.addEventListener('change', () => {
                    loadWarningsData();
                });
            });
            
            // Type filters (F-betyg, F-varningar, B√•da)
            document.querySelectorAll('.student-type-filter').forEach(filter => {
                filter.addEventListener('change', () => {
                    loadWarningsData();
                });
            });
            
            // Sorting dropdown
            const studentSortSelect = document.getElementById('student-sort-by');
            if (studentSortSelect) {
                studentSortSelect.addEventListener('change', () => {
                    loadWarningsData();
                });
            }
            
            // Reset filters button
            const resetStudentFiltersBtn = document.getElementById('reset-student-filters-btn');
            if (resetStudentFiltersBtn) {
                resetStudentFiltersBtn.addEventListener('click', () => {
                    // Reset all status filters
                    document.querySelectorAll('.student-status-filter').forEach(cb => cb.checked = true);
                    
                    // Reset all type filters
                    document.querySelectorAll('.student-type-filter').forEach(cb => cb.checked = true);
                    
                    // Reset sorting
                    if (studentSortSelect) studentSortSelect.value = 'total_desc';
                    
                    // Re-render
                    loadWarningsData();
                    
                    showInfoNotification('Elevfilter √•terst√§llda');
                });
            }
        }
        
        // Call setup after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setupStudentFilters();
        });
        
        // Initialize
        checkSession();
    </script>
</body>
</html>